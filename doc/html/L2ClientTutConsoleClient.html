<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>.NET Based OPC UA Client/Server/PubSub SDK: Console Client</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="header_inner_inner_bg2.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">.NET Based OPC UA Client/Server/PubSub SDK
   &#160;<span id="projectnumber">4.1.0.556</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('L2ClientTutConsoleClient.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Events</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Console Client </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#L2ClientTutConsoleClient_Overview">Overview</a></li>
<li class="level1"><a href="#L2ClientTutConsoleClient_Connection">Connection</a><ul><li class="level2"><a href="#L2ClientTutConsoleClient_Connection_Identity">Setting UserIdentity</a></li>
<li class="level2"><a href="#L2ClientTutConsoleClient_Connection_SimpleConnect">Simple Connect</a></li>
<li class="level2"><a href="#L2ClientTutConsoleClient_Connection_Discovery">Discovery</a></li>
<li class="level2"><a href="#L2ClientTutConsoleClient_Connection_ReverseConnect">Reverse Connect</a></li>
<li class="level2"><a href="#L2ClientTutConsoleClient_Connection_Security">Security</a><ul><li class="level3"><a href="#L2ClientTutConsoleClient_Connection_Security_Provider">Set SecurityProvider</a></li>
<li class="level3"><a href="#L2ClientTutConsoleClient_Connection_Security_TrustCertificates">Trust Certificates</a></li>
<li class="level3"><a href="#L2ClientTutConsoleClient_Connection_Security_GDS">GDS Configuration</a></li>
</ul>
</li>
<li class="level2"><a href="#L2ClientTutConsoleClient_Connection_ChangeUser">Change user</a></li>
<li class="level2"><a href="#L2ClientTutConsoleClient_Connection_ChangePassword">Change password</a></li>
<li class="level2"><a href="#L2ClientTutConsoleClient_Connection_MapNamespaces">Mapping namespaces</a></li>
</ul>
</li>
<li class="level1"><a href="#L2ClientTutConsoleClient_Session">Session services</a><ul><li class="level2"><a href="#L2ClientTutConsoleClient_Session_Read">Read</a><ul><li class="level3"><a href="#L2ClientTutConsoleClient_Session_ReadValue">Read Values</a></li>
<li class="level3"><a href="#L2ClientTutConsoleClient_Session_ReadIndex">Read an Array with Index</a></li>
</ul>
</li>
<li class="level2"><a href="#L2ClientTutConsoleClient_Session_Write">Write</a><ul><li class="level3"><a href="#L2ClientTutConsoleClient_Session_WriteValue">Write Values</a></li>
<li class="level3"><a href="#L2ClientTutConsoleClient_Session_WriteIndex">Write an Array with Index</a></li>
<li class="level3"><a href="#L2ClientTutConsoleClient_Session_WriteStruct">Write a Structure</a></li>
</ul>
</li>
<li class="level2"><a href="#L2ClientTutConsoleClient_Session_Browse">Browse</a></li>
<li class="level2"><a href="#L2ClientTutConsoleClient_Session_TranslateBrowsePath">TranslateBrowsePathsToNodeIds</a></li>
<li class="level2"><a href="#L2ClientTutConsoleClient_Session_CallMethod">Call Methods</a></li>
<li class="level2"><a href="#L2ClientTutConsoleClient_Session_RegisterNodes">RegisterNodes</a></li>
<li class="level2"><a href="#L2ClientTutConsoleClient_Session_HistoryRead">Access Historical Data</a><ul><li class="level3"><a href="#L2ClientTutConsoleClient_Session__HistoryRead_Raw">Read Raw Data</a></li>
<li class="level3"><a href="#L2ClientTutConsoleClient_Session__HistoryRead_Update">Update Historical Data</a></li>
</ul>
</li>
<li class="level2"><a href="#L2ClientTutConsoleClient_Session_HistoryEvent">Access Historical Events</a><ul><li class="level3"><a href="#L2ClientTutConsoleClient_Session__HistoryEvent_Read">Read Historical Events</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#L2ClientTutConsoleClient_Subscription">Subscription services</a><ul><li class="level2"><a href="#L2ClientTutConsoleClient_Subscription_Create">Create Subscription</a></li>
<li class="level2"><a href="#L2ClientTutConsoleClient_Subscription_CreateDataMonitoredItems">Create DataMonitoredItems</a></li>
<li class="level2"><a href="#L2ClientTutConsoleClient_Subscription_CreateEventMonitoredItems">Create EventMonitoredItems</a></li>
<li class="level2"><a href="#L2ClientTutConsoleClient_Subscription_SubscribeAlarm">Subscribe Alarm</a></li>
<li class="level2"><a href="#L2ClientTutConsoleClient_Subscription_AcknowlegdeAlarms">Acknowledge Alarms</a></li>
<li class="level2"><a href="#L2ClientTutConsoleClient_Subscription_TransferSubscriptions">Transfer Subscriptions</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="L2ClientTutConsoleClient_Overview"></a>
Overview</h1>
<p>The Console Client is an extended example developed using the Unified Automation OPC UA Client SDK .NET showing several features of OPC UA.</p>
<p>This client is a console application that runs for all of our provided Frameworks (.NET Framework, .NET Core, .NET). The application is working with the DemoServers of <a class="el" href="namespaceUnifiedAutomation.html">UnifiedAutomation</a>. You can edit a configuration file to be able to work with other servers.</p>
<p>The client shows a menu. By pressing a key an action will be triggered.</p>
<h1><a class="anchor" id="L2ClientTutConsoleClient_Connection"></a>
Connection</h1>
<p>The connection menu is the entry point of the client. Here you can trigger some actions that need to be done before a connection is established and you can connect to the configured server.</p>
<h2><a class="anchor" id="L2ClientTutConsoleClient_Connection_Identity"></a>
Setting UserIdentity</h2>
<p>With "set user to Anonymous" and "set username and password" you can set the identity token for the session. The identity must be set before <code>Session.Connect</code> is called. By default, the <code>UserIdentity</code> is <code>null</code>. In this case an anonymous user identity will be used to connect to the server. By selecting "set username and password", the username and password combination from the configuration file is used.</p>
<div class="fragment"><div class="line">            <span class="keywordflow">if</span> (Session.UserIdentity == null)</div>
<div class="line">            {</div>
<div class="line">                Session.UserIdentity = <span class="keyword">new</span> UserIdentity();</div>
<div class="line">            }</div>
<div class="line">            Session.UserIdentity.IdentityType = <a class="code" href="namespaceUnifiedAutomation_1_1UaClient.html#ac98fcaa9c6e172d22185f10c51d9a377">UserIdentityType</a>.UserName;</div>
<div class="line">            Session.UserIdentity.UserName = Settings.Connection.UserName;</div>
<div class="line">            Session.UserIdentity.Password = Settings.Connection.Password;</div>
</div><!-- fragment --> <h2><a class="anchor" id="L2ClientTutConsoleClient_Connection_SimpleConnect"></a>
Simple Connect</h2>
<p>An option to connect to a server is to call <code>Session.Connect(string discoveryUrl, SecuritySelection securitySelection)</code>. This method implicitly calls several OPC UA services. You can specify with the <code>securitySelection</code> parameter if you want to connect to the endpoint with the SecurityPolicy <code><a href="http://opcfoundation.org/UA/SecurityPolicy#None">http://opcfoundation.org/UA/SecurityPolicy#None</a></code> or to the endpoint with the best possible SecurityPolicy. The Client SDK makes sure that only endpoints with supported security policies get chosen. If you try to connect with a SecurityPolicy, while no endpoint with the selected policy exists on the server, an exception is thrown by the SDK.</p>
<div class="fragment"><div class="line">                Session.Connect(Settings.Connection.DiscoveryUrl, security ? <a class="code" href="group__GroupNet__UaClientLibraryHelper.html#ga98100b962ed7252c384b7759085977f6">SecuritySelection</a>.BestAvailable : <a class="code" href="group__GroupNet__UaClientLibraryHelper.html#ga98100b962ed7252c384b7759085977f6">SecuritySelection</a>.None);</div>
</div><!-- fragment --> <h2><a class="anchor" id="L2ClientTutConsoleClient_Connection_Discovery"></a>
Discovery</h2>
<p>A second option to connect to a server is to use the Discovery class to get the available endpoints of a server. Afterwards, one of these endpoints is selected to call <code>Session.Connect</code>.</p>
<div class="fragment"><div class="line">                <span class="keyword">using</span> (Discovery discovery = <span class="keyword">new</span> Discovery(Application))</div>
<div class="line">                {</div>
<div class="line">                    Endpoints = discovery.GetEndpoints(discoveryUrl);</div>
<div class="line">                    Output(<span class="stringliteral">&quot;\nGetEndpoints succeeded&quot;</span>);</div>
<div class="line">                }</div>
</div><!-- fragment --> <div class="fragment"><div class="line">                Session.Connect(SelectedEndpoint, ValidateEndpoints, Endpoints, null);</div>
</div><!-- fragment --><p> The Server returns its EndpointDescriptions in the response of CreateSession. Clients use this information to determine whether the list of EndpointDescriptions returned from the DiscoveryEndpoint matches the Endpoints that the Server has. If there is a difference then the Client shall close the Session and report an error. The ValidateEndpoints delegate can be used to check if the Endpoints are valid.</p>
<p>The simplest way for validation is to compare the endpoint descriptions returned by GetEndpoints and returned by CreateSession.</p>
<p>A Client may skip this check if the EndpointDescriptions were provided by a trusted source such as the Administrator. In this case the connect method <code>Session.Connect(EndpointDescription endpoint, RetryInitialConnect retryInitialConnect, RequestSettings settings)</code> can be used.</p>
<div class="fragment"><div class="line">        <span class="keywordtype">bool</span> ValidateEndpoints(EndpointDescriptionCollection endpointsFromCreateSession, IList&lt;EndpointDescription&gt; endpointsFromGetEndpoints)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> endpointsFromCreateSession.IsEquivalentTo(endpointsFromGetEndpoints);</div>
<div class="line">        }</div>
</div><!-- fragment --><p> The <code>GetEndpoints</code> method call might return endpoints with a security policy that is not supported by the client. So, before selecting the endpoint the application should check if the CryptoProvider supports the security policy.</p>
<div class="fragment"><div class="line">                    <span class="keywordtype">string</span> unsupported;</div>
<div class="line">                    <span class="keywordflow">try</span></div>
<div class="line">                    {</div>
<div class="line">                        <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a96d16e9a0ffe0e31ca0315c51a54adcfae498749f3c42246d50b15c81c101d988">Application</a>.SecurityProvider.CreateCryptoProvider(</div>
<div class="line">                            <span class="keyword">new</span> CryptoProviderSettings()</div>
<div class="line">                            {</div>
<div class="line">                                SecurityProfileUri = Endpoints[i].SecurityPolicyUri</div>
<div class="line">                            });</div>
<div class="line">                        unsupported = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"></div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">catch</span> (Exception)</div>
<div class="line">                    {</div>
<div class="line">                        unsupported = <span class="stringliteral">&quot; [Not supported by CryptoProvider]&quot;</span>;</div>
<div class="line">                    }</div>
</div><!-- fragment --> <h2><a class="anchor" id="L2ClientTutConsoleClient_Connection_ReverseConnect"></a>
Reverse Connect</h2>
<p>Another option to connect to a server is to let the server do the initial connection establishment by a Reverse Connect. This is useful if the server is behind a firewall and no port can be opened. In this case, the server has to be configured for Reverse Connect, too. On the client, the session has to be created differently, containing the <code>clientListeningUrl</code>. </p><div class="fragment"><div class="line">                        <span class="keywordflow">try</span></div>
<div class="line">                        {</div>
<div class="line">                            m_session = <span class="keyword">new</span> Session(Application, Settings.Connection.ClientUrlForReverseConnect);</div>
<div class="line">                        }</div>
<div class="line">                        <span class="keywordflow">catch</span> (<a class="code" href="namespaceSystem.html">System</a>.<a class="code" href="namespaceSystem_1_1Net.html">Net</a>.<a class="code" href="namespaceSystem_1_1Net_1_1Sockets.html">Sockets</a>.SocketException se)</div>
<div class="line">                        {</div>
<div class="line">                            LogException(se, <span class="stringliteral">&quot;\nCreating Session failed&quot;</span>);</div>
<div class="line">                            Output($<span class="stringliteral">&quot;Check if other application binds the port {Settings.Connection.ClientUrlForReverseConnect}&quot;</span>);</div>
<div class="line">                            <span class="keywordflow">throw</span>;</div>
<div class="line">                        }</div>
</div><!-- fragment --><p>The connect itself is equal to the Simple Connect </p><div class="fragment"><div class="line">                Session.ReverseConnect(Settings.Connection.DiscoveryUrl, <a class="code" href="group__GroupNet__UaClientLibraryHelper.html#ga98100b962ed7252c384b7759085977f6">SecuritySelection</a>.None);</div>
</div><!-- fragment --> <h2><a class="anchor" id="L2ClientTutConsoleClient_Connection_Security"></a>
Security</h2>
<h3><a class="anchor" id="L2ClientTutConsoleClient_Connection_Security_Provider"></a>
Set SecurityProvider</h3>
<p>To be able to create or manage the own application instance certificate, a SecurityProvider must be set to the <a class="el" href="classUnifiedAutomation_1_1UaBase_1_1ApplicationInstanceBase.html">ApplicationInstanceBase</a>. The SDK includes two implementations of <a class="el" href="interfaceUnifiedAutomation_1_1UaBase_1_1ISecurityProvider.html">ISecurityProvider</a> interface which support creating certificates. There is the <a class="el" href="classUnifiedAutomation_1_1UaBase_1_1BouncyCastleSecurityProvider.html">BouncyCastleSecurityProvider</a> which is implemented in the package <code>UaBase.BouncyCastle</code>. And there is the <a class="el" href="classUnifiedAutomation_1_1UaBase_1_1WindowsSecurityProvider.html">WindowsSecurityProvider</a> which is implemented in the package <code>UaBase.Windows</code>. The <code>WindowsSecurityProvider</code> is only available for applications that run in a Windows environment. The class <a class="el" href="classUnifiedAutomation_1_1UaBase_1_1ApplicationInstance.html">ApplicationInstance</a> implemented in the package <code>Uabase.Windows</code> sets the <code>WindowsSecurityProvider</code> implicitly.</p>
<p>In this example the SecurityProvider is set depending on the used framework. Since the same source code files are used, the distinction is done with a compilation symbol.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#if NETFRAMEWORK || WINDOWS</span></div>
<div class="line">                var securityProvider = <span class="keyword">new</span> WindowsSecurityProvider();</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">                var securityProvider = <span class="keyword">new</span> BouncyCastleSecurityProvider();</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">                ApplicationInstanceBase.Default.SecurityProvider = securityProvider;</div>
</div><!-- fragment --> <h3><a class="anchor" id="L2ClientTutConsoleClient_Connection_Security_TrustCertificates"></a>
Trust Certificates</h3>
<p>To establish a connection with security the client and the server application have to trust the certificate of the other application. The event handler <code>ApplicationInstanceBase.UntrustedCertificate</code> is called if a certificate is received that is not trusted yet.</p>
<p>If the property <code>UntrustedCertificateEventArgs.Accept</code> is set to <code>true</code> within the event handler, the certificate will be accepted. If the property <code>UntrustedCertificateEventArgs.Persist</code> is set to <code>true</code> within the event handler, the certificate will be stored in the offline trustlist, i.e., after a restart of the application the certificate is still trusted.</p>
<p>In this example, there is a user interaction to accept or reject the certificate.</p>
<p>The application blocks until the event handler returns.</p>
<div class="fragment"><div class="line">                ApplicationInstanceBase.Default.UntrustedCertificate += <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#aa7e1c3f589ad954cd627ceedf429b772">UntrustedCertificateEventHandler</a>(Application_UntrustedCertificate);</div>
</div><!-- fragment --> <div class="fragment"><div class="line">        <span class="keyword">static</span> <span class="keywordtype">void</span> Application_UntrustedCertificate(<span class="keywordtype">object</span> sender, UntrustedCertificateEventArgs e)</div>
<div class="line">        {</div>
<div class="line">            List&lt;StatusCode&gt; validationErrors = e.ValidationError.Flattened;</div>
<div class="line"></div>
<div class="line">            Console.WriteLine(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">            Console.WriteLine(<span class="stringliteral">&quot;-------------------------------------------------------&quot;</span>);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (validationErrors.Count == 1)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> (e.ValidationError == StatusCodes.BadCertificateUntrusted)</div>
<div class="line">                {</div>
<div class="line">                    Console.WriteLine($<span class="stringliteral">&quot; - Untrusted certificate: {e.Certificate}&quot;</span>);</div>
<div class="line">                    Console.WriteLine(<span class="stringliteral">&quot;-------------------------------------------------------&quot;</span>);</div>
<div class="line">                    Console.WriteLine(<span class="stringliteral">&quot; - Press 0 to accept the certificate                  -&quot;</span>);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    Console.WriteLine($<span class="stringliteral">&quot; - Validation error in certificate: {e.ValidationError}, {e.Certificate}&quot;</span>);</div>
<div class="line">                    Console.WriteLine(<span class="stringliteral">&quot;-------------------------------------------------------&quot;</span>);</div>
<div class="line">                    Console.WriteLine(<span class="stringliteral">&quot; - Press 0 to accept the validation error             -&quot;</span>);</div>
<div class="line">                }</div>
<div class="line">                Console.WriteLine(<span class="stringliteral">&quot; - Press other key to reject the certificate          -&quot;</span>);</div>
<div class="line"></div>
<div class="line">                ConsoleKeyInfo key = Console.ReadKey();</div>
<div class="line">                <span class="keywordflow">switch</span> (key.Key)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">case</span> ConsoleKey.D0:</div>
<div class="line">                    <span class="keywordflow">case</span> ConsoleKey.NumPad0:</div>
<div class="line">                        e.Accept = <span class="keyword">true</span>;</div>
<div class="line">                        e.Persist = <span class="keyword">true</span>;</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    <span class="keywordflow">default</span>:</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> (e.ValidationError == StatusCodes.BadCertificateUntrusted)</div>
<div class="line">                {</div>
<div class="line">                    Console.WriteLine($<span class="stringliteral">&quot; - Untrusted certificate: {e.Certificate}&quot;</span>);</div>
<div class="line">                    Console.WriteLine(<span class="stringliteral">&quot;-------------------------------------------------------&quot;</span>);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    Console.WriteLine($<span class="stringliteral">&quot; - Validation error in certificate: {e.ValidationError}, {e.Certificate}&quot;</span>);</div>
<div class="line">                    Console.WriteLine(<span class="stringliteral">&quot;-------------------------------------------------------&quot;</span>);</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                Console.WriteLine(<span class="stringliteral">&quot; - Further validation errors:&quot;</span>);</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii = 1; ii &lt; validationErrors.Count; ii++)</div>
<div class="line">                {</div>
<div class="line">                    Console.WriteLine($<span class="stringliteral">&quot; -   {validationErrors[ii]}&quot;</span>);</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (e.ValidationError == StatusCodes.BadCertificateUntrusted)</div>
<div class="line">                {</div>
<div class="line">                    Console.WriteLine(<span class="stringliteral">&quot; - Press 0 to trust the certificate                   -&quot;</span>);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    Console.WriteLine(<span class="stringliteral">&quot; - Press 0 to accept this validation error             -&quot;</span>);</div>
<div class="line">                }</div>
<div class="line">                Console.WriteLine(<span class="stringliteral">&quot; - Press 1 to accept all validation errors            -&quot;</span>);</div>
<div class="line">                Console.WriteLine(<span class="stringliteral">&quot; - Press other key to reject the certificate          -&quot;</span>);</div>
<div class="line"></div>
<div class="line">                ConsoleKeyInfo key = Console.ReadKey();</div>
<div class="line">                <span class="keywordflow">switch</span> (key.Key)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">case</span> ConsoleKey.D0:</div>
<div class="line">                    <span class="keywordflow">case</span> ConsoleKey.NumPad0:</div>
<div class="line">                        e.Accept = <span class="keyword">true</span>;</div>
<div class="line">                        e.Persist = <span class="keyword">true</span>;</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    <span class="keywordflow">case</span> ConsoleKey.D1:</div>
<div class="line">                    <span class="keywordflow">case</span> ConsoleKey.NumPad1:</div>
<div class="line">                        e.AcceptAll = <span class="keyword">true</span>;</div>
<div class="line">                        e.Persist = <span class="keyword">true</span>;</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    <span class="keywordflow">default</span>:</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
</div><!-- fragment --> <h3><a class="anchor" id="L2ClientTutConsoleClient_Connection_Security_GDS"></a>
GDS Configuration</h3>
<p>Instead of trusting the certificates manually the Security Management can be done by a Global Discovery Server (GDS). This tutorial shows the usage of UaGDS (<a href="https://www.unified-automation.com/products/ua-runtime-software/uagds.html">https://www.unified-automation.com/products/ua-runtime-software/uagds.html</a>).</p>
<p>In this example the certificate management by the GDS can be enabled in the configuration.</p>
<div class="fragment"><div class="line">&lt;GdsSettings&gt;</div>
<div class="line">  &lt;UseGdsSecurity&gt;<span class="keyword">true</span>&lt;/UseGdsSecurity&gt;</div>
<div class="line">&lt;/GdsSettings&gt;</div>
</div><!-- fragment --><p>The client application can register itself at the GDS and do the complete GDS handling itself using the class <a class="el" href="classUnifiedAutomation_1_1UaClient_1_1GdsPullManagement.html">GdsPullManagement</a>. An instance of this class shall be set at <a class="el" href="classUnifiedAutomation_1_1UaBase_1_1ApplicationInstanceBase.html#a19fc5178fba9c486352441cada28eced">ApplicationInstanceBase.GdsHandler</a> before the application has been started. Additionally the EndpointUrl of the GDS has to be set in the application settings of the server application.</p>
<div class="fragment"><div class="line">                    var pullManagement = <span class="keyword">new</span> GdsPullManagement(ApplicationInstanceBase.Default);</div>
<div class="line">                    ApplicationInstanceBase.Default.GdsHandler = pullManagement;</div>
</div><!-- fragment --> <div class="fragment"><div class="line">&lt;Extension&gt;</div>
<div class="line">  &lt;GdsSettings xmlns=<span class="stringliteral">&quot;http://unifiedautomation.com/schemas/2011/12/Application.xsd&quot;</span>&gt;</div>
<div class="line">    &lt;GdsDiscoveryUrl&gt;opc.tcp:<span class="comment">//localhost:48060&lt;/GdsDiscoveryUrl&gt;</span></div>
<div class="line">  &lt;/GdsSettings&gt;</div>
<div class="line">&lt;/Extension&gt;</div>
</div><!-- fragment --><p>In this example we are using a different file location for the certificate and the trust list managed by the GDS to be able to switch back to non GDS management.</p>
<div class="fragment"><div class="line">                    ConfigurationInMemory clientConfigurationInMemory = configuration as ConfigurationInMemory;</div>
<div class="line">                    clientConfigurationInMemory.SetSecurity(PlatformUtils.CombinePath(PlatformUtils.IsWindows() ? <span class="stringliteral">&quot;%CommonApplicationData%&quot;</span> : <span class="stringliteral">&quot;%LocalApplicationData%&quot;</span>, <span class="stringliteral">&quot;UnifiedAutomation&quot;</span>, <span class="stringliteral">&quot;UaSdkNet&quot;</span>, gdsFolder), <span class="stringliteral">&quot;CN=ConsoleClient/O=UnifiedAutomation/DC=localhost&quot;</span>);</div>
</div><!-- fragment --><p> After the client has been started for the first time and the application instance certificate of the GDS has been accepted, the client application will be visible in the Pending Lists for applications to register and certificate signing requests in the GDS Configuration Tool. After accepting both, the client will receive a new certificate and trust list.</p>
<div class="image">
<img src="consoleclient_pendinglist.png" alt="consoleclient_pendinglist.png"/>
<div class="caption">
Accept application in pending list for application registration</div></div>
 <div class="image">
<img src="consoleclient_pendinglist2.png" alt="consoleclient_pendinglist2.png"/>
<div class="caption">
Accept application in pending list for certificate signing requests</div></div>
<h2><a class="anchor" id="L2ClientTutConsoleClient_Connection_ChangeUser"></a>
Change user</h2>
<p>OPC UA allows to change the user of a session while the client is connected. In the Client SDK, first the new user credentials need to be provided to the session object. </p><div class="fragment"><div class="line">                    Session.UserIdentity.IdentityType = <a class="code" href="namespaceUnifiedAutomation_1_1UaClient.html#ac98fcaa9c6e172d22185f10c51d9a377">UserIdentityType</a>.UserName;</div>
<div class="line">                    Session.UserIdentity.UserName = Settings.Connection.UserName;</div>
<div class="line">                    Session.UserIdentity.Password = Settings.Connection.Password;</div>
</div><!-- fragment --><p>Afterwards, a simple method needs to be called, which triggers the actual OPC UA service request. </p><div class="fragment"><div class="line">                Session.ChangeUser();</div>
</div><!-- fragment --> <h2><a class="anchor" id="L2ClientTutConsoleClient_Connection_ChangePassword"></a>
Change password</h2>
<p>OPC UA User Management allows authenticated users, with IdentityType.UserName, to change there own password, event without security access rights.<br />
For this case, the Client SDK provides an easy to use method to change the password. This method can be found at the session object. </p><div class="fragment"><div class="line">                Session.ChangePassword(oldPassword, newPassword);</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>This method can only be used with connected and encrypted sessions.</dd></dl>
<h2><a class="anchor" id="L2ClientTutConsoleClient_Connection_MapNamespaces"></a>
Mapping namespaces</h2>
<p>The client has a configuration that defines the NodeIds that the client uses to call the OPC UA services. The NamespaceIndex of the NodeIds cannot be configured directly because it may be different for different servers. So there is also a NamespaceTable configured which entries are referred by the NodeIds in the configuration.</p>
<p>After a connection is established you can access the current NamespaceTable of the server. </p><div class="fragment"><div class="line">                    Settings.CurrentNamespaceTable = Session.NamespaceUris;</div>
</div><!-- fragment --><p>You can use this table to map the indices of the configuration to the indices in the server. This mapping can be done directly after the <code>Connect</code> call has finished.</p>
<div class="fragment"><div class="line">                m_currentMapping = value.CreateMapping(ConfiguredNamespaces, <span class="keyword">false</span>);</div>
</div><!-- fragment --><div class="fragment"><div class="line">        <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> MapNodeId(NodeId nodeId)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (m_currentMapping == null)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception(<span class="stringliteral">&quot;Configuration Error&quot;</span>);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (nodeId.NamespaceIndex &gt; m_currentMapping.Length)</div>
<div class="line">                <span class="keywordflow">return</span> nodeId;</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>(nodeId.IdType, nodeId.Identifier, m_currentMapping[nodeId.NamespaceIndex]);</div>
<div class="line">        }</div>
</div><!-- fragment --><p> In this example the configured namespaces of the configuration must be updated after the NodeIds are mapped. </p><div class="fragment"><div class="line">                ConfiguredNamespaces.Clear();</div>
<div class="line">                NamespaceTable tmp = <span class="keyword">new</span> NamespaceTable();</div>
<div class="line">                List&lt;ushort&gt; usedNamespaces = <span class="keyword">new</span> List&lt;ushort&gt;();</div>
<div class="line">                <span class="keywordflow">foreach</span> (ushort index <span class="keywordflow">in</span> m_currentMapping)</div>
<div class="line">                {</div>
<div class="line">                    usedNamespaces.Add(index);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii = 1; ii &lt; value.Count; ii++)</div>
<div class="line">                {</div>
<div class="line">                    tmp.Add(usedNamespaces.Contains((ushort) ii) ? value[ii] : null);</div>
<div class="line">                }</div>
<div class="line">                ConfiguredNamespaces = tmp;</div>
</div><!-- fragment --><h1><a class="anchor" id="L2ClientTutConsoleClient_Session"></a>
Session services</h1>
<p>Most OPC UA services require a session to the server. The most important ones are described here. All methods that do an OPC UA service request have a synchronous and an asynchronous version in the SDK. In this example the asynchronous methods are only used for few service calls, since synchronous methods are easier to understand. On the other hand, the application will block until the synchronous methods return. Therefore, in real applications often the asynchronous methods should be used.</p>
<h2><a class="anchor" id="L2ClientTutConsoleClient_Session_Read"></a>
Read</h2>
<h3><a class="anchor" id="L2ClientTutConsoleClient_Session_ReadValue"></a>
Read Values</h3>
<p>This example shows how to read the Value attribute of some configured nodes. The <code>Read</code> method uses a list of <a class="el" href="classUnifiedAutomation_1_1UaBase_1_1ReadValueId.html">ReadValueIds</a> as argument. This list is constructed with configured nodes. </p><div class="fragment"><div class="line">            List&lt;ReadValueId&gt; readValueIds = <span class="keyword">new</span> List&lt;ReadValueId&gt;();</div>
<div class="line">            <span class="keywordflow">foreach</span> (NodeId nodeId <span class="keywordflow">in</span> configuredVariables)</div>
<div class="line">            {</div>
<div class="line">                readValueIds.Add(<span class="keyword">new</span> ReadValueId()</div>
<div class="line">                {</div>
<div class="line">                    AttributeId = Attributes.Value,</div>
<div class="line">                    <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> = nodeId</div>
<div class="line">                });</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">return</span> readValueIds;</div>
</div><!-- fragment --><p> The <code>Read</code> method of the SDK is overloaded with different parameterization options. In this example we are using the shortest one for the synchronous call. </p><div class="fragment"><div class="line">                var results = Session.Read(nodesToRead);</div>
</div><!-- fragment --><p> The asynchronous method <code>BeginRead</code> takes four arguments. The first argument is the list of nodes to read. The second argument indicates the maximum age of the variables. It signals if the server can return a cached value or not. In most cases this argument should be <code>0</code>. The third argument is the <code>AsyncCallback</code> and the forth argument is the user data that will be returned in the <code>IAsycResult</code> when the SDK calls the <code>AsyncCallback</code>. </p><div class="fragment"><div class="line">                Session.BeginRead(nodesToRead, 0, OnReadComplete, nodesToRead);</div>
</div><!-- fragment --><p> For the asynchronous call you need to implemented an <code>AsyncCallback</code> that is called by the SDK when the server returns the read results. This method must be used as argument for the asynchronous method call.</p>
<div class="fragment"><div class="line">        <span class="keywordtype">void</span> OnReadComplete(IAsyncResult result)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">try</span></div>
<div class="line">            {</div>
<div class="line">                List&lt;DataValue&gt; results = Session.EndRead(result);</div>
</div><!-- fragment --> <h3><a class="anchor" id="L2ClientTutConsoleClient_Session_ReadIndex"></a>
Read an Array with Index</h3>
<p>OPC UA does not only provide scalar values, but also arrays. You can read the complete array, or only parts of it. The example shows how to read only parts of an array by defining the <code>IndexRange</code> in the <code>ReadValueId</code>. </p><div class="fragment"><div class="line">            <span class="keywordflow">foreach</span> (NodeId nodeId <span class="keywordflow">in</span> Settings.ReadWithIndexRangeVariableIds)</div>
<div class="line">            {</div>
<div class="line">                nodesToRead.Add(<span class="keyword">new</span> ReadValueId()</div>
<div class="line">                {</div>
<div class="line">                    AttributeId = Attributes.Value,</div>
<div class="line">                    <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> = nodeId,</div>
<div class="line">                    IndexRange = <span class="stringliteral">&quot;1:3&quot;</span></div>
<div class="line">                });</div>
<div class="line">            }</div>
</div><!-- fragment --> <h2><a class="anchor" id="L2ClientTutConsoleClient_Session_Write"></a>
Write</h2>
<h3><a class="anchor" id="L2ClientTutConsoleClient_Session_WriteValue"></a>
Write Values</h3>
<p>The <code>Write</code> method uses a list of <a class="el" href="classUnifiedAutomation_1_1UaBase_1_1WriteValue.html">WriteValues</a> as argument. You need to set the <code>NodeId</code>, <code>AttributeId</code> and the <code>Value</code> of the <code>WriteValueId</code> for each node attribute that should be written. The client loads this information, including the value, from its configuration. </p><div class="fragment"><div class="line">                IList&lt;WriteValue&gt; nodesToWrite = Settings.WriteVariables;</div>
<div class="line"></div>
<div class="line">                List&lt;StatusCode&gt; res = Session.Write(nodesToWrite);</div>
</div><!-- fragment --> <h3><a class="anchor" id="L2ClientTutConsoleClient_Session_WriteIndex"></a>
Write an Array with Index</h3>
<p>Like reading, OPC UA also provides the capabilities to write parts of an array, by defining the <code>IndexRange</code> property of the <a class="el" href="classUnifiedAutomation_1_1UaBase_1_1WriteValue.html">WriteValue</a> structure. </p><div class="fragment"><div class="line">                nodeIdsToWrite.Add(<span class="keyword">new</span> WriteValue()</div>
<div class="line">                {</div>
<div class="line">                    <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>(<span class="stringliteral">&quot;Demo.Static.Arrays.Boolean&quot;</span>, 2),</div>
<div class="line">                    Value = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328ac7859cb58bee902dc86f1742665ff96f">DataValue</a>() { WrappedValue = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a492f18b60811bf85ce118c0c6a1a5c4a">Variant</a>(value) },</div>
<div class="line">                    AttributeId = Attributes.Value,</div>
<div class="line">                    IndexRange = <span class="stringliteral">&quot;0:1&quot;</span></div>
<div class="line">                });</div>
</div><!-- fragment --> <h3><a class="anchor" id="L2ClientTutConsoleClient_Session_WriteStruct"></a>
Write a Structure</h3>
<p>The previous examples on writing assumed that the client already knows the data type of the value it should write. This might not always be the case. If the client does not know the data type of a variable in advance, it can read it out of the meta data of the OPC UA server. </p><div class="fragment"><div class="line">                IList&lt;ReadValueId&gt; nodesToRead = <span class="keyword">new</span> List&lt;ReadValueId&gt;</div>
<div class="line">                {</div>
<div class="line">                    <span class="keyword">new</span> ReadValueId()</div>
<div class="line">                    {</div>
<div class="line">                        <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> = structureId,</div>
<div class="line">                        AttributeId = Attributes.DataType</div>
<div class="line">                    }</div>
<div class="line">                };</div>
<div class="line">                results = await Session.ReadAsync(nodesToRead, 0).ConfigureAwait(<span class="keyword">false</span>);</div>
</div><!-- fragment --><p> Afterwards the client can, in case of a structured data type, use a helper class of the SDK (DataTypeDefinitionManager) to generate a generic structure definition. </p><div class="fragment"><div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> dataTypeId = (<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>)results[0].Value;</div>
<div class="line">                GenericStructuredDataTypeDefinition definition = await DataTypeDefinitionManager.GetStructureDefinitionFromDataTypeIdAsync(dataTypeId).ConfigureAwait(<span class="keyword">false</span>);</div>
</div><!-- fragment --><p> The generic structure definition can be used to create a GenericEncodableStructure that can be filled with values and written to the server. Note that in the example the filling of the data in the code is only exemplified with some pre-knowledge of the data structure. Depending on the real client application you can for example generate a generic user interface to get the data from a user. </p><div class="fragment"><div class="line">        GenericEncodeableStructure DefaultStructure(GenericStructuredDataTypeDefinition definition)</div>
<div class="line">        {</div>
<div class="line">            var geo = <span class="keyword">new</span> GenericEncodeableStructure(definition);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; definition.Fields.Count; i++)</div>
<div class="line">            {</div>
<div class="line">                var field = definition.Fields[i];</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (field.ValueRank == ValueRanks.Scalar)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">switch</span> (field.BuiltInType)</div>
<div class="line">                    {</div>
<div class="line">                        <span class="keywordflow">case</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328">BuiltInType</a>.ExtensionObject:</div>
<div class="line">                            <span class="keywordflow">if</span> (field.DataType is GenericStructuredDataTypeDefinition structure)</div>
<div class="line">                            {</div>
<div class="line">                                geo[i] = DefaultStructure(structure);</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">break</span>;</div>
<div class="line">                        <span class="keywordflow">case</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328">BuiltInType</a>.Enumeration:</div>
<div class="line">                            <span class="keywordflow">if</span> (field.DataType is GenericEnumerationDataTypeDefinition enumeration)</div>
<div class="line">                            {</div>
<div class="line">                                geo[i] = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a492f18b60811bf85ce118c0c6a1a5c4a">Variant</a>(enumeration.Fields[0].Value);</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">break</span>;</div>
<div class="line">                        <span class="keywordflow">case</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328">BuiltInType</a>.String:</div>
<div class="line">                            geo[i] = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a492f18b60811bf85ce118c0c6a1a5c4a">Variant</a>(<span class="stringliteral">&quot;Generic Name&quot;</span>);</div>
<div class="line">                            <span class="keywordflow">break</span>;</div>
<div class="line">                        <span class="keywordflow">case</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328">BuiltInType</a>.UInt16:</div>
<div class="line">                            geo[i] = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a492f18b60811bf85ce118c0c6a1a5c4a">Variant</a>((UInt16)123);</div>
<div class="line">                            <span class="keywordflow">break</span>;</div>
<div class="line">                        <span class="keywordflow">case</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328">BuiltInType</a>.Float:</div>
<div class="line">                            geo[i] = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a492f18b60811bf85ce118c0c6a1a5c4a">Variant</a>(13.37f);</div>
<div class="line">                            <span class="keywordflow">break</span>;</div>
<div class="line">                        <span class="keywordflow">case</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328">BuiltInType</a>.Guid:</div>
<div class="line">                            geo[i] = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a492f18b60811bf85ce118c0c6a1a5c4a">Variant</a>(Uuid.NewUuid());</div>
<div class="line">                            <span class="keywordflow">break</span>;</div>
<div class="line">                        <span class="keywordflow">case</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328">BuiltInType</a>.DateTime:</div>
<div class="line">                            geo[i] = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a492f18b60811bf85ce118c0c6a1a5c4a">Variant</a>(<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a8cf10d2341ed01492506085688270c1e">DateTime</a>.UtcNow);</div>
<div class="line">                            <span class="keywordflow">break</span>;</div>
<div class="line">                        <span class="keywordflow">case</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328">BuiltInType</a>.LocalizedText:</div>
<div class="line">                            geo[i] = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a492f18b60811bf85ce118c0c6a1a5c4a">Variant</a>(<span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a26889eee67d7ccc649f6188d0c20ad2b">LocalizedText</a>(<span class="stringliteral">&quot;A description&quot;</span>));</div>
<div class="line">                            <span class="keywordflow">break</span>;</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (field.ValueRank == ValueRanks.OneDimension)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">switch</span> (field.BuiltInType)</div>
<div class="line">                    {</div>
<div class="line">                        <span class="keywordflow">case</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328">BuiltInType</a>.ExtensionObject:</div>
<div class="line">                            <span class="keywordflow">if</span> (field.DataType is GenericStructuredDataTypeDefinition structure)</div>
<div class="line">                            {</div>
<div class="line">                                ExtensionObjectCollection eos = <span class="keyword">new</span> ExtensionObjectCollection()</div>
<div class="line">                                    {</div>
<div class="line">                                        <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a1adf19f65f9aa28f3b51d77b73f6b688">ExtensionObject</a>(DefaultStructure(structure)),</div>
<div class="line">                                        <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a1adf19f65f9aa28f3b51d77b73f6b688">ExtensionObject</a>(DefaultStructure(structure)),</div>
<div class="line">                                        <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a1adf19f65f9aa28f3b51d77b73f6b688">ExtensionObject</a>(DefaultStructure(structure)),</div>
<div class="line">                                        <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a1adf19f65f9aa28f3b51d77b73f6b688">ExtensionObject</a>(DefaultStructure(structure)),</div>
<div class="line">                                    };</div>
<div class="line">                                geo[i] = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a492f18b60811bf85ce118c0c6a1a5c4a">Variant</a>(eos);</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">break</span>;</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> geo;</div>
<div class="line">        }</div>
</div><!-- fragment --><div class="fragment"><div class="line">                <span class="comment">//Create encodeable object</span></div>
<div class="line">                var geo = DefaultStructure(definition);</div>
<div class="line"></div>
<div class="line">                IList&lt;WriteValue&gt; nodesToWrite = <span class="keyword">new</span> List&lt;WriteValue&gt;</div>
<div class="line">                {</div>
<div class="line">                    <span class="keyword">new</span> WriteValue()</div>
<div class="line">                    {</div>
<div class="line">                        <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> = structureId,</div>
<div class="line">                        Value = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328ac7859cb58bee902dc86f1742665ff96f">DataValue</a>() { WrappedValue = geo },</div>
<div class="line">                        AttributeId = Attributes.Value</div>
<div class="line">                    }</div>
<div class="line">                };</div>
<div class="line">                List&lt;StatusCode&gt; res = await Session.WriteAsync(nodesToWrite).ConfigureAwait(<span class="keyword">false</span>);</div>
</div><!-- fragment --><h2><a class="anchor" id="L2ClientTutConsoleClient_Session_Browse"></a>
Browse</h2>
<p>The Browse Service is used to navigate through the address space. The <code>Browse</code> method in the SDK is a simplified toolkit method that uses only one node as starting point of the navigation. It returns a list of <a class="el" href="classUnifiedAutomation_1_1UaBase_1_1ReferenceDescription.html">ReferenceDescription</a>.</p>
<p>Next to the <code>NodeId</code> of the node to browse, you can pass a <a class="el" href="classUnifiedAutomation_1_1UaClient_1_1BrowseContext.html">BrowseContext</a> to the method. See the documentation of BrowseContext for detailed explanation of the class and its properties.</p>
<div class="fragment"><div class="line">            BrowseContext context = <span class="keyword">new</span> BrowseContext()</div>
<div class="line">            {</div>
<div class="line">                BrowseDirection = BrowseDirection.Both,</div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a9bafec980b0e46918f646fa8019b577ba738520b2dcbb7dbb2c8d33096387aef8">ReferenceTypeId</a> = ReferenceTypeIds.References,</div>
<div class="line">                IncludeSubtypes = <span class="keyword">true</span>,</div>
<div class="line">                NodeClassMask = 0,</div>
<div class="line">                ResultMask = (uint)<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a9bafec980b0e46918f646fa8019b577b">BrowseResultMask</a>.None,</div>
<div class="line">                MaxReferencesToReturn = 100</div>
<div class="line">            };</div>
</div><!-- fragment --><p> The <code>Browse</code> method provides an output argument called <code>continuationPoint</code>. With this argument a server can indicate that more references are available in the server for the node to browse. If the <code>continuationPoint</code> is <code>null</code>, the server returned all available <code>ReferenceDescriptions</code>. If it is not <code>null</code>, more ReferenceDescriptions are available. In this case the client can decide to either call <code>BrowseNext</code> to get the next ReferenceDescriptions or to call <code>ReleaseContinuationPoint</code> to indicate that the server can release the data that is required to return the next references.</p>
<div class="fragment"><div class="line">                results = m_session.Browse(</div>
<div class="line">                    nodeToBrowse,</div>
<div class="line">                    context,</div>
<div class="line">                    null,</div>
<div class="line">                    out m_continuationPoint);</div>
</div><!-- fragment --><div class="fragment"><div class="line">                results = Session.BrowseNext(ref m_continuationPoint);</div>
</div><!-- fragment --><div class="fragment"><div class="line">                Session.ReleaseBrowseContinuationPoint(m_continuationPoint);</div>
</div><!-- fragment --> <h2><a class="anchor" id="L2ClientTutConsoleClient_Session_TranslateBrowsePath"></a>
TranslateBrowsePathsToNodeIds</h2>
<p>In addition to the Browse Service, OPC UA supports the TranslateBrowsePathsToNodeIds Service. The main use case for this service is to program against types. Clients use the type definition (ObjectType) to program a user interface element, asset monitor, etc. and deploy this to the instances of the type. The Clients need to store the BrowsePath based on the type definition and use the TranslateBrowsePathsToNodeIds service to get the correct NodeIds of the instance. Unlike the Browse Service, this service follows several hops (levels in the hierarchy) at once, so that you only need to call this service once to dispatch all BrowsePaths of a type definition. In the example, the client loads the starting node and the BrowsePaths from the configuration. </p><div class="fragment"><div class="line">            <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> startingNodeId = Settings.TranslateStartingNodeId;</div>
<div class="line"></div>
<div class="line">            List&lt;BrowsePath&gt; pathsToTranslate = <span class="keyword">new</span> List&lt;BrowsePath&gt;();</div>
<div class="line"></div>
<div class="line">            BrowsePath browsePath = <span class="keyword">new</span> BrowsePath</div>
<div class="line">            {</div>
<div class="line">                StartingNode = startingNodeId</div>
<div class="line">            };</div>
<div class="line"></div>
<div class="line">            browsePath.RelativePath.Elements.Add(<span class="keyword">new</span> RelativePathElement()</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a9bafec980b0e46918f646fa8019b577ba738520b2dcbb7dbb2c8d33096387aef8">ReferenceTypeId</a> = ReferenceTypeIds.HierarchicalReferences,</div>
<div class="line">                IncludeSubtypes = <span class="keyword">true</span>,</div>
<div class="line">                IsInverse = <span class="keyword">false</span>,</div>
<div class="line">                TargetName = Settings.TranslateElement</div>
<div class="line">            });</div>
<div class="line"></div>
<div class="line">            pathsToTranslate.Add(browsePath);</div>
</div><!-- fragment --><p>Afterwards, the service is called. </p><div class="fragment"><div class="line">                List&lt;BrowsePathResult&gt; results = Session.TranslateBrowsePath(pathsToTranslate);</div>
</div><!-- fragment --> <h2><a class="anchor" id="L2ClientTutConsoleClient_Session_CallMethod"></a>
Call Methods</h2>
<p>When an OPC UA server supports methods, clients can call those methods with the OPC UA call service. The Client SDK provides a method on the session to call an OPC UA method. It takes the NodeId of the Object containing the method, the NodeId of the Method, and the input arguments of the method as input and the output arguments of the method as output. The example client calls a method as defined in its configuration. </p><div class="fragment"><div class="line">                Configuration.MethodDescription method = Settings.Method;</div>
<div class="line">                </div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a72381d4605940627a6e846d5f3155c51">StatusCode</a> result = Session.Call(method.ObjectId, method.MethodId, method.InputArguments, out inputArgumentErrors, out outputArguments);</div>
</div><!-- fragment --> <h2><a class="anchor" id="L2ClientTutConsoleClient_Session_RegisterNodes"></a>
RegisterNodes</h2>
<p>The RegisterNodes service is used to provide potentially large NodeIds (e.g. containing a long string) to the server and get small NodeIds (integer-based) back from the server that can be used while the session is running. Clients can use this mechanism to optimize the size of a NodeId that they are using several times, for example by writing a Variable or calling a method periodically. Using this service only makes sense when a client wants to use the same NodeId several times, otherwise the large NodeId should be used directly. The Client SDK provides a method that calls the service which takes a list of NodeIds as inputs and returns a list of (small) NodeIds. </p><div class="fragment"><div class="line">                RegisteredNodes = Session.RegisterNodes(nodesToRegister, null);</div>
</div><!-- fragment --><p>When the client does not want to use the NodeIds anymore, it can release it with UnregisterNodes.</p>
<h2><a class="anchor" id="L2ClientTutConsoleClient_Session_HistoryRead"></a>
Access Historical Data</h2>
<p>OPC UA allows to access the history of data, that is, changes of the value of a Variable over the time.</p>
<h3><a class="anchor" id="L2ClientTutConsoleClient_Session__HistoryRead_Raw"></a>
Read Raw Data</h3>
<p>To read the history of a Variable, the Client needs to specify information which variable to access and which timespan to consider. In the example, the information of the Variable is first loaded from the configuration, and the timespan is defined. </p><div class="fragment"><div class="line">            HistoryReadValueIdCollection nodesToRead = <span class="keyword">new</span> HistoryReadValueIdCollection();</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">foreach</span> (NodeId node <span class="keywordflow">in</span> Settings.HistoryVariableIds)</div>
<div class="line">            {</div>
<div class="line">                nodesToRead.Add(<span class="keyword">new</span> HistoryReadValueId() { <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> = node });</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            ReadRawModifiedDetails details = <span class="keyword">new</span> ReadRawModifiedDetails()</div>
<div class="line">            {</div>
<div class="line">                StartTime = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a8cf10d2341ed01492506085688270c1e">DateTime</a>(2017, 1, 1, 0, 0, 0, 0, DateTimeKind.Local),</div>
<div class="line">                EndTime = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a8cf10d2341ed01492506085688270c1e">DateTime</a>.UtcNow,</div>
<div class="line">                NumValuesPerNode = 10,</div>
<div class="line">                IsReadModified = <span class="keyword">false</span>,</div>
<div class="line">                ReturnBounds = <span class="keyword">false</span>,</div>
<div class="line">            };</div>
</div><!-- fragment --><p>Afterwards the service is called. </p><div class="fragment"><div class="line">                <span class="comment">// fetch the history (with a 10s timeout).</span></div>
<div class="line">                List&lt;HistoryDataReadResult&gt; results = Session.HistoryReadRaw(</div>
<div class="line">                    nodesToRead,</div>
<div class="line">                    details,</div>
<div class="line">                    <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a786f7446cd520df161222ac779c2caa9">TimestampsToReturn</a>.Source,</div>
<div class="line">                    <span class="keyword">new</span> RequestSettings() { OperationTimeout = 10000 });</div>
</div><!-- fragment --><p>Like the Browse Service, HistoryRead might return a continuation point and might be called several times with the continuation point.</p>
<h3><a class="anchor" id="L2ClientTutConsoleClient_Session__HistoryRead_Update"></a>
Update Historical Data</h3>
<p>If the server supports this feature, clients can also change the historical data managed in the server. Therefore, they need to define the data to be updated. In the example, the information is loaded from the configuration. </p><div class="fragment"><div class="line">            List&lt;UpdateDataDetails&gt; nodesToUpdate = <span class="keyword">new</span> List&lt;UpdateDataDetails&gt;();</div>
<div class="line">            IList&lt;NodeId&gt; historyIds = Settings.HistoryVariableIds;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">foreach</span>(NodeId nodeId <span class="keywordflow">in</span> historyIds)</div>
<div class="line">            {</div>
<div class="line">                nodesToUpdate.Add(<span class="keyword">new</span> UpdateDataDetails()</div>
<div class="line">                {</div>
<div class="line">                    <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> = nodeId,</div>
<div class="line">                    PerformInsertReplace = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a1c007ac378565f1cf0ad4f5d256a1584">PerformUpdateType</a>.Update,</div>
<div class="line">                    UpdateValues = <span class="keyword">new</span> DataValueCollection()</div>
<div class="line">                    {</div>
<div class="line">                        <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328ac7859cb58bee902dc86f1742665ff96f">DataValue</a>()</div>
<div class="line">                        {</div>
<div class="line">                            SourceTimestamp = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a8cf10d2341ed01492506085688270c1e">DateTime</a>.UtcNow,</div>
<div class="line">                            ServerTimestamp = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a8cf10d2341ed01492506085688270c1e">DateTime</a>.UtcNow,</div>
<div class="line">                            WrappedValue = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a492f18b60811bf85ce118c0c6a1a5c4a">Variant</a>(0.0)</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                });</div>
<div class="line">            }</div>
</div><!-- fragment --><p>And afterwards, the HistoryUpdate service is called. </p><div class="fragment"><div class="line">                var results = Session.HistoryUpdateData(nodesToUpdate);</div>
</div><!-- fragment --> <h2><a class="anchor" id="L2ClientTutConsoleClient_Session_HistoryEvent"></a>
Access Historical Events</h2>
<p>Like the historical data of a Variable, OPC UA Clients can also access the history of events over the time. </p>
<h3><a class="anchor" id="L2ClientTutConsoleClient_Session__HistoryEvent_Read"></a>
Read Historical Events</h3>
<p>To read the history of events, a client needs to specify the Object to receive the events, and in addition, an event filter and the timespan. In the example, this Object to read is loaded from the configuration. </p><div class="fragment"><div class="line">                IList&lt;HistoryReadValueId&gt; nodesToRead = HistoryReadValueIdsFromConfiguration();</div>
</div><!-- fragment --><p>The filter is also loaded from the configuration and the timespan is set. </p><div class="fragment"><div class="line">                var readEventDetails = <span class="keyword">new</span> ReadEventDetails()</div>
<div class="line">                {</div>
<div class="line">                    StartTime = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a8cf10d2341ed01492506085688270c1e">DateTime</a>(2017, 1, 1, 0, 0, 0, 0, DateTimeKind.Local),</div>
<div class="line">                    EndTime = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a8cf10d2341ed01492506085688270c1e">DateTime</a>.UtcNow,</div>
<div class="line">                    NumValuesPerNode = 10,</div>
<div class="line">                    Filter = <span class="keyword">new</span> EventFilter()</div>
<div class="line">                    {</div>
<div class="line">                        SelectClauses = <span class="keyword">new</span> SimpleAttributeOperandCollection()</div>
<div class="line">                    }</div>
<div class="line">                };</div>
<div class="line">                <span class="keywordflow">foreach</span> (QualifiedName name <span class="keywordflow">in</span> EventFieldsForHistoryRead())</div>
<div class="line">                {</div>
<div class="line">                    readEventDetails.Filter.SelectClauses.Add(</div>
<div class="line">                        <span class="keyword">new</span> SimpleAttributeOperand()</div>
<div class="line">                        {</div>
<div class="line">                            AttributeId = Attributes.Value,</div>
<div class="line">                            BrowsePath = <span class="keyword">new</span> QualifiedNameCollection()</div>
<div class="line">                            {</div>
<div class="line">                                name</div>
<div class="line">                            }</div>
<div class="line">                        });</div>
<div class="line">                }</div>
</div><!-- fragment --><p>Afterwards the HistoryRead service is called. </p><div class="fragment"><div class="line">                var results = Session.HistoryReadEvent(nodesToRead, readEventDetails);</div>
</div><!-- fragment --> <h1><a class="anchor" id="L2ClientTutConsoleClient_Subscription"></a>
Subscription services</h1>
<p><a class="el" href="classUnifiedAutomation_1_1UaClient_1_1Subscription.html">Subscriptions</a> monitor a set of MonitoredItems for Notifications. With this mechanism a server can send data changes or events to a client.</p>
<h2><a class="anchor" id="L2ClientTutConsoleClient_Subscription_Create"></a>
Create Subscription</h2>
<p>A Subscription has several event handlers. In this example the <code>DataChanged</code> and the <code>NewEvent</code> event handler are implemented.</p>
<p>Calling <code>Subscription.Create</code> does the OPC UA service calls and creates the subscription at the server.</p>
<div class="fragment"><div class="line">                    m_subscription = <span class="keyword">new</span> Subscription(Session)</div>
<div class="line">                    {</div>
<div class="line">                        PublishingEnabled = <span class="keyword">true</span>,</div>
<div class="line">                        PublishingInterval = 100</div>
<div class="line">                    };</div>
<div class="line">                    <span class="keywordflow">if</span> (Settings.ClientSettings.SubscriptionLifetime != 0)</div>
<div class="line">                    {</div>
<div class="line">                        m_subscription.Lifetime = Settings.ClientSettings.SubscriptionLifetime;</div>
<div class="line">                    }</div>
<div class="line">                    m_subscription.DataChanged += OnDataChanged;</div>
<div class="line">                    m_subscription.NewEvents += OnEvent;</div>
<div class="line">                    m_subscription.NotificationMessageReceived += OnNotificationMessageReceived;</div>
<div class="line">                    m_subscription.StatusChanged += OnStatusChanged;</div>
<div class="line">                    m_subscription.Recreated += OnSubscriptionRecreated;</div>
<div class="line">                    m_subscription.Create();</div>
</div><!-- fragment --> <h2><a class="anchor" id="L2ClientTutConsoleClient_Subscription_CreateDataMonitoredItems"></a>
Create DataMonitoredItems</h2>
<p>If you want to create a MonitoredItem to get DataChanges, you need to create a DataMonitoredItem. You need to specify the NodeId and the AttributeId of the node to monitor. By default, the Value attribute is monitored.</p>
<p>In this example the DataMonitoredItems are created with the configured nodes.</p>
<div class="fragment"><div class="line">        IList&lt;MonitoredItem&gt; ItemsToMonitorFromConfiguration()</div>
<div class="line">        {</div>
<div class="line">            IList &lt;MonitoredItem&gt; result = <span class="keyword">new</span> List&lt;MonitoredItem&gt;();</div>
<div class="line">            <span class="keywordflow">foreach</span> (NodeId nodeId <span class="keywordflow">in</span> Settings.ReadVariableIds)</div>
<div class="line">            {</div>
<div class="line">                DataMonitoredItem monitoredItem = <span class="keyword">new</span> DataMonitoredItem(nodeId)</div>
<div class="line">                {</div>
<div class="line">                    SamplingInterval = 0</div>
<div class="line">                };</div>
<div class="line">                result.Add(monitoredItem);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">return</span> result;</div>
<div class="line">        }</div>
</div><!-- fragment --><p> The resulting list is used to call <code>CreateMonitoredItems</code>. This call returns a list of <a class="el" href="structUnifiedAutomation_1_1UaBase_1_1StatusCode.html">StatusCodes</a> indicating the success of the operation for each MonitoredItem.</p>
<div class="fragment"><div class="line">            IList&lt;MonitoredItem&gt; monitoredItems = ItemsToMonitorFromConfiguration();</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">try</span></div>
<div class="line">            {</div>
<div class="line">                List&lt;StatusCode&gt; results = m_subscription.CreateMonitoredItems(monitoredItems);</div>
</div><!-- fragment --><p> The DataChanges are reported with the <code>DataChanged</code> event handler to the application. The <a class="el" href="classUnifiedAutomation_1_1UaClient_1_1DataChangedEventArgs.html">DataChangedEventArgs</a> contains a list of DataChange structures. This structure contains the value that is sent by the server and the MonitoredItem that is related to the value. The client application does need to take care about the ClientHandle and the ServerHandle of the MonitoredItem. The application can set UserData at the MonitoredItem. This information can be used when a DataChange is reported.</p>
<div class="fragment"><div class="line">        <span class="keywordtype">void</span> OnDataChanged(Subscription subscription, DataChangedEventArgs e)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">//Process DataChanges in separate threads/tasks to avoid blocking the client application.</span></div>
<div class="line">            this.<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a96d16e9a0ffe0e31ca0315c51a54adcfae498749f3c42246d50b15c81c101d988">Application</a>.ThreadPool.Queue(e, ProcessDataChange);</div>
<div class="line">        }</div>
</div><!-- fragment --> <h2><a class="anchor" id="L2ClientTutConsoleClient_Subscription_CreateEventMonitoredItems"></a>
Create EventMonitoredItems</h2>
<p>By creating an <a class="el" href="classUnifiedAutomation_1_1UaClient_1_1EventMonitoredItem.html">EventMonitoredItem</a> the client application can subscribe to UA events on the server. The NodeId of the <code>EventMonitoredItem</code> represents the node in the address space that is the current root of the event hierarchy to report events to the client. The default configuration of the example uses the <a class="el" href="classUnifiedAutomation_1_1UaBase_1_1ObjectIds.html#aedb906e0edee8a8d8926108d250dd924">Server</a> node. The Server object is a standardized node that is available in each server and provides all events of the OPC UA server. </p><div class="fragment"><div class="line">                EventMonitoredItem monitoredItem = <span class="keyword">new</span> EventMonitoredItem(Settings.EventId)</div>
<div class="line">                {</div>
</div><!-- fragment --><p> You need to specify the event fields that the server sends with each event. This is done with the <code>SelectClauses</code> property of the <a class="el" href="classUnifiedAutomation_1_1UaClient_1_1ItemEventFilter.html">ItemEventFilter</a>. </p><div class="fragment"><div class="line">                    Filter = <span class="keyword">new</span> ItemEventFilter(m_subscription.Session.NamespaceUris)</div>
<div class="line">                    {</div>
<div class="line">                        SelectClauses =</div>
<div class="line">                        {</div>
<div class="line">                            BrowseNames.EventId,</div>
<div class="line">                            BrowseNames.EventType,</div>
<div class="line">                            BrowseNames.Message,</div>
<div class="line">                            BrowseNames.Severity,</div>
<div class="line">                            BrowseNames.SourceName,</div>
<div class="line">                            BrowseNames.Time</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                };</div>
</div><!-- fragment --><p> Optionally you can set a <code>WhereClause</code> to restrict the sent events based regarding some conditions. The default configuration of the example filters for events of NodeId 1005 in the server namespace. If you want to try the example with the demo server you need to manually trigger events of that type by writing the Boolean Variable under <em>Objects/Demo/004_Events/Trigger_SampleEvent</em>. Each change of the variable triggers an event. You can use a second client (for example the <a href="https://www.unified-automation.com/products/development-tools/uaexpert.html">UAExpert</a>) to change the Variable on the Demo Server. </p><div class="fragment"><div class="line">                    monitoredItem.Filter.WhereClauses.Add(<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a98d5de4940c68c29a34e39c0f6b378e7">FilterOperator</a>.OfType, <span class="keyword">new</span> LiteralOperand() { Value = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a492f18b60811bf85ce118c0c6a1a5c4a">Variant</a>(Settings.EventOfTypeFilter) });</div>
</div><!-- fragment --><p> The events are reported to the application by the <code>NewEvents</code> event handler.</p>
<div class="fragment"><div class="line">        <span class="keywordtype">void</span> OnEvent(Subscription subscription, NewEventsEventArgs e)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">//Process Events in separate threads/tasks to avoid blocking the client application.</span></div>
<div class="line">            this.<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a96d16e9a0ffe0e31ca0315c51a54adcfae498749f3c42246d50b15c81c101d988">Application</a>.ThreadPool.Queue(e, ProcessEvent);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">void</span> ProcessEvent(<span class="keywordtype">object</span> data, StatusCode error)</div>
<div class="line">        {</div>
<div class="line">            NewEventsEventArgs e = data as NewEventsEventArgs;</div>
<div class="line"></div>
<div class="line">            lock (ConsoleLock)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">foreach</span> (NewEvent anEvent <span class="keywordflow">in</span> e.Events)</div>
<div class="line">                {</div>
<div class="line">                    Console.WriteLine($<span class="stringliteral">&quot;\nEvent occurred: {anEvent.Event.EventFields[2]}&quot;</span>);</div>
<div class="line">                    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii = 0; ii &lt; anEvent.Event.EventFields.Count; ii++)</div>
<div class="line">                    {</div>
<div class="line">                        Console.WriteLine($<span class="stringliteral">&quot;  {EventFieldName(anEvent.MonitoredItem.Filter.SelectClauses[ii].BrowsePath)}: {anEvent.Event.EventFields[ii]}&quot;</span>);</div>
<div class="line">                    }</div>
</div><!-- fragment --> <h2><a class="anchor" id="L2ClientTutConsoleClient_Subscription_SubscribeAlarm"></a>
Subscribe Alarm</h2>
<p>Subscribing for alarms is essentially the same as subscribing for events. But there are two special features.</p>
<ul>
<li>You can select an event field with an empty BrowseName. If this event field is selected, the ConditionId (NodeId) is returned in the event. You need the ConditionId to acknowledge alarms.</li>
<li>You can call the UA method ConditionRefresh to get events for each condition with the field <code>Retain</code> = <code>true</code>.</li>
</ul>
<p>Since subscribing for alarms is technically the same as subscribing for events the same event handler is used to report the events.</p>
<div class="fragment"><div class="line">            <span class="comment">/*00*/</span> monitoredItem.Filter.SelectClauses.AddConditionId();</div>
</div><!-- fragment --><p> To get all currently interesting alarms of a server, the <code>ConditionRefresh</code> method is called. </p><div class="fragment"><div class="line">            List&lt;StatusCode&gt; inputResults;</div>
<div class="line">            List&lt;Variant&gt; outArguments;</div>
<div class="line">            Session.Call(</div>
<div class="line">                ObjectTypeIds.ConditionType,</div>
<div class="line">                MethodIds.ConditionType_ConditionRefresh,</div>
<div class="line">                <span class="keyword">new</span> List&lt;Variant&gt;() { m_subscription.SubscriptionId },</div>
<div class="line">                out inputResults,</div>
<div class="line">                out outArguments);</div>
<div class="line">            <span class="keywordflow">return</span> ClientState.Connected;</div>
</div><!-- fragment --><p>Note that calling the refresh method triggers a ConditionRefreshStarted event, afterwards all interesting alarms are sent, and at the end, a ConfitionRefreshCompleted event is send. </p>
<h2><a class="anchor" id="L2ClientTutConsoleClient_Subscription_AcknowlegdeAlarms"></a>
Acknowledge Alarms</h2>
<p>To acknowledge alarms, the Acknowledge Method needs to be called. </p><div class="fragment"><div class="line">                var result = Session.Call(</div>
<div class="line">                    alarm.EventFields[0].ToNodeId(),</div>
<div class="line">                    MethodIds.AcknowledgeableConditionType_Acknowledge,</div>
<div class="line">                    <span class="keyword">new</span> List&lt;Variant&gt;()</div>
<div class="line">                    {</div>
<div class="line">                        <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a492f18b60811bf85ce118c0c6a1a5c4a">Variant</a>(alarm.EventFields[1].ToByteString()),</div>
<div class="line">                        <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a492f18b60811bf85ce118c0c6a1a5c4a">Variant</a>(<span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a26889eee67d7ccc649f6188d0c20ad2b">LocalizedText</a>(<span class="stringliteral">&quot;Acknowledge from ConsoleClient&quot;</span>))</div>
<div class="line">                    },</div>
<div class="line">                    out inputArgumentResults,</div>
<div class="line">                    out outputArguments);</div>
</div><!-- fragment --><p>You can acknowledge many (all) alarms with one service call. </p><div class="fragment"><div class="line">                <span class="keywordflow">foreach</span> (var alarm <span class="keywordflow">in</span> m_alarmList)</div>
<div class="line">                {</div>
<div class="line">                    methods.Add(<span class="keyword">new</span> CallMethodRequest()</div>
<div class="line">                    {</div>
<div class="line">                        ObjectId = alarm.EventFields[0].ToNodeId(),</div>
<div class="line">                        MethodId = MethodIds.AcknowledgeableConditionType_Acknowledge,</div>
<div class="line">                        InputArguments = <span class="keyword">new</span> VariantCollection()</div>
<div class="line">                        {</div>
<div class="line">                            <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a492f18b60811bf85ce118c0c6a1a5c4a">Variant</a>(alarm.EventFields[1].ToByteString()),</div>
<div class="line">                            <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a492f18b60811bf85ce118c0c6a1a5c4a">Variant</a>(<span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a26889eee67d7ccc649f6188d0c20ad2b">LocalizedText</a>(<span class="stringliteral">&quot;Acknowledge all from ConsoleClient&quot;</span>))</div>
<div class="line">                        }</div>
<div class="line">                    });</div>
<div class="line">                }</div>
<div class="line">                var results = Session.CallList(methods, null);</div>
</div><!-- fragment --><h2><a class="anchor" id="L2ClientTutConsoleClient_Subscription_TransferSubscriptions"></a>
Transfer Subscriptions</h2>
<p>The lifetime of a session and a subscription are independent. Typically a subscription has a higher lifetime than a subscription. If a session gets lost (e.g. due to communication errors) the client can create a new session and still use the existing subscription of the previous session, without loosing data. Therefore, it needs to transfer the existing subscription from the previous session to the new session. In the example, the session is actively disconnected and afterwards a new session is created. With the TransferSubscription Service, the previously created subscription is transferred to the new session. </p><div class="fragment"><div class="line">                    <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a72381d4605940627a6e846d5f3155c51">StatusCode</a> ret = Session.TransferSingleSubscription(m_subscription);</div>
</div><!-- fragment --><p>Note that transferring a subscription only works when you use user credentials. This avoids that you can transfer a subscription from a different user / client. Therefore, this service call will fail when you have not set a user for the current session, and the same user for the previous session, where the subscription was created. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="L1ClientTutorials.html">Tutorials for Client development</a></li>
    <li class="footer">&copy; Unified Automation GmbH - All rights reserved.</li>
  </ul>
</div>
</body>
</html>
