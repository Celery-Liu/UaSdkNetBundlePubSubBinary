<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>.NET Based OPC UA Client/Server/PubSub SDK: Lesson 6: Adding Support for Alarms &amp; Conditions</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="header_inner_inner_bg2.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">.NET Based OPC UA Client/Server/PubSub SDK
   &#160;<span id="projectnumber">4.1.0.556</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('L3ServerTutGSLess06.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Events</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Lesson 6: Adding Support for Alarms &amp; Conditions </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In this example we extend the ControllerType defined in <a class="el" href="L3ServerTutGSLess02.html">Lesson 2</a> by adding an instance of an alarm: We add a new Object called StateCondition having the TypeDefinition OffNodemalAlarmType (see Figure 6.1).</p>
<div class="image">
<img src="serverlesson06_add_condition_object.png" alt="serverlesson06_add_condition_object.png"/>
<div class="caption">
Figure 6.1: New StateCondition Object</div></div>
<p> Open the UaModeler project created in <a class="el" href="L4ServerTutGSLess02a.html">Lesson 2</a>. Add a new Object called “StateCondition” as a child of ControllerType and choose “OffNormalAlarmType” as TypeDefinition (see Figure 6.2).</p>
<div class="image">
<img src="serverlesson06_modeler.png" alt="serverlesson06_modeler.png"/>
<div class="caption">
Figure 6.2: Add Alarm Object</div></div>
<p> Then regenerate the source files, export the model as xml file and replace the files BAIdentifiers.cs and buildingautomation.xml in your project.</p>
<p>After adding the controller object, we create an instance of the <a class="el" href="classUnifiedAutomation_1_1UaServer_1_1OffNormalAlarmModel.html">OffNormalAlarmModel</a>. This class is used to store all data related to the OffNormalAlarmType. With <a class="el" href="classUnifiedAutomation_1_1UaServer_1_1BaseNodeManager.html#a44959d41c84b5f034d4d13242be5023e">LinkModelToNode</a> the SDK maps the data defined in the instance to the nodes in the address space.</p>
<div class="fragment"><div class="line">                    <span class="comment">// Set alarm condition nodeId</span></div>
<div class="line">                    SetAlarmCondition(block);</div>
</div><!-- fragment --><p> We change the state of the alarm in the BlockStateChanged EventHandler.</p>
<div class="fragment"><div class="line">            <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> alarmId = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>(blockName + <span class="stringliteral">&quot;.&quot;</span> + yourorganisation.BA.BrowseNames.StateCondition, InstanceNamespaceIndex);</div>
<div class="line">            OffNormalAlarmModel alarm = (OffNormalAlarmModel)GetNodeUserData(alarmId);</div>
<div class="line">            <span class="comment">// Change state of StateCondition</span></div>
<div class="line">            lock (alarm)</div>
<div class="line">            {</div>
<div class="line">                alarm.LastSeverity.Value = alarm.Severity;</div>
<div class="line">                alarm.LastSeverity.SourceTimestamp = alarm.Time;</div>
<div class="line">                <span class="keywordflow">if</span> (state == 0)</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// Change state to active</span></div>
<div class="line">                    alarm.Severity = (ushort)<a class="code" href="namespaceUnifiedAutomation_1_1UaServer.html#a53eb44cce8051866958dfef2effb3bd0">EventSeverity</a>.High;</div>
<div class="line">                    alarm.Activate();</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// Change state to inactive</span></div>
<div class="line">                    alarm.Severity = (ushort)<a class="code" href="namespaceUnifiedAutomation_1_1UaServer.html#a53eb44cce8051866958dfef2effb3bd0">EventSeverity</a>.Low;</div>
<div class="line">                    alarm.Inactivate();</div>
<div class="line">                }</div>
<div class="line">            }</div>
</div><!-- fragment --><p> Finally, we have to add handling for Acknowledge calls by clients. Therefore, we need to override the <a class="el" href="classUnifiedAutomation_1_1UaServer_1_1BaseNodeManager.html#af280a3a8ac3bf953be5ceaae1f315e80">Acknowledge</a> method defined at the <a class="el" href="classUnifiedAutomation_1_1UaServer_1_1BaseNodeManager.html">BaseNodeManager</a>.</p>
<div class="fragment"><div class="line">        <span class="keyword">public</span> <span class="keyword">override</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a72381d4605940627a6e846d5f3155c51">StatusCode</a> Acknowledge(</div>
<div class="line">            RequestContext context,</div>
<div class="line">            AcknowledgeableConditionModel model,</div>
<div class="line">            byte[] eventId,</div>
<div class="line">            LocalizedText comment)</div>
<div class="line">        {</div>
<div class="line">            lock (model)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> model.Acknowledge(eventId, comment, context.UserIdentity.UserName);</div>
<div class="line">            }</div>
<div class="line">        }</div>
</div><!-- fragment --><p> To test the alarm, open a new Event View in UaExpert and change to the “Alarms” tab (see Figure 6.3). The alarm can be triggered by calling the methods “Start” and “Stop”. Right click on an Alarm to acknowledge, confirm, or add a comment.</p>
<div class="image">
<img src="serverlesson06_expert.png" alt="serverlesson06_expert.png"/>
<div class="caption">
Figure 6.3: Alarms in UaExpert </div></div>
 </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="L1ServerTutorials.html">Tutorials for Server development</a></li><li class="navelem"><a class="el" href="L2ServerTutGettingStarted.html">Getting Started</a></li>
    <li class="footer">&copy; Unified Automation GmbH - All rights reserved.</li>
  </ul>
</div>
</body>
</html>
