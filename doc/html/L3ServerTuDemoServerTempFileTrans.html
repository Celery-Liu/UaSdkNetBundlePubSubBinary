<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>.NET Based OPC UA Client/Server/PubSub SDK: Temporary File Transfer Example</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="header_inner_inner_bg2.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">.NET Based OPC UA Client/Server/PubSub SDK
   &#160;<span id="projectnumber">4.1.0.556</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('L3ServerTuDemoServerTempFileTrans.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Events</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Temporary File Transfer Example </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The temporary file transfer allows either to generate a file by the server and transfer it to the client or to write a file from the client to the server and apply the file content. In both cases, the file is only available in the address space for the specific client while it is transferred.</p>
<h1><a class="anchor" id="L3ServerTuDemoServerTempFileTrans_ReadFiles"></a>
Reading Files</h1>
<p>Typical use cases for reading temporary files are providing specific reports, the current configuration of the system or a module, or the current log. The temporary file transfer allows the client to parameterize the file creation, for example defining the format of the report.</p>
<p>In order to provide temporary file transfer an object of <code>TemporaryFileTransferType</code> or a subtype needs to be provided. In order to provide temporary file transfer an object of <code>TemporaryFileTransferType</code> or a subtype needs to be provided. The client first calls <code>GenerateFileForRead</code> (which may contain configuration parameters) and gets back a <code>NodeId</code> and <code>FileHandle</code> of an already opened file object. Then the client transfers the file by reading it. When closing the file, the file object is removed. Since the file generation may take some time, the <code>GenerateFileForRead</code> may also return a state machine object indicating when the file is actually ready to be accessed.</p>
<h1><a class="anchor" id="L3ServerTuDemoServerTempFileTrans_WriteFiles"></a>
Writing Files</h1>
<p>A typical use case for writing temporary files is that a new configuration shall be applied to the server. The configuration might effect the whole system or just a specific part. Like for the read, the temporary file transfers allows the client to parameterize the file to be written, for example defining the configuration format.</p>
<p>Like for the read, an object of <code>TemporaryFileTransferType</code> or a subtype needs to be provided. The client first calls <code>GenerateFileForWrite</code> and gets back a <code>NodeId</code> and <code>FileHandle</code> of an already opened file object to be written. The client then writes the content into the file and afterwards calls <code>CloseAndCommit</code>. This method either directly returns a status if the operation was successful, or in case the deployment takes some time a state machine object that finally returns the status of the operation.</p>
<h1><a class="anchor" id="L3ServerTuDemoServerTempFileTrans_Example"></a>
Example in Demo Server</h1>
<p>The demo server provides an example of the temporary file transfer for reading a parameterized file, without returning a state machine, since the generation is fast.</p>
<h2><a class="anchor" id="L3ServerTuDemoServerTempFileTrans_Example_CreateObj"></a>
Creating an Object</h2>
<p>The creation of an instance can be found in UnifiedAutomation.Demo.DemoNodeManager.SpecialTemporaryFileTransfer.cs.</p>
<div class="fragment"><div class="line">        <span class="keyword">public</span> <span class="keywordtype">void</span> SetupSpecialTemporaryFileTransfer()</div>
<div class="line">        {</div>
<div class="line">            m_temporaryFiles = <span class="keyword">new</span> Dictionary&lt;TemporaryFile, uint&gt;();</div>
<div class="line"></div>
<div class="line">            CreateObjectSettings settings = <span class="keyword">new</span> CreateObjectSettings()</div>
<div class="line">            {</div>
<div class="line">                ParentNodeId = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>(Model.Objects.Demo_Files, DefaultNamespaceIndex),</div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a9bafec980b0e46918f646fa8019b577ba738520b2dcbb7dbb2c8d33096387aef8">ReferenceTypeId</a> = ReferenceTypeIds.Organizes,</div>
<div class="line">                RequestedNodeId = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>(<span class="stringliteral">&quot;Demo.Files.TempFile&quot;</span>, DefaultNamespaceIndex),</div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a9bafec980b0e46918f646fa8019b577ba50eebb9e969077ded08eed61ad9a5f0a">BrowseName</a> = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328ab4a75c1b2cfd3cb752898835cad346b0">QualifiedName</a>(<span class="stringliteral">&quot;TempFile&quot;</span>, DefaultNamespaceIndex),</div>
<div class="line">                TypeDefinitionId = ObjectTypeIds.TemporaryFileTransferType,</div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a2d87c494cd1d1d040a4b83fc16615dc1ab5a7adde1af5c87d7fd797b6245c2a39">Description</a> = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a26889eee67d7ccc649f6188d0c20ad2b">LocalizedText</a>(<span class="stringliteral">&quot;This object can be used to generate a temporary file on the server to &quot;</span> +</div>
<div class="line">                    <span class="stringliteral">&quot;provide information to the client. The temporary file is deleted after a time period defined in &quot;</span> +</div>
<div class="line">                    <span class="stringliteral">&quot;\&quot;ClientProcessingTimeout\&quot; of non-use, or if the client closes the file.&quot;</span>),</div>
<div class="line">                ChildrenSettings =</div>
<div class="line">                {</div>
<div class="line">                    <span class="keyword">new</span> ChildVariableSettings()</div>
<div class="line">                    {</div>
<div class="line">                        BrowsePath =</div>
<div class="line">                        {</div>
<div class="line">                            BrowseNames.GenerateFileForRead,</div>
<div class="line">                            BrowseNames.InputArguments</div>
<div class="line">                        },</div>
<div class="line">                        Value = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a492f18b60811bf85ce118c0c6a1a5c4a">Variant</a>(<span class="keyword">new</span> List&lt;ExtensionObject&gt;()</div>
<div class="line">                        {</div>
<div class="line">                            <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a1adf19f65f9aa28f3b51d77b73f6b688">ExtensionObject</a>(<span class="keyword">new</span> Argument()</div>
<div class="line">                            {</div>
<div class="line">                                Name = <span class="stringliteral">&quot;GenerateOptions&quot;</span>,</div>
<div class="line">                                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a2d87c494cd1d1d040a4b83fc16615dc1a984b29a2ca83266dd2898a0a548b2c9f">ValueRank</a> = ValueRanks.Scalar,</div>
<div class="line">                                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a2d87c494cd1d1d040a4b83fc16615dc1aaa2aaa59ac1a7c24e5e86c068bda3d20">DataType</a> = DataTypeIds.String</div>
<div class="line">                            })</div>
<div class="line">                        })</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            };</div>
<div class="line"></div>
<div class="line">            var objectNode = CreateObject(<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a4ee1c62aa1346abfd54798f6d167a766a9aa1b03934893d7134a660af4204f2a9">Server</a>.DefaultRequestContext, settings);</div>
<div class="line">            var objectImplementation = <span class="keyword">new</span> TemporaryFileTransferModel();</div>
<div class="line"></div>
<div class="line">            objectImplementation.TemporaryFileTransferMethods = <span class="keyword">this</span>;</div>
<div class="line">            objectImplementation.ClientProcessingTimeout = 10000; <span class="comment">// important to set, if default (0) it will not work</span></div>
<div class="line"></div>
<div class="line">            LinkModelToNode(objectNode.NodeId, objectImplementation, null, null, 100);</div>
<div class="line">        }</div>
</div><!-- fragment --><p> When creating the instance the DataType of the argument "GenerateOptions" is set to <code>String</code>. This is done by setting the <code>ChildInstanceSettings</code> at the <code>CreateObjectSettings</code>.</p>
<p>The <code>DemoManager</code> calls the <code>SetupSpecialTemporaryFileTransfer</code> method during startup which creates the object <code>TempFile</code> under <em>Root -&gt; Objects -&gt; Demo -&gt; 014_Files</em>. You can access this object with the UaExpert and right click and select <em>Read to local file ...</em> to try out the mechanism.</p>
<h2><a class="anchor" id="L3ServerTuDemoServerTempFileTrans_Example_ImplMeth"></a>
Implementation of methods</h2>
<p>The implementation of the methods can be found in <code>Demo\DemoNodeManager.SpecialTemporaryFileTransfer.cs</code>. The implementation of <code>GenerateFileForRead</code> is actually creating a local text file taking the <code>generateOptions</code> string as content and uses the <code>FileModel</code> as base to manage it as object in the server.</p>
<div class="fragment"><div class="line">        <span class="keyword">public</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a72381d4605940627a6e846d5f3155c51">StatusCode</a> GenerateFileForRead(RequestContext context,</div>
<div class="line">                                              TemporaryFileTransferModel model,</div>
<div class="line">                                              Variant GenerateOptions,</div>
<div class="line">                                              out NodeId FileNodeId,</div>
<div class="line">                                              out uint FileHandle,</div>
<div class="line">                                              out NodeId CompletionStateMachine)</div>
<div class="line">        {</div>
<div class="line">            var fileModel = CreateFile(GenerateOptions.ToString(), (int)model.ClientProcessingTimeout, context.Session, out FileNodeId);</div>
<div class="line">            fileModel.Open(context, fileModel, (byte)<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a769000a8da22e528a1830197cf1bcd3c">FileAccessModes</a>.Read, out FileHandle);</div>
<div class="line">            fileModel.Timeout += FileModel_Timeout;</div>
<div class="line">            fileModel.Closed += FileModel_Closed;</div>
<div class="line"></div>
<div class="line">            CompletionStateMachine = null; <span class="comment">// we can directly generate the file so we do not need this state machine</span></div>
<div class="line"></div>
<div class="line">            m_temporaryFiles.Add(fileModel, FileHandle);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> StatusCodes.Good;</div>
<div class="line">        }</div>
</div><!-- fragment --><p> This is just used for demonstration purposes, in a real application you would generate something more reasonable. When the transfer is completed and the client closes the file, the server removes the temporary file object and deletes the temporary file created on disk.</p>
<div class="fragment"><div class="line">        <span class="keyword">private</span> <span class="keywordtype">void</span> DeleteFile(TemporaryFile model)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1a407c654cca7785fb6370070249154d54">DeleteNode</a>(<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a4ee1c62aa1346abfd54798f6d167a766a9aa1b03934893d7134a660af4204f2a9">Server</a>.DefaultRequestContext, model.UserData as NodeId, <span class="keyword">true</span>);</div>
<div class="line">            m_temporaryFiles.Remove(model);</div>
<div class="line">            model.FileOnDisk.Delete();</div>
<div class="line">            model.Dispose();</div>
<div class="line">        }</div>
</div><!-- fragment --> <h2><a class="anchor" id="L3ServerTuDemoServerTempFileTrans_Example_Timeout"></a>
Timeout</h2>
<p>The temporary file transfer object defines a timeout (<code>ClientProcessingTimeout</code>). When the client is not accessing the file for the duration of the timeout, the server is supposed to remove the temporary file. The timeout is defined when creating the object.</p>
<div class="fragment"><div class="line">ObjectImplementation.ClientProcessingTimeout = 10000; <span class="comment">// important to set, if default (0) it will not work</span></div>
</div><!-- fragment --><p>The implementation resets the timeout each time the file is accessed (typically by calling the Read method).</p>
<div class="fragment"><div class="line">            <span class="keyword">public</span> <span class="keyword">override</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a72381d4605940627a6e846d5f3155c51">StatusCode</a> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a769000a8da22e528a1830197cf1bcd3ca7a1a5f3e79fdc91edf2f5ead9d66abb4">Read</a>(RequestContext context, FileModel model, uint fileHandle, <span class="keywordtype">int</span> length, out byte[] data)</div>
<div class="line">            {</div>
<div class="line">                ResetTimer();</div>
<div class="line">                <span class="keywordflow">return</span> base.Read(context, model, fileHandle, length, out data);</div>
<div class="line">            }</div>
</div><!-- fragment --><p> If the timeout is hit, it removes the temporary file object and deletes the file created on disk.</p>
<div class="fragment"><div class="line">        <span class="keyword">private</span> <span class="keywordtype">void</span> FileModel_Timeout(TemporaryFile model, EventArgs e)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// if running into timeout, file probably needs to be closed first</span></div>
<div class="line">            <span class="keywordflow">try</span></div>
<div class="line">            {</div>
<div class="line">                model.CloseFile(<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a4ee1c62aa1346abfd54798f6d167a766a9aa1b03934893d7134a660af4204f2a9">Server</a>.DefaultRequestContext, m_temporaryFiles[model]);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">catch</span> (Exception) { }</div>
<div class="line">            <span class="keywordflow">finally</span></div>
<div class="line">            {</div>
<div class="line">                DeleteFile(model);</div>
<div class="line">            }</div>
<div class="line">        }</div>
</div><!-- fragment --></div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="L1ServerTutorials.html">Tutorials for Server development</a></li><li class="navelem"><a class="el" href="L2ServerTutDemoServer.html">.NET SDK Demo Server</a></li>
    <li class="footer">&copy; Unified Automation GmbH - All rights reserved.</li>
  </ul>
</div>
</body>
</html>
