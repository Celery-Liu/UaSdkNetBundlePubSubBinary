<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>.NET Based OPC UA Client/Server/PubSub SDK: Connect – Authentication</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="header_inner_inner_bg2.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">.NET Based OPC UA Client/Server/PubSub SDK
   &#160;<span id="projectnumber">4.1.0.556</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('L3ClientTutExample27.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Events</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Connect – Authentication </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#L4ClientTutExample27Pre">Prerequisites</a></li>
<li class="level1"><a href="#L4ClientTutExample27Desc">Description</a></li>
<li class="level1"><a href="#L4ClientTutExample27Code">Sample Code</a><ul><li class="level2"><a href="#L4ClientTutExample27Code_v1">Anonymous</a></li>
<li class="level2"><a href="#L4ClientTutExample27Code_v2">User Name and Password</a></li>
<li class="level2"><a href="#L4ClientTutExample27Code_v3">X.509 Certificate and File Based Certificate Store</a></li>
<li class="level2"><a href="#L4ClientTutExample27Code_v4">X.509 Certificate and Windows Certificate Store</a></li>
<li class="level2"><a href="#L4ClientTutExample27Code_v5">InsecureCredicals EventHandler</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="L4ClientTutExample27Pre"></a>
Prerequisites</h1>
<p>This example does only show different user authentication mechanisms, including certificate based authentification, but not how to create and trust certificates.</p>
<p>This dialog manages the Session that is used for the dialogs for Session services (e.g. Read) and Subscription services (e.g. CreateMonitoredItems).</p>
<p>To use authentification with certificates, it is needed to create a client certificate first. You can test the variant using the file based certificate store out-of-the-box, because an Application Instance Certificate for the ClientGettingStarted application is created automatically when installing the SDK. For simplicity, the example uses this certificate for authentication as well. Example code for creating a certificate to be used in a file based certificate store is described in <a class="el" href="L3ClientTutExample3.html">Certificate Management – Create Certificate</a>.</p>
<p>Furthermore, it is necessary that client and server already trust each other’s certificate. You can use the <a class="el" href="L3ClientTutExample5.html">Simple Connect</a> or the <a class="el" href="L3ClientTutExample26.html">Advanced Connect</a> example and connect with security. Be sure to check the box “Save Certificate in TrustList” when trusting the server’s certificate.</p>
<h1><a class="anchor" id="L4ClientTutExample27Desc"></a>
Description</h1>
<p>The following dialog shows an example for implementing different types of user Authentication. Press the button “Show Code” to display the corresponding code, and the button “Help” to show this documentation page.</p>
<div class="image">
<img src="clienttutorials_authentication.png" alt="clienttutorials_authentication.png"/>
</div>
<p>The example demonstrates four different authentication settings:</p>
<dl>
<dt>Anonymous</dt>
<dd>Connect as anonymous user </dd>
<dt>UserName</dt>
<dd>User name and password based authentication </dd>
<dt>X509 (Dir)</dt>
<dd>Authentication using X.509 certificates and a file based certificate store </dd>
<dt>X509 (Store)</dt>
<dd>Authentication using X.509 certificates and the Windows certificate store </dd>
</dl>
<p>Check the radio button in front of the authentication method of your choice, fill in the required fields, and press “Connect”.</p>
<p>To test the <b>UserName</b> variant, enter the user name “sue” and password “curly” to the respective input fields.</p>
<div class="image">
<img src="clienttutorials_authentication_2.png" alt="clienttutorials_authentication_2.png"/>
</div>
<p>For the <b>X509 (Dir)</b> variant, press the “…” button and select the certificate for the ClientGettingStarted application (see <a class="el" href="L3ClientTutExample27.html#L4ClientTutExample27Pre">above</a>). The example requires to select the certificate containing the private key (i.e. the .pfx file, see screenshot). Note that the private key is only used for signing and will <em>not</em> be sent to the server.</p>
<div class="image">
<img src="clienttutorials_authentication_3.png" alt="clienttutorials_authentication_3.png"/>
</div>
<p>To actually establish a connection, client and server have to trust each other’s certificates first (see <a class="el" href="L3ClientTutExample27.html#L4ClientTutExample27Pre">above</a>).</p>
<p>To use the Windows certificate store instead, choose <b>X509 (Store)</b>. The fields “Store Path” and “Certificate” are already filled with standard values, change them to your liking. As in the example above, it is necessary to create a certificate for the ClientGettingStarted application first and client and server have to trust each other’s certificates.</p>
<p>If the checkbox “Use InsecureCredentials EventHandler” is checked, an EventHandler for <a class="el" href="classUnifiedAutomation_1_1UaClient_1_1Session.html#ab9d3e54d2c1ec6b08ebebc377a711aa2">Session.InsecureCredicals</a> is added. The checkbox is grayed out unless “Use Asynchronous Pattern” is checked, since a dialog will be displayed in this implementation of the EventHandler (see screenshot).</p>
<div class="image">
<img src="clienttutorials_authentication_5.png" alt="clienttutorials_authentication_5.png"/>
</div>
<p>This EventHandler can be used to connect with user name and password to a server although the password is sent insecurely, e.g.</p>
<ul>
<li>too little random data of the server,</li>
<li>no encrytion algorithm is available to encrypt the password.</li>
</ul>
<p>After a sucessful connect, the user identity is shown in the “Session” tab of the .NET Demo Server GUI (see screenshot).</p>
<div class="image">
<img src="clienttutorials_authentication_4.png" alt="clienttutorials_authentication_4.png"/>
</div>
<h1><a class="anchor" id="L4ClientTutExample27Code"></a>
Sample Code</h1>
<p>The user token specific code can be found in the method SetUserToken().</p>
<h2><a class="anchor" id="L4ClientTutExample27Code_v1"></a>
Anonymous</h2>
<p>To connect as anonymous user, UserIdentityType has to be set to <em>Anonymous</em>.</p>
<div class="fragment"><div class="line">            <span class="keywordflow">if</span> (AnonymousButton.Checked)</div>
<div class="line">            {</div>
<div class="line">                m_session.UserIdentity.IdentityType = <a class="code" href="namespaceUnifiedAutomation_1_1UaClient.html#ac98fcaa9c6e172d22185f10c51d9a377">UserIdentityType</a>.Anonymous;</div>
<div class="line">            }</div>
</div><!-- fragment --> <h2><a class="anchor" id="L4ClientTutExample27Code_v2"></a>
User Name and Password</h2>
<p>To authenticate with user name and password, set the UserIdentityType to <em>UserName</em>.</p>
<div class="fragment"><div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (UserNameButton.Checked)</div>
<div class="line">            {</div>
<div class="line">                m_session.UserIdentity.IdentityType = <a class="code" href="namespaceUnifiedAutomation_1_1UaClient.html#ac98fcaa9c6e172d22185f10c51d9a377">UserIdentityType</a>.UserName;</div>
<div class="line">                m_session.UserIdentity.UserName = UserName_Name.Text;</div>
<div class="line">                m_session.UserIdentity.Password = UserName_Password.Text;</div>
<div class="line">            }</div>
</div><!-- fragment --> <h2><a class="anchor" id="L4ClientTutExample27Code_v3"></a>
X.509 Certificate and File Based Certificate Store</h2>
<p>To authenticate using an X.509 certificate, set the UserIdentityType to <em>Certificate</em>.</p>
<p><a class="el" href="classUnifiedAutomation_1_1UaBase_1_1SecurityUtils.html">UnifiedAutomation.UaBase.SecurityUtils</a></p>
<div class="fragment"><div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (X509Button.Checked)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">try</span></div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// Add the certificate to the user identity.</span></div>
<div class="line">                    m_session.UserIdentity.Certificate = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#af559c045bfc95472b62792ce00f0d6a5aeb0f48a107df1a0f343d4cd513b555e6">Certificate</a>.LoadPrivateKey(X509_Certificate.Text, null);</div>
<div class="line"></div>
<div class="line">                    <span class="comment">// Set the UserIdentityType.</span></div>
<div class="line">                    m_session.UserIdentity.IdentityType = <a class="code" href="namespaceUnifiedAutomation_1_1UaClient.html#ac98fcaa9c6e172d22185f10c51d9a377">UserIdentityType</a>.Certificate;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">catch</span> (Exception ex)</div>
<div class="line">                {</div>
<div class="line">                    ExceptionDlg.ShowInnerException(this.Text, ex);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
</div><!-- fragment --> <h2><a class="anchor" id="L4ClientTutExample27Code_v4"></a>
X.509 Certificate and Windows Certificate Store</h2>
<p>To authenticate using an X.509 certificate, set the UserIdentityType to <em>Certificate</em>.</p>
<p><a class="el" href="classUnifiedAutomation_1_1UaBase_1_1SecurityUtils.html">UnifiedAutomation.UaBase.SecurityUtils</a></p>
<div class="fragment"><div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (X509StoreButton.Checked)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">try</span></div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// Create the certificate store.</span></div>
<div class="line">                    <span class="keyword">using</span> (ICertificateStore store = SecurityUtils.CreateStore(m_application.SecurityProvider, X509StorePath.Text.Trim()))</div>
<div class="line">                    {</div>
<div class="line">                        <span class="comment">// Load the certificate.</span></div>
<div class="line">                        ICertificate certificate = store.Find(X509StoreCertificate.Text.Trim(), null, <span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">                        <span class="comment">// If the certificate could not be found, try to find the certificate without a</span></div>
<div class="line">                        <span class="comment">// private key. This allows to use a more helpful exception message.</span></div>
<div class="line">                        <span class="keywordflow">if</span> (certificate == null)</div>
<div class="line">                        {</div>
<div class="line">                            certificate = store.Find(X509StoreCertificate.Text.Trim(), null, <span class="keyword">false</span>);</div>
<div class="line"></div>
<div class="line">                            <span class="keywordflow">if</span> (certificate != null)</div>
<div class="line">                            {</div>
<div class="line">                                <span class="keywordflow">throw</span> <span class="keyword">new</span> ArgumentException(<span class="stringliteral">&quot;The Certificate must have an accessible private key.&quot;</span>);</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">else</span></div>
<div class="line">                            {</div>
<div class="line">                                <span class="keywordflow">throw</span> <span class="keyword">new</span> ArgumentException(<span class="stringliteral">&quot;The Certificate does not exist.&quot;</span>);</div>
<div class="line">                            }</div>
<div class="line">                        }</div>
<div class="line"></div>
<div class="line">                        <span class="comment">// Add the certificate to the user identity.</span></div>
<div class="line">                        m_session.UserIdentity.Certificate = certificate;</div>
<div class="line"></div>
<div class="line">                        <span class="comment">// Set the UserIdentityType.</span></div>
<div class="line">                        m_session.UserIdentity.IdentityType = <a class="code" href="namespaceUnifiedAutomation_1_1UaClient.html#ac98fcaa9c6e172d22185f10c51d9a377">UserIdentityType</a>.Certificate;</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">catch</span> (Exception ex)</div>
<div class="line">                {</div>
<div class="line">                    ExceptionDlg.ShowInnerException(this.Text, ex);</div>
<div class="line">                }</div>
<div class="line">            }</div>
</div><!-- fragment --> <h2><a class="anchor" id="L4ClientTutExample27Code_v5"></a>
InsecureCredicals EventHandler</h2>
<p>Implement the EventHandler.</p>
<div class="fragment"><div class="line">        <span class="keywordtype">void</span> OnInsecureCredentials(Session sender, InsecureCredentialsEventArgs e)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// need to make sure the results are processed on the correct thread.</span></div>
<div class="line">            <span class="keywordflow">if</span> (InvokeRequired)</div>
<div class="line">            {</div>
<div class="line">                Invoke(<span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaClient.html#a5814cc3dc1aada46494fa0e060ca69f7">InsecureCredentialsEventHandler</a>(OnInsecureCredentials), sender, e);</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            InsecureCredentialsDialog dialog = <span class="keyword">new</span> InsecureCredentialsDialog();</div>
<div class="line">            dialog.ShowDialog(m_session, e);</div>
<div class="line">            <span class="comment">// Set AllowInsecureCredentials to true if the risk is accepted.</span></div>
<div class="line">            <span class="keywordflow">if</span> (dialog.DialogResult == DialogResult.OK)</div>
<div class="line">            {</div>
<div class="line">                e.AllowInsecureCredentials = <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                e.AllowInsecureCredentials = <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
</div><!-- fragment --><p> Add the EventHandler to the Session.</p>
<div class="fragment"><div class="line">                m_session.InsecureCredentials += OnInsecureCredentials;</div>
</div><!-- fragment --></div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="L1ClientTutorials.html">Tutorials for Client development</a></li><li class="navelem"><a class="el" href="L2ClientTutExamples.html">Getting Started</a></li>
    <li class="footer">&copy; Unified Automation GmbH - All rights reserved.</li>
  </ul>
</div>
</body>
</html>
