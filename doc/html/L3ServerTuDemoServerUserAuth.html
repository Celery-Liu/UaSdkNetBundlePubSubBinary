<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>.NET Based OPC UA Client/Server/PubSub SDK: User Authentication</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="header_inner_inner_bg2.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">.NET Based OPC UA Client/Server/PubSub SDK
   &#160;<span id="projectnumber">4.1.0.556</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('L3ServerTuDemoServerUserAuth.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Events</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">User Authentication </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#DemoServerExampleUserLogon_AnonymousIdentityToken">AnonymousIdentityToken</a></li>
<li class="level1"><a href="#DemoServerExampleUserLogon_UserNameIdentityToken">UserNameIdentityToken</a></li>
<li class="level1"><a href="#DemoServerExampleUserLogon_X509IdentityToken">X509IdentityToken</a></li>
<li class="level1"><a href="#DemoServerExampleUserLogon_Alternatives">Alternative User Logon</a><ul><li class="level2"><a href="#DemoServerExampleUserLogon_Alternatives_LocalMachineLogon">Logon with Username and Password of the Local Machine</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>This following section shows how the User validation is done by the .NET Demo Server. It gives an overview of the supported UserIdentityToken types. The complete source code can be found in the VisualStudio solution for the Demo Server (file TestServerManager.cs).</p>
<h1><a class="anchor" id="DemoServerExampleUserLogon_AnonymousIdentityToken"></a>
AnonymousIdentityToken</h1>
<p>The support for AnonymousIdentityTokens must only be enabled in the UserIdentitySettings that are part of the ServerSettings. </p><div class="fragment"><div class="line">&lt;EnableAnonymous&gt;<span class="keyword">true</span>&lt;/EnableAnonymous&gt;</div>
</div><!-- fragment --><h1><a class="anchor" id="DemoServerExampleUserLogon_UserNameIdentityToken"></a>
UserNameIdentityToken</h1>
<p>The support for UserNameIdentityTokens must be enabled in the UserIdentitySettings that are part of the ServerSettings. </p><div class="fragment"><div class="line">&lt;EnableUserName&gt;<span class="keyword">true</span>&lt;/EnableUserName&gt;</div>
</div><!-- fragment --><p>The DemoServer handles incoming UserNameIdentityToken with the SDKs internal file based <a class="el" href="L2ServerSdkServerUserManagement.html#L3ServerSdkIUserManager">IUserManager</a> interface implementation.</p>
<p>This will be enabled by setting the UserManagement in the UserIdentity section of the ServerSettings extension. </p><div class="fragment"><div class="line">&lt;UserManagement FilePath=<span class="stringliteral">&quot;%CommonApplicationData%\unifiedautomation\UaSdkNet\Configuration\DemoServerUserConfiguration.xml&quot;</span>&gt;</div>
<div class="line">  &lt;MinPasswordLength&gt;3&lt;/MinPasswordLength&gt;</div>
<div class="line">  &lt;MaxPasswordLength&gt;0&lt;/MaxPasswordLength&gt;</div>
<div class="line">  &lt;PasswordOptions&gt;21&lt;/PasswordOptions&gt;</div>
<div class="line">  &lt;PasswordRestrictions Locale=<span class="stringliteral">&quot;de-DE&quot;</span> Text=<span class="stringliteral">&quot;Der Server unterstuetzt Benutzer Beschreibungen sowie die Moeglichkeit das Loeschen von Benutzern zu verhindern.&quot;</span> /&gt;</div>
<div class="line">  &lt;PasswordRestrictions Locale=<span class="stringliteral">&quot;en-US&quot;</span> Text=<span class="stringliteral">&quot;The server supports user descriptions as well as the option to disable the deletion of users.&quot;</span> /&gt;</div>
<div class="line">&lt;/UserManagement&gt;</div>
</div><!-- fragment --><p> For a deeper look in how to configure the UserManagement look <a class="el" href="L2ServerSdkServerUserManagement.html#L3FileBasedUserManagement">here</a>. <br />
 <br />
 The Server provides a set of Users that are stored in the DemoServerUserConfiguration.xml file.</p>
<table class="doxtable">
<tr>
<th>UserName </th><th>Password  </th></tr>
<tr>
<td>john </td><td>master </td></tr>
<tr>
<td>joe </td><td>god </td></tr>
<tr>
<td>sue </td><td>curly </td></tr>
<tr>
<td>root </td><td>secret </td></tr>
</table>
<p>The access rights for this users will be configured in the <a class="el" href="L3ServerTuDemoServerAssignAccess.html#L3ServerTuDemoServerAssignAccess_AssignUsersToRole">RoleConfiguration</a>.</p>
<h1><a class="anchor" id="DemoServerExampleUserLogon_X509IdentityToken"></a>
X509IdentityToken</h1>
<p>The support for X509IdentityTokens must be enabled in the UserIdentitySettings that are part of the ServerSettings.</p>
<div class="fragment"><div class="line">&lt;EnableCertificate&gt;<span class="keyword">true</span>&lt;/EnableCertificate&gt;</div>
</div><!-- fragment --><p>If UserTrustedCertificateStore and UserIssuerCertificateStore are configured, a CertificateValidator for user certificates is created by the ServerManager. This UserCertificateValidator will be used by the SessionManager to validate incoming X509IdentityTokens. </p><div class="fragment"><div class="line">&lt;UserTrustedCertificateStore&gt;%CommonApplicationData%\unifiedautomation\UaSdkNet\pkiuser\trusted&lt;/UserTrustedCertificateStore&gt;</div>
<div class="line">&lt;UserIssuerCertificateStore&gt;%CommonApplicationData%\unifiedautomation\UaSdkNet\pkiuser\issuers&lt;/UserIssuerCertificateStore&gt;</div>
<div class="line">&lt;UserRejectedCertificateStore&gt;%CommonApplicationData%\unifiedautomation\UaSdkNet\pkiuser\rejected&lt;/UserRejectedCertificateStore&gt;</div>
</div><!-- fragment --><p>If UserTrustedCertificateStore and UserIssuerCertificateStore are not configured, a UserCertificateValidator must be created by the application.</p>
<p>The EventHandler <a class="el" href="classUnifiedAutomation_1_1UaServer_1_1ServerManager.html#a8e1a323707ed9aaacf8b9267fa9f2dc7">ServerManager.UntrustedUserCertificate</a> gets called if a user certificate is not trusted or has validation errors. This EventHandler is not implemented in this example.</p>
<h1><a class="anchor" id="DemoServerExampleUserLogon_Alternatives"></a>
Alternative User Logon</h1>
<p>To use an alternative validation method, implement the IdentityValidationCompletedEventHandler. This will be called after all UserIdenityToken types were checked by the SDK.</p>
<div class="fragment"><div class="line">            this.SessionManager.IdentityValidationCompleted += <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaServer.html#a9b2aa22e2bac49e365115c2a9718f0bd">IdentityValidationCompletedEventHandler</a>(SessionManager_IdentityValidationCompleted);</div>
</div><!-- fragment --><p> and</p>
<div class="fragment"><div class="line">        <span class="keyword">private</span> <span class="keywordtype">void</span> SessionManager_IdentityValidationCompleted(Session session, ImpersonateEventArgs args)</div>
</div><!-- fragment --><p> Changes to the IdentityValidationCompletedEventHandler.IdentityValidationError will override the internal validation results.</p>
<h2><a class="anchor" id="DemoServerExampleUserLogon_Alternatives_LocalMachineLogon"></a>
Logon with Username and Password of the Local Machine</h2>
<p>The following code snippets placed in the EventHandler, show how to use username and password of the local windows installation for server logon.</p>
<div class="fragment"><div class="line">            UserNameIdentityToken userNameToken = args.NewIdentity as UserNameIdentityToken;</div>
<div class="line">            <span class="keywordflow">if</span> (userNameToken != null)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a27118326006d3829667a400ad23d5d98">String</a>.IsNullOrEmpty(userNameToken.UserName))</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">return</span>;</div>
<div class="line">                }</div>
<div class="line">           </div>
<div class="line">                <span class="keywordflow">if</span> (args.Identity == null || <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a72381d4605940627a6e846d5f3155c51">StatusCode</a>.IsBad(args.IdentityValidationError))</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">try</span></div>
<div class="line">                    {</div>
<div class="line">                        args.IdentityValidationError = LogonUser(userNameToken);</div>
<div class="line">                        args.EffectiveIdentity = <span class="keyword">new</span> UserIdentity(userNameToken);</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">catch</span> (StatusException e)</div>
<div class="line">                    {</div>
<div class="line">                        args.IdentityValidationError = e.StatusCode;     </div>
<div class="line">                    }</div>
<div class="line">                }</div>
</div><!-- fragment --> <div class="fragment"><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class </span>Win32</div>
<div class="line">        {</div>
<div class="line">            [DllImport(<span class="stringliteral">&quot;advapi32.dll&quot;</span>, SetLastError = <span class="keyword">true</span>, CharSet = CharSet.Unicode)]</div>
<div class="line">            <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keywordtype">bool</span> LogonUser(</div>
<div class="line">                <span class="keywordtype">string</span> lpszUsername,</div>
<div class="line">                <span class="keywordtype">string</span> lpszDomain,</div>
<div class="line">                <span class="keywordtype">string</span> lpszPassword,</div>
<div class="line">                <span class="keywordtype">int</span> dwLogonType,</div>
<div class="line">                <span class="keywordtype">int</span> dwLogonProvider,</div>
<div class="line">                ref IntPtr phToken);</div>
<div class="line"></div>
<div class="line">            [DllImport(<span class="stringliteral">&quot;kernel32.dll&quot;</span>, CharSet = CharSet.Auto)]</div>
<div class="line">            <span class="keyword">public</span> <span class="keyword">extern</span> <span class="keyword">static</span> <span class="keywordtype">bool</span> CloseHandle(IntPtr handle);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keyword">private</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a72381d4605940627a6e846d5f3155c51">StatusCode</a> LogonUser(UserNameIdentityToken identity)</div>
<div class="line">        {</div>
<div class="line">            IntPtr handle = IntPtr.Zero;</div>
<div class="line"></div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">int</span> LOGON32_PROVIDER_DEFAULT = 0;</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">int</span> LOGON32_LOGON_NETWORK = 3;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">try</span></div>
<div class="line">            {</div>
<div class="line">                <span class="keywordtype">bool</span> result = Win32.LogonUser(</div>
<div class="line">                identity.UserName,</div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a27118326006d3829667a400ad23d5d98">String</a>.Empty,</div>
<div class="line">                identity.DecryptedPassword,</div>
<div class="line">                LOGON32_LOGON_NETWORK,</div>
<div class="line">                LOGON32_PROVIDER_DEFAULT,</div>
<div class="line">                ref handle);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (!result)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">return</span> StatusCodes.BadUserAccessDenied;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">return</span> StatusCodes.Good;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">catch</span> (Exception)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> StatusCodes.BadUserAccessDenied;</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">        }</div>
</div><!-- fragment --></div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="L1ServerTutorials.html">Tutorials for Server development</a></li><li class="navelem"><a class="el" href="L2ServerTutDemoServer.html">.NET SDK Demo Server</a></li>
    <li class="footer">&copy; Unified Automation GmbH - All rights reserved.</li>
  </ul>
</div>
</body>
</html>
