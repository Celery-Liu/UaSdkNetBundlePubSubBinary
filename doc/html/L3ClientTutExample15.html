<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>.NET Based OPC UA Client/Server/PubSub SDK: History Read – History Read Processed</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="header_inner_inner_bg2.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">.NET Based OPC UA Client/Server/PubSub SDK
   &#160;<span id="projectnumber">4.1.0.556</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('L3ClientTutExample15.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Events</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">History Read – History Read Processed </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#L4ClientTutExample15Pre">Prerequisites</a></li>
<li class="level1"><a href="#L4ClientTutExample15Desc">Description</a></li>
<li class="level1"><a href="#L4ClientTutExample15Code">Sample Code</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="L4ClientTutExample15Pre"></a>
Prerequisites</h1>
<p>A session with the server must be established.</p>
<h1><a class="anchor" id="L4ClientTutExample15Desc"></a>
Description</h1>
<p>The following dialog shows an example implementation of the History Read service with data processing.</p>
<p>The input field “Variable” is filled beforehand with the NodeId of a variable with history available. Press the button “…” to open a browse window or fill in another NodeId manually.</p>
<div class="image">
<img src="clienttutorials_history_read_processed.png" alt="clienttutorials_history_read_processed.png"/>
</div>
<p>The dialog window has additional input fields for the start time, the number of values to calculate, and the processing interval. The drop down box “Aggregate Type” list all aggregate functions supported by the server the client is currently connected to.</p>
<p>When pressing the button “Read Values”, the HistoryReadProcessed service is called an the values are displayed in the table. When checking “Use Asynchronous Pattern”, BeginHistoryReadProcessed is called instead.</p>
<div class="image">
<img src="clienttutorials_history_read_processed2.png" alt="clienttutorials_history_read_processed2.png"/>
</div>
<p>Press the button “Show Code” to display the corresponding code, and the button “Help” to show this documentation page.</p>
<h1><a class="anchor" id="L4ClientTutExample15Code"></a>
Sample Code</h1>
<p>The following code reads the historical data for a variable in a specified time range. It displays a list of aggregated values, calculated from the history of the variable using the given processing interval and aggregate calculation.</p>
<ul>
<li><a class="el" href="classUnifiedAutomation_1_1UaClient_1_1Session.html">UaClient.Session</a></li>
<li><a class="el" href="classUnifiedAutomation_1_1UaClient_1_1Session.html#a6418ff968d022825449895d9439ac107">UaClient.Session.HistoryReadRaw</a></li>
<li><a class="el" href="classUnifiedAutomation_1_1UaBase_1_1ReadProcessedDetails.html">UaBase.ReadProcessedDetails</a></li>
<li><a class="el" href="classUnifiedAutomation_1_1UaBase_1_1HistoryReadValueId.html">UaBase.HistoryReadValueId</a></li>
<li><a class="el" href="classUnifiedAutomation_1_1UaClient_1_1RequestSettings.html">UaClient.RequestSettings</a></li>
</ul>
<p>In a first step, the client checks which AggregateFunctions the connected server supports. The supported AggregateFunctions are referenced by a well-defined node, so we can use the Browse service for this task. The found AggregateFunctions are added to the ComboBox.</p>
<div class="fragment"><div class="line">        <span class="keyword">private</span> List&lt;ReferenceDescription&gt; FindAvailableAggregates()</div>
<div class="line">        {</div>
<div class="line">            BrowseContext context = <span class="keyword">new</span> BrowseContext();</div>
<div class="line">            context.ReferenceTypeId = ReferenceTypeIds.HierarchicalReferences;</div>
<div class="line">            context.IncludeSubtypes = <span class="keyword">true</span>;</div>
<div class="line">            context.BrowseDirection = BrowseDirection.Forward;</div>
<div class="line">            context.NodeClassMask = 0;</div>
<div class="line">            context.ResultMask = (uint)(<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a9bafec980b0e46918f646fa8019b577b">BrowseResultMask</a>.DisplayName | <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a9bafec980b0e46918f646fa8019b577b">BrowseResultMask</a>.BrowseName | <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a9bafec980b0e46918f646fa8019b577b">BrowseResultMask</a>.TypeDefinition);</div>
<div class="line"></div>
<div class="line">            byte[] continuationPoint = null;</div>
<div class="line">            List&lt;ReferenceDescription&gt; references = m_parent.Session.Browse(ObjectIds.HistoryServerCapabilities_AggregateFunctions, context, out continuationPoint);</div>
<div class="line"></div>
<div class="line">            List&lt;ReferenceDescription&gt; aggregates = <span class="keyword">new</span> List&lt;ReferenceDescription&gt;();</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii = 0; ii &lt; references.Count; ii++)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> (m_parent.Session.Cache.IsTypeOf(references[ii].TypeDefinition, ObjectTypeIds.AggregateFunctionType))</div>
<div class="line">                {</div>
<div class="line">                    aggregates.Add(references[ii]);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> aggregates;</div>
<div class="line">        }</div>
</div><!-- fragment --><p> After clicking “Read History”, HistoryReadProcessed is called at the Session class.</p>
<div class="fragment"><div class="line">                <span class="comment">// parse the object id.</span></div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> nodeId = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>.Parse(NodeIdTB.Text);</div>
<div class="line"></div>
<div class="line">                ReadProcessedDetails details = m_details as ReadProcessedDetails;</div>
<div class="line">                HistoryReadValueIdCollection nodesToRead = <span class="keyword">new</span> HistoryReadValueIdCollection();</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (m_nodeToContinue == null)</div>
<div class="line">                {</div>
<div class="line">                    m_dataset.Tables[0].Rows.Clear();</div>
<div class="line"></div>
<div class="line">                    details = <span class="keyword">new</span> ReadProcessedDetails();</div>
<div class="line">                    details.StartTime = StartTimeDP.Value.ToUniversalTime();</div>
<div class="line">                    details.ProcessingInterval = (double)ProcessingIntervalUD.Value;</div>
<div class="line">                    details.EndTime = details.StartTime.AddMilliseconds(details.ProcessingInterval*(<span class="keywordtype">double</span>)MaxReturnValuesNP.Value);</div>
<div class="line">                    details.AggregateConfiguration = <span class="keyword">new</span> AggregateConfiguration() { UseServerCapabilitiesDefaults = <span class="keyword">true</span> };</div>
<div class="line"></div>
<div class="line">                    <span class="comment">// add one combination of a node id an aggregate type.</span></div>
<div class="line">                    nodesToRead.Add(<span class="keyword">new</span> HistoryReadValueId() { <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> = nodeId });</div>
<div class="line">                    details.AggregateType.Add(((AvailableAggregate)AggregateTypeCB.SelectedItem).NodeId);</div>
<div class="line"></div>
<div class="line">                    m_details = details;</div>
<div class="line">                    m_nodeToContinue = nodesToRead[0];</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    nodesToRead.Add(m_nodeToContinue);</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="comment">// this is a blocking call so show the wait cursor.</span></div>
<div class="line">                Cursor = Cursors.WaitCursor;</div>
<div class="line"></div>
<div class="line">                <span class="comment">// fetch the history (with a 10s timeout).</span></div>
<div class="line">                List&lt;HistoryDataReadResult&gt; results = session.HistoryReadProcessed(</div>
<div class="line">                    nodesToRead,</div>
<div class="line">                    details,</div>
<div class="line">                    <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a786f7446cd520df161222ac779c2caa9">TimestampsToReturn</a>.Source,</div>
<div class="line">                    <span class="keyword">new</span> RequestSettings() { OperationTimeout = 10000 });</div>
<div class="line"></div>
<div class="line">                <span class="comment">// check for operation error.</span></div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a72381d4605940627a6e846d5f3155c51">StatusCode</a>.IsBad(results[0].StatusCode))</div>
<div class="line">                {</div>
<div class="line">                    m_parent.ShowError(<span class="keyword">this</span>, <span class="stringliteral">&quot;Read history call failed: &quot;</span> + results[0].<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a72381d4605940627a6e846d5f3155c51">StatusCode</a>.ToString());</div>
<div class="line">                    m_details = null;</div>
<div class="line">                    m_nodeToContinue = null;</div>
<div class="line">                    <span class="keywordflow">return</span>;</div>
<div class="line">                }</div>
</div><!-- fragment --><p> The returned values are displayed in a grid view:</p>
<div class="fragment"><div class="line">        <span class="keyword">private</span> <span class="keywordtype">void</span> UpdateRow(DataRow row, DataValue value, ModificationInfo modificationInfo)</div>
<div class="line">        {</div>
<div class="line">            row[1] = value.SourceTimestamp.ToLocalTime().ToString(<span class="stringliteral">&quot;yyyy-MM-dd HH:mm:ss.fff&quot;</span>);</div>
<div class="line">            row[2] = value.ServerTimestamp.ToLocalTime().ToString(<span class="stringliteral">&quot;yyyy-MM-dd HH:mm:ss.fff&quot;</span>);</div>
<div class="line">            row[3] = value.WrappedValue;</div>
<div class="line">            row[4] = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a72381d4605940627a6e846d5f3155c51">StatusCode</a>(value.StatusCode.Code);</div>
<div class="line">            row[5] = value.StatusCode.AggregateBits.ToString();</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (modificationInfo != null)</div>
<div class="line">            {</div>
<div class="line">                row[6] = modificationInfo.UpdateType;</div>
<div class="line">                row[7] = modificationInfo.ModificationTime.ToLocalTime().ToString(<span class="stringliteral">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</div>
<div class="line">                row[8] = modificationInfo.UserName;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            row[9] = value;</div>
<div class="line">        }</div>
</div><!-- fragment --></div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="L1ClientTutorials.html">Tutorials for Client development</a></li><li class="navelem"><a class="el" href="L2ClientTutExamples.html">Getting Started</a></li>
    <li class="footer">&copy; Unified Automation GmbH - All rights reserved.</li>
  </ul>
</div>
</body>
</html>
