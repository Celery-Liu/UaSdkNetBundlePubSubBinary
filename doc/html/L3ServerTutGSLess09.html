<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>.NET Based OPC UA Client/Server/PubSub SDK: Lesson 9: Setting Access Rights Using RolePermissions and UserManagement</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="header_inner_inner_bg2.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">.NET Based OPC UA Client/Server/PubSub SDK
   &#160;<span id="projectnumber">4.1.0.556</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('L3ServerTutGSLess09.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Events</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Lesson 9: Setting Access Rights Using RolePermissions and UserManagement </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#serverlesson09_ov">Overview</a></li>
<li class="level1"><a href="#serverlesson09_configure_roles">Configure Roles</a><ul><li class="level2"><a href="#serverlesson09_example_roles">Example Roles</a></li>
<li class="level2"><a href="#serverlesson09_roles_by_file">Set Roles by File</a></li>
<li class="level2"><a href="#serverlesson09_roles_in_memory">Set Roles in Memory</a></li>
</ul>
</li>
<li class="level1"><a href="#serverlesson09_rolepermission_to_node">Setting Permissions on Nodes</a><ul><li class="level2"><a href="#serverlesson09_rolepermission_variable">Add RolePermissions to Variable</a></li>
<li class="level2"><a href="#serverlesson09_rolepermissions_method">Add RolePermissions to Method</a></li>
<li class="level2"><a href="#serverlesson09_rolepermissions_alarmandevent">Add RolePermissions to Alarms and Events</a></li>
</ul>
</li>
<li class="level1"><a href="#serverlesson09_user_management">Add User Management</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="serverlesson09_ov"></a>
Overview</h1>
<p>This example shows how to use <a class="el" href="classUnifiedAutomation_1_1UaSchema_1_1RoleConfigurations.html">RoleConfigurations</a> to set access rights to nodes and events and how to manage users added to this roles.</p>
<p>Setting access rights is splitt in two parts:</p>
<ul>
<li><a class="el" href="L3ServerTutGSLess09.html#serverlesson09_configure_roles">Configure roles</a></li>
<li><a class="el" href="L3ServerTutGSLess09.html#serverlesson09_rolepermission_to_node">Setting Permissions on Nodes</a></li>
</ul>
<p>In this lesson, the access rights are set directly in code.</p>
<dl class="section note"><dt>Note</dt><dd>Future UaModeler releases will include the ability to set these directly in the model. Once it is released, a tutorial will be available if you prefer this way of setting the access rights.</dd></dl>
<p>Another possibility to assign access rights to nodes by overriding HasAccess methods that are defined at the BaseNodeManager. Please see the <a class="el" href="L3ServerTuDemoServerAssignAccess.html">UaDemoServer example</a> for a description.</p>
<h1><a class="anchor" id="serverlesson09_configure_roles"></a>
Configure Roles</h1>
<p>First create a RoleConfiguration.xml to declare the different roles supported by your Server. We add a sample role configuration file to the project.</p>
<h2><a class="anchor" id="serverlesson09_example_roles"></a>
Example Roles</h2>
<p>This example configures 3 different roles:</p>
<ul>
<li>SecurtiyAdmin (joe)</li>
<li>Operator (john)</li>
<li>Observer (all authenticated users)</li>
</ul>
<p>A Role in the xml tree has the following structure: </p><div class="fragment"><div class="line">&lt;<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a96d16e9a0ffe0e31ca0315c51a54adcfabbbabdbe1b262f75d99d62880b953be1">Role</a> Name=<span class="stringliteral">&quot;Observer&quot;</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>=<span class="stringliteral">&quot;i=15668&quot;</span>&gt;</div>
<div class="line">  &lt;Identities&gt;</div>
<div class="line">    &lt;Identity <a class="code" href="namespaceUnifiedAutomation_1_1UaSchema.html#acbd4342d263822c75fda1cb8b9359b74">CriteriaType</a>=<span class="stringliteral">&quot;AuthenticatedUser&quot;</span> /&gt;</div>
<div class="line">  &lt;/Identities&gt;</div>
<div class="line">&lt;/<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a96d16e9a0ffe0e31ca0315c51a54adcfabbbabdbe1b262f75d99d62880b953be1">Role</a>&gt;</div>
</div><!-- fragment --><h2><a class="anchor" id="serverlesson09_roles_by_file"></a>
Set Roles by File</h2>
<p>The RoleConfiguration file will be loaded by the application at startup and needs to be set in the applications Server configuration.</p>
<p>The role configuration file will be set in the ServerSettings like this: </p><div class="fragment"><div class="line">&lt;Extension&gt;</div>
<div class="line">  &lt;ServerSettings xmlns=<span class="stringliteral">&quot;http://unifiedautomation.com/schemas/2011/12/Application.xsd&quot;</span>&gt;</div>
<div class="line">    &lt;RoleConfigurationsFilePath&gt;%CommonApplicationData%\unifiedautomation\UaSdkNet\Configuration\UaGettingStartedRoleConfiguration.xml&lt;/RoleConfigurationsFilePath&gt;</div>
<div class="line">  &lt;/ServerSettings&gt;</div>
<div class="line">&lt;/Extension&gt;</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>By default SecurityAdmins are able to modify the role configurations by calling OPC UA Methods. If the configuration changes, the configuration file is written by the sdk.<br />
When choosing the directory, note that the SDK is able to save role configurations changed at runtime back to file. The application needs write access on this directory.<br />
In our example, the role configuration file is placed in the bin directory next to the executable file. This is done only to reduce the complexity of the example.</dd></dl>
<h2><a class="anchor" id="serverlesson09_roles_in_memory"></a>
Set Roles in Memory</h2>
<p>Roles can also be set directly at the ServerManager. Override <a class="el" href="classUnifiedAutomation_1_1UaServer_1_1ServerManager.html#a389febfe028fc64196233f1c9a315814">LoadRoleConfigurations()</a> to set your own <a class="el" href="classUnifiedAutomation_1_1UaSchema_1_1RoleConfigurations.html">RoleConfigurations</a> in code.</p>
<div class="fragment"><div class="line">        <span class="keyword">protected</span> <span class="keyword">override</span> <a class="code" href="namespaceUnifiedAutomation.html">UnifiedAutomation</a>.<a class="code" href="namespaceUnifiedAutomation_1_1UaSchema.html">UaSchema</a>.<a class="code" href="classUnifiedAutomation_1_1UaSchema_1_1RoleConfigurations.html">RoleConfigurations</a> LoadRoleConfigurations()</div>
<div class="line">        {</div>
<div class="line">            var inMemoryRoleConfig = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation.html">UnifiedAutomation</a>.<a class="code" href="namespaceUnifiedAutomation_1_1UaSchema.html">UaSchema</a>.<a class="code" href="classUnifiedAutomation_1_1UaSchema_1_1RoleConfigurations.html">RoleConfigurations</a>()</div>
<div class="line">            {</div>
<div class="line">                NamespaceTable = <span class="keyword">new</span> <span class="keywordtype">string</span>[]</div>
<div class="line">                {</div>
<div class="line">                    <span class="stringliteral">&quot;http://opcfoundation.org/UA/&quot;</span></div>
<div class="line">                },</div>
<div class="line">                Roles = <span class="keyword">new</span> RoleType[]</div>
<div class="line">                {</div>
<div class="line">                    <span class="keyword">new</span> RoleType()</div>
<div class="line">                    {</div>
<div class="line">                        Name = <span class="stringliteral">&quot;Observer&quot;</span>,</div>
<div class="line">                        <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> =<span class="stringliteral">&quot;i=15668&quot;</span>,</div>
<div class="line">                        Identities = <span class="keyword">new</span> IdentityType[]</div>
<div class="line">                        {</div>
<div class="line">                            <span class="keyword">new</span> IdentityType()</div>
<div class="line">                            {</div>
<div class="line">                                CriteriaType = CriteriaType.AuthenticatedUser</div>
<div class="line">                            }</div>
<div class="line">                        }</div>
<div class="line">                    },</div>
<div class="line">                    <span class="keyword">new</span> RoleType()</div>
<div class="line">                    {</div>
<div class="line">                        Name = <span class="stringliteral">&quot;Operator&quot;</span>,</div>
<div class="line">                        <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> =<span class="stringliteral">&quot;i=15680&quot;</span>,</div>
<div class="line">                        Identities = <span class="keyword">new</span> IdentityType[]</div>
<div class="line">                        {</div>
<div class="line">                            <span class="keyword">new</span> IdentityType()</div>
<div class="line">                            {</div>
<div class="line">                                CriteriaType = CriteriaType.UserName,</div>
<div class="line">                                Value = <span class="stringliteral">&quot;john&quot;</span></div>
<div class="line">                            }</div>
<div class="line">                        }</div>
<div class="line">                    },</div>
<div class="line">                    <span class="keyword">new</span> RoleType()</div>
<div class="line">                    {</div>
<div class="line">                        Name = <span class="stringliteral">&quot;SecurityAdmin&quot;</span>,</div>
<div class="line">                        <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> =<span class="stringliteral">&quot;i=15704&quot;</span>,</div>
<div class="line">                        Identities = <span class="keyword">new</span> IdentityType[]</div>
<div class="line">                        {</div>
<div class="line">                            <span class="keyword">new</span> IdentityType()</div>
<div class="line">                            {</div>
<div class="line">                                CriteriaType = CriteriaType.UserName,</div>
<div class="line">                                Value = <span class="stringliteral">&quot;joe&quot;</span></div>
<div class="line">                            }</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            };</div>
<div class="line">            <span class="keywordflow">return</span> inMemoryRoleConfig;</div>
<div class="line">        }</div>
</div><!-- fragment --> <h1><a class="anchor" id="serverlesson09_rolepermission_to_node"></a>
Setting Permissions on Nodes</h1>
<h2><a class="anchor" id="serverlesson09_rolepermission_variable"></a>
Add RolePermissions to Variable</h2>
<p>After configuring the roles, we can set the <a class="el" href="classUnifiedAutomation_1_1UaBase_1_1RolePermissionTypeCollection.html">RolePermissionTypeCollection</a> that stores multible <a class="el" href="classUnifiedAutomation_1_1UaBase_1_1RolePermissionType.html">RolePermissionTypes</a> to restrict access to nodes based on these roles. This section shows how to do this for variables. We set the RolePermissions for the variables “Temperature” and “TemperatureSetPoint”. In this example all users shall be able to browse the nodes and read all attributes expect Value and RolePermission. The access to the Value and RolePermission attribute will be restricted.</p>
<p><b>SecurtiyAdmins</b> shall be able to</p><ul>
<li>read the current value and the RolePermission attribute of Temperature.</li>
<li>read/write the value and read the RolePermission attribute of TemperatureSetPoint.</li>
</ul>
<p><b>Operators</b> shall be able to</p><ul>
<li>read the current value and the historical data of Temperature</li>
<li>read and write the value of TemperatureSetPoint.</li>
</ul>
<p><b>Observers/AuthenticatedUsers</b> shall be able to</p><ul>
<li>read the value of Temperature</li>
<li>read the value of TemperatureSetPoint.</li>
</ul>
<p><b>Anonymous</b> shall only be able to browse the nodes</p>
<div class="fragment"><div class="line">            RolePermissionTypeCollection rolePermissionTypeCollectionTemperature = <span class="keyword">new</span> RolePermissionTypeCollection()</div>
<div class="line">            {</div>
<div class="line">                <span class="keyword">new</span> RolePermissionType()</div>
<div class="line">                {</div>
<div class="line">                    RoleId = ObjectIds.WellKnownRole_Operator,</div>
<div class="line">                    Permissions = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Read | <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Browse | <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.ReadHistory</div>
<div class="line">                },</div>
<div class="line">                <span class="keyword">new</span> RolePermissionType()</div>
<div class="line">                {</div>
<div class="line">                    RoleId = ObjectIds.WellKnownRole_Observer,</div>
<div class="line">                    Permissions = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Read | <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Browse</div>
<div class="line">                },</div>
<div class="line">                <span class="keyword">new</span> RolePermissionType()</div>
<div class="line">                {</div>
<div class="line">                    RoleId = ObjectIds.WellKnownRole_Anonymous,</div>
<div class="line">                    Permissions = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Browse</div>
<div class="line">                },</div>
<div class="line">                <span class="keyword">new</span> RolePermissionType()</div>
<div class="line">                {</div>
<div class="line">                    RoleId= ObjectIds.WellKnownRole_SecurityAdmin,</div>
<div class="line">                    Permissions = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Read | <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Browse | <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.ReadRolePermissions</div>
<div class="line">                }</div>
<div class="line">            };</div>
<div class="line"></div>
<div class="line">            RolePermissionTypeCollection rolePermissionTypeCollectionTemperatureSetPoint = <span class="keyword">new</span> RolePermissionTypeCollection()</div>
<div class="line">            {</div>
<div class="line">                <span class="keyword">new</span> RolePermissionType()</div>
<div class="line">                {</div>
<div class="line">                    RoleId = ObjectIds.WellKnownRole_Operator,</div>
<div class="line">                    Permissions = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.ReadWrite | <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Browse </div>
<div class="line">                },</div>
<div class="line">                <span class="keyword">new</span> RolePermissionType()</div>
<div class="line">                {</div>
<div class="line">                    RoleId = ObjectIds.WellKnownRole_Observer,</div>
<div class="line">                    Permissions = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Read | <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Browse</div>
<div class="line">                },</div>
<div class="line">                <span class="keyword">new</span> RolePermissionType()</div>
<div class="line">                {</div>
<div class="line">                    RoleId = ObjectIds.WellKnownRole_Anonymous,</div>
<div class="line">                    Permissions = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Browse</div>
<div class="line">                },</div>
<div class="line">                <span class="keyword">new</span> RolePermissionType()</div>
<div class="line">                {</div>
<div class="line">                    RoleId= ObjectIds.WellKnownRole_SecurityAdmin,</div>
<div class="line">                    Permissions = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.ReadWrite | <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Browse | <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.ReadRolePermissions</div>
<div class="line">                }</div>
<div class="line">            };</div>
</div><!-- fragment --><div class="fragment"><div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> parentId = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>(block.Name, InstanceNamespaceIndex);</div>
<div class="line"></div>
<div class="line">                SetNodePermissions(</div>
<div class="line">                    parentId,</div>
<div class="line">                    <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328ab4a75c1b2cfd3cb752898835cad346b0">QualifiedName</a>(<span class="stringliteral">&quot;Temperature&quot;</span>, TypeNamespaceIndex),</div>
<div class="line">                    rolePermissionTypeCollectionTemperature);</div>
<div class="line">                SetNodePermissions(</div>
<div class="line">                    parentId,</div>
<div class="line">                    <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328ab4a75c1b2cfd3cb752898835cad346b0">QualifiedName</a>(<span class="stringliteral">&quot;TemperatureSetPoint&quot;</span>, TypeNamespaceIndex),</div>
<div class="line">                    rolePermissionTypeCollectionTemperatureSetPoint);</div>
</div><!-- fragment --><p> If the nodes have <a class="el" href="classUnifiedAutomation_1_1UaServer_1_1NodeHandleType.html">NodeHandleType</a> Internal or InternalPolled, there’s nothing else to implement. But our nodes are configured to have the NodeHandleType ExternalPolled. Thus, Read and Write are implemented in the NodeManager and we have to check the access permissions before returning values. We are using the HasAccess methods implemented in the BaseNodeManager to check the user’s roles against the RolePermissions set for the node (see Lesson09NodeManager.cs):</p>
<div class="fragment"><div class="line">                    <span class="keywordflow">if</span> (CannotPassNodeAccessChecks(context, operationHandles[ii].NodeHandle, <a class="code" href="namespaceUnifiedAutomation_1_1UaServer.html#a552b0abc7ef451877d792a852b0d31de">UserAccessMask</a>.Read, out StatusCode statusCode))</div>
<div class="line">                    {</div>
<div class="line">                        dv = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328ac7859cb58bee902dc86f1742665ff96f">DataValue</a>(statusCode);</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span></div>
</div><!-- fragment --><div class="fragment"><div class="line">                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CannotPassNodeAccessChecks(context, operationHandles[ii].NodeHandle, <a class="code" href="namespaceUnifiedAutomation_1_1UaServer.html#a552b0abc7ef451877d792a852b0d31de">UserAccessMask</a>.Write, out StatusCode statusCode))</div>
<div class="line">                    {</div>
<div class="line">                        error = statusCode;</div>
<div class="line">                    }</div>
</div><!-- fragment --><p> To test the implementation, we connect to the Server with UaExpert as anonymous user first. When selecting one of the Temperature variables, we notice in the Attributes window that we’re not allowed to read the Value attribute and the UserAccessLevel is “None”. When changing the user to “john”, the value can be read as the UserAccessLevel is now “CurrentRead, HistoryRead” (see screenshots <a class="el" href="L3ServerTutGSLess09.html#fig_9_1">below</a>).</p>
<p><a class="anchor" id="fig_9_1"></a></p><div class="image">
<img src="serverlesson09_variable.png" alt="serverlesson09_variable.png"/>
<div class="caption">
Figure 9.1: Attributes of variable Temperature when connected as anonymous user (left) and as user john (right)</div></div>
<h2><a class="anchor" id="serverlesson09_rolepermissions_method"></a>
Add RolePermissions to Method</h2>
<p>Setting the <a class="el" href="classUnifiedAutomation_1_1UaBase_1_1RolePermissionType.html">RolePermissionTypes</a> of methods is quite similar. We will restrict the access so that Operators will be able to call the methods.</p>
<p>In this case, we only have to assign the RolePermissions. The SDK perfoms all access checks. The following sample code can be found in the file Lesson09Nodemanager.RolePermission.cs</p>
<div class="fragment"><div class="line">            RolePermissionTypeCollection methodRolePermission = <span class="keyword">new</span> RolePermissionTypeCollection()</div>
<div class="line">            {</div>
<div class="line">                <span class="keyword">new</span> RolePermissionType()</div>
<div class="line">                {</div>
<div class="line">                    RoleId = ObjectIds.WellKnownRole_Operator,</div>
<div class="line">                    Permissions = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.ReadWrite | <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Browse | <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Call</div>
<div class="line">                },</div>
<div class="line">                <span class="keyword">new</span> RolePermissionType()</div>
<div class="line">                {</div>
<div class="line">                    RoleId = ObjectIds.WellKnownRole_Anonymous,</div>
<div class="line">                    Permissions = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Read | <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Browse</div>
<div class="line">                },</div>
<div class="line">                <span class="keyword">new</span> RolePermissionType()</div>
<div class="line">                {</div>
<div class="line">                    RoleId = ObjectIds.WellKnownRole_SecurityAdmin,</div>
<div class="line">                    Permissions = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.ReadRolePermissions</div>
<div class="line">                }</div>
<div class="line">            };</div>
</div><!-- fragment --><div class="fragment"><div class="line">            <span class="keywordflow">foreach</span> (BlockConfiguration block <span class="keywordflow">in</span> m_system.GetBlocks())</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> parentId = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>(block.Name, InstanceNamespaceIndex);</div>
<div class="line"></div>
<div class="line">                SetNodePermissions(</div>
<div class="line">                    parentId,</div>
<div class="line">                    <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328ab4a75c1b2cfd3cb752898835cad346b0">QualifiedName</a>(<span class="stringliteral">&quot;Start&quot;</span>, TypeNamespaceIndex),</div>
<div class="line">                    methodRolePermission);</div>
<div class="line">                SetNodePermissions(</div>
<div class="line">                    parentId,</div>
<div class="line">                    <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328ab4a75c1b2cfd3cb752898835cad346b0">QualifiedName</a>(<span class="stringliteral">&quot;StartWithSetPoint&quot;</span>, TypeNamespaceIndex),</div>
<div class="line">                    methodRolePermission);</div>
<div class="line">                SetNodePermissions(</div>
<div class="line">                    parentId,</div>
<div class="line">                    <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328ab4a75c1b2cfd3cb752898835cad346b0">QualifiedName</a>(<span class="stringliteral">&quot;Stop&quot;</span>, TypeNamespaceIndex),</div>
<div class="line">                    methodRolePermission);</div>
<div class="line">            }</div>
</div><!-- fragment --><p> To test the implementation, we connect to the Server as anonymous user and call the method stop on a controller. The method call will fail with error “BadUserAccessDenied”. After changing to user “john” we are able to successfully call the method.</p>
<h2><a class="anchor" id="serverlesson09_rolepermissions_alarmandevent"></a>
Add RolePermissions to Alarms and Events</h2>
<p>RolePermissions can also be used to control the access to events. In this example we will create a <a class="el" href="classUnifiedAutomation_1_1UaBase_1_1RolePermissionTypeCollection.html">RolePermissionTypeCollection</a> and add it to the UserData of the alarm. When sending the event associated with the alarm, we assign this UserData as <a class="el" href="classUnifiedAutomation_1_1UaBase_1_1RolePermissionTypeCollection.html">RolePermissionTypeCollection</a> to the event. The following sample code can be found in the file Lesson09NodeManager.cs.</p>
<div class="fragment"><div class="line">            var rolePermissions = <span class="keyword">new</span> RolePermissionTypeCollection()</div>
<div class="line">            {</div>
<div class="line">                <span class="keyword">new</span> RolePermissionType()</div>
<div class="line">                {</div>
<div class="line">                    RoleId = ObjectIds.WellKnownRole_Operator,</div>
<div class="line">                    Permissions = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Browse | <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Read | <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.ReadHistory | <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.ReceiveEvents | <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Call</div>
<div class="line">                },</div>
<div class="line">                <span class="keyword">new</span> RolePermissionType()</div>
<div class="line">                {</div>
<div class="line">                    RoleId = ObjectIds.WellKnownRole_Observer,</div>
<div class="line">                    Permissions = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Browse | <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Read | <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.ReadHistory | <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.ReceiveEvents</div>
<div class="line">                },</div>
<div class="line">                <span class="keyword">new</span> RolePermissionType()</div>
<div class="line">                {</div>
<div class="line">                    RoleId = ObjectIds.WellKnownRole_Anonymous,</div>
<div class="line">                    Permissions = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.Browse</div>
<div class="line">                },</div>
<div class="line">                <span class="keyword">new</span> RolePermissionType()</div>
<div class="line">                {</div>
<div class="line">                    RoleId = ObjectIds.WellKnownRole_SecurityAdmin,</div>
<div class="line">                    Permissions = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1">PermissionTypeDataType</a>.ReadRolePermissions</div>
<div class="line">                }</div>
<div class="line">            };</div>
<div class="line">            SetNodePermissions(alarmId, rolePermissions, <span class="keyword">true</span>);</div>
<div class="line">            SetNodePermissions(alarm.SourceNode, rolePermissions, <span class="keyword">false</span>);</div>
<div class="line">            alarm.SetRolePermissions(rolePermissions, <span class="keyword">this</span>);</div>
</div><!-- fragment --><p> Again, we will test the implementation using UaExpert. First we connect with UaExpert as anonymous user, create an EventView, and drag and drop the Server object to this EventView. Then we create another session with the Server as user john, create another EventView, and again drag and drop the Server object to the EventView.</p>
<p>We now call a method being user john and compare the EventViews (see screenshots <a class="el" href="L3ServerTutGSLess09.html#fig_9_2">below</a>). Both users receive the event indicating that the controller state has changed, but only john is able to receive the event associated with the alarm.</p>
<p><a class="anchor" id="fig_9_2"></a></p><div class="image">
<img src="serverlesson09_event.png" alt="serverlesson09_event.png"/>
<div class="caption">
Figure 9.2: EventViews of the anonymous user (top) and user john (bottom)</div></div>
 <h1><a class="anchor" id="serverlesson09_user_management"></a>
Add User Management</h1>
<p>Use the User Management to control which users are allowed connect to a Server and which are not.</p>
<p>For being able to check access rights, we have to enable UserName tokens in the Server configuration. Therefore we extend the ServerSettings in app.config:</p>
<div class="fragment"><div class="line">&lt;UserIdentity&gt;</div>
<div class="line">  &lt;EnableAnonymous&gt;<span class="keyword">true</span>&lt;/EnableAnonymous&gt;</div>
<div class="line">  &lt;EnableUserName&gt;<span class="keyword">true</span>&lt;/EnableUserName&gt;</div>
<div class="line">&lt;/UserIdentity&gt;</div>
</div><!-- fragment --><p>To enable the User Management extend the UserIdentiy to the following lines:</p>
<div class="fragment"><div class="line">&lt;UserIdentity&gt;</div>
<div class="line">  &lt;EnableAnonymous&gt;<span class="keyword">true</span>&lt;/EnableAnonymous&gt;</div>
<div class="line">  &lt;EnableUserName&gt;<span class="keyword">true</span>&lt;/EnableUserName&gt;</div>
<div class="line">    &lt;UserManagement FilePath=<span class="stringliteral">&quot;UaGettingStartedUserConfiguration.xml&quot;</span>&gt;</div>
<div class="line">      &lt;MinPasswordLength&gt;3&lt;/MinPasswordLength&gt;</div>
<div class="line">      &lt;MaxPasswordLength&gt;0&lt;/MaxPasswordLength&gt;</div>
<div class="line">      &lt;PasswordOptions&gt;20&lt;/PasswordOptions&gt;</div>
<div class="line">    &lt;/UserManagement&gt;</div>
<div class="line">&lt;/UserIdentity&gt;</div>
</div><!-- fragment --><p>More configuration settings can be found <a class="el" href="L2BaseLibConfigSchema.html#L3BaseLibConfigSchemaUserManagementSettings">here</a>.</p>
<p>The prepared UaGettingStartedUserConfiguration.xml in this project contains two users:</p><ul>
<li>john (password: master)</li>
<li>joe (password: god)</li>
</ul>
<p>The passwords of the users are stored as decrypted strings until the Server will start the first time. After start, the Server SDK will encrypt the passwords as salted hashes. All necessary decryption information, that differ from the default configuration, will then stored in the user configuration file. For more information look at the <a class="el" href="L2ServerSdkServerUserManagement.html#L3FileBasedUserManagement">FileBasedUserManagement</a> documentation.</p>
<p>After startup, the users are now configured and can be used to log in via UserName authentication.</p>
<p>To manage the users online login as user <code>joe</code>. He´s got the SecurtiyAdmin role in the <a class="el" href="L3ServerTutGSLess09.html#serverlesson09_example_roles">Example Roles</a> Example Roles "Roles Example" above. Make sure the connection is encrypted, to get access to the the ServerConfiguration node where the UserManagement is attached. There you will find the Ua Methods for managing users online. </p><dl class="section note"><dt>Note</dt><dd>The online user management is enabled by default(As far as the UserManagement is enabled). If users were add, deleted or modified online, the user configuration file will be written by the sdk.<br />
When choosing the directory for the UserConfiguration file, check that the SDK is able to save user configurations changed at runtime back to file. The application needs write access on this file.<br />
In our example, the user configuration file is placed in the bin directory next to the executable file. This is done only to reduce the complexity of the example. </dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="L1ServerTutorials.html">Tutorials for Server development</a></li><li class="navelem"><a class="el" href="L2ServerTutGettingStarted.html">Getting Started</a></li>
    <li class="footer">&copy; Unified Automation GmbH - All rights reserved.</li>
  </ul>
</div>
</body>
</html>
