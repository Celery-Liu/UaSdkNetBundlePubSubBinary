<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>.NET Based OPC UA Client/Server/PubSub SDK: Lesson 8: Adding Support for Historical Access for Events</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="header_inner_inner_bg2.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">.NET Based OPC UA Client/Server/PubSub SDK
   &#160;<span id="projectnumber">4.1.0.556</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('L3ServerTutGSLess08.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Events</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Lesson 8: Adding Support for Historical Access for Events </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#serverlesson08_ov">Overview</a></li>
<li class="level1"><a href="#serverlesson08_expert">Testing History Read for Events with UaExpert</a></li>
<li class="level1"><a href="#serverlesson08_nodemanager_hr">Source Code</a></li>
</ul>
</div>
<div class="textblock"><p>This Getting Started Lesson shows how to implement HistoryRead for Events. It is based on <a class="el" href="L3ServerTutGSLess07.html">Lesson 7</a>.</p>
<p>The most relevant code can be found in the file Lesson08Nodemanager.HistoryRead.cs. The following paragraphs give a brief overview of the implementation steps which are necessary to provide support for HistoryRead for events. Please refer to the source code for more details. The code contains comments starting with “HistoryReadEvent”, explaining the implementation details.</p>
<h1><a class="anchor" id="serverlesson08_ov"></a>
Overview</h1>
<p>The following implementation steps are necessary:</p>
<ul>
<li>Setting the EventNotifier to HistoryRead</li>
<li>Adding the HistoricalEventFilter property</li>
<li>Using the event filter received by the client on server side</li>
<li>Creating and using HistoryContinuationPoints</li>
<li>Using ServerInternalClient to store events</li>
<li>Fetching event data from a database using start time, end time, and requested event fields</li>
</ul>
<h1><a class="anchor" id="serverlesson08_expert"></a>
Testing History Read for Events with UaExpert</h1>
<p>To test reading of Historical Events, connect to the server with UaExpert.</p>
<p>Choose Document → Add from the menu bar, select “Event View” from the drop down menu “Document Type” and confirm with “Add” to add the Event View tab to the main window.</p>
<p>Drag and drop the folder “Controllers” from the Address Space window to the Configuration window of the Event View tab (see <a class="el" href="L3ServerTutGSLess08.html#fig_8_1">Figure 8.1</a>).</p>
<p><b>Figure 8.1:</b><a class="anchor" id="fig_8_1"></a></p><div class="image">
<img src="serverlesson08_expert1.png" alt="serverlesson08_expert1.png"/>
<div class="caption">
Open Event View</div></div>
<p> Expand the tree and select “ControllerEventType” beneath “SimpleEvents” to recieve the corresponding events (see <a class="el" href="L3ServerTutGSLess08.html#fig_8_2">Figure 8.2</a>).</p>
<p><b>Figure 8.2:</b><a class="anchor" id="fig_8_2"></a></p><div class="image">
<img src="serverlesson08_expert2.png" alt="serverlesson08_expert2.png"/>
<div class="caption">
Select ControllerEventType</div></div>
<p> Trigger a State change Event by calling “Stop” for “AirConditioner1” (see <a class="el" href="L3ServerTutGSLess08.html#fig_8_3">Figure 8.3</a>).</p>
<p><b>Figure 8.3:</b><a class="anchor" id="fig_8_3"></a></p><div class="image">
<img src="serverlesson08_expert3.png" alt="serverlesson08_expert3.png"/>
<div class="caption">
Calling Stop</div></div>
<p> Open the “Event History” tab and click on the “Refresh” symbol (orange arrows). The historical event will now show up in the list (see <a class="el" href="L3ServerTutGSLess08.html#fig_8_4">Figure 8.4</a>).</p>
<p><b>Figure 8.4:</b><a class="anchor" id="fig_8_4"></a></p><div class="image">
<img src="serverlesson08_expert4.png" alt="serverlesson08_expert4.png"/>
<div class="caption">
Event History</div></div>
 <h1><a class="anchor" id="serverlesson08_nodemanager_hr"></a>
Source Code</h1>
<p>For convenience, the file Lesson08Nodemanager.EventHistory.cs, which contains most of the new code, is included here. The complete source code can be found in the Visual Studio Solution containing the Server Getting Started lessons.</p>
<div class="fragment"><div class="line"><span class="comment">/******************************************************************************</span></div>
<div class="line"><span class="comment">** Copyright (c) 2006-2023 Unified Automation GmbH All rights reserved.</span></div>
<div class="line"><span class="comment">**</span></div>
<div class="line"><span class="comment">** Software License Agreement (&quot;SLA&quot;) Version 2.8</span></div>
<div class="line"><span class="comment">**</span></div>
<div class="line"><span class="comment">** Unless explicitly acquired and licensed from Licensor under another</span></div>
<div class="line"><span class="comment">** license, the contents of this file are subject to the Software License</span></div>
<div class="line"><span class="comment">** Agreement (&quot;SLA&quot;) Version 2.8, or subsequent versions</span></div>
<div class="line"><span class="comment">** as allowed by the SLA, and You may not copy or use this file in either</span></div>
<div class="line"><span class="comment">** source code or executable form, except in compliance with the terms and</span></div>
<div class="line"><span class="comment">** conditions of the SLA.</span></div>
<div class="line"><span class="comment">**</span></div>
<div class="line"><span class="comment">** All software distributed under the SLA is provided strictly on an</span></div>
<div class="line"><span class="comment">** &quot;AS IS&quot; basis, WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,</span></div>
<div class="line"><span class="comment">** AND LICENSOR HEREBY DISCLAIMS ALL SUCH WARRANTIES, INCLUDING WITHOUT</span></div>
<div class="line"><span class="comment">** LIMITATION, ANY WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR</span></div>
<div class="line"><span class="comment">** PURPOSE, QUIET ENJOYMENT, OR NON-INFRINGEMENT. See the SLA for specific</span></div>
<div class="line"><span class="comment">** language governing rights and limitations under the SLA.</span></div>
<div class="line"><span class="comment">**</span></div>
<div class="line"><span class="comment">** Project: .NET based OPC UA Client Server SDK</span></div>
<div class="line"><span class="comment">**</span></div>
<div class="line"><span class="comment">** Description: OPC Unified Architecture Software Development Kit.</span></div>
<div class="line"><span class="comment">**</span></div>
<div class="line"><span class="comment">** The complete license agreement can be found here:</span></div>
<div class="line"><span class="comment">** http://unifiedautomation.com/License/SLA/2.8/</span></div>
<div class="line"><span class="comment">******************************************************************************/</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">using</span> <a class="code" href="namespaceSystem.html">System</a>;</div>
<div class="line"><span class="keyword">using</span> <a class="code" href="namespaceSystem.html">System</a>.Collections.Generic;</div>
<div class="line"><span class="keyword">using</span> <a class="code" href="namespaceSystem.html">System</a>.Linq;</div>
<div class="line"><span class="keyword">using</span> <a class="code" href="namespaceSystem.html">System</a>.Text;</div>
<div class="line"><span class="keyword">using</span> <a class="code" href="namespaceSystem.html">System</a>.<a class="code" href="namespaceSystem_1_1Threading.html">Threading</a>;</div>
<div class="line"><span class="keyword">using</span> <a class="code" href="namespaceSystem.html">System</a>.<a class="code" href="namespaceSystem_1_1IO.html">IO</a>;</div>
<div class="line"><span class="keyword">using</span> <a class="code" href="namespaceSystem.html">System</a>.Reflection;</div>
<div class="line"><span class="keyword">using</span> <a class="code" href="namespaceUnifiedAutomation.html">UnifiedAutomation</a>.<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html">UaBase</a>;</div>
<div class="line"><span class="keyword">using</span> <a class="code" href="namespaceUnifiedAutomation.html">UnifiedAutomation</a>.<a class="code" href="namespaceUnifiedAutomation_1_1UaServer.html">UaServer</a>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace </span>YourCompany.GettingStarted</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">internal</span> <span class="keyword">partial class </span>Lesson08NodeManager</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">protected</span> <span class="keyword">override</span> HistoryReadResult HistoryReadEvent(</div>
<div class="line">            RequestContext context,</div>
<div class="line">            ReadEventDetails details,</div>
<div class="line">            HistoryEventHandle nodeHandle,</div>
<div class="line">            ref HistoryContinuationPoint continuationPoint)</div>
<div class="line">        {</div>
<div class="line">            HistoryReadResult result = <span class="keyword">new</span> HistoryReadResult();</div>
<div class="line"></div>
<div class="line">            <span class="comment">//HistoryReadEvent Step 2: Check if Source is valid.</span></div>
<div class="line">            HistoryEventSource eventSource = m_historyEventManager.GetEventSource(nodeHandle.NodeId);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (eventSource == null)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> <span class="keyword">new</span> HistoryReadResult() { <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a72381d4605940627a6e846d5f3155c51">StatusCode</a> = StatusCodes.BadHistoryOperationUnsupported };</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">//HistoryReadEvent Step 3: Check if filter is valid.</span></div>
<div class="line">            EventFilterResult filterResult = null;</div>
<div class="line">            <span class="comment">//The filter manager is created in this step, too.</span></div>
<div class="line">            <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a72381d4605940627a6e846d5f3155c51">StatusCode</a> error = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a4ee1c62aa1346abfd54798f6d167a766a9aa1b03934893d7134a660af4204f2a9">Server</a>.FilterManager.ValidateFilter(context, details.Filter, out filterResult);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (error.IsBad())</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> <span class="keyword">new</span> HistoryReadResult() { <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a72381d4605940627a6e846d5f3155c51">StatusCode</a> = StatusCodes.BadEventFilterInvalid };</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">//HistoryReadEvent Step 4: Get Historical Events</span></div>
<div class="line">            HistoricalEventFields eventFields = null;</div>
<div class="line">            <span class="comment">//If continuationPoint != null, we can use the historical events that are saved in the</span></div>
<div class="line">            <span class="comment">//continuationPoint</span></div>
<div class="line">            <span class="keywordflow">if</span> (continuationPoint != null)</div>
<div class="line">            {</div>
<div class="line">                eventFields = GetHistoricalEventFieldsFromContinationPoint(continuationPoint);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (eventFields == null)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">return</span> <span class="keyword">new</span> HistoryReadResult() { <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a72381d4605940627a6e846d5f3155c51">StatusCode</a> = StatusCodes.BadContinuationPointInvalid };</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                continuationPoint = null;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">//If continuationPoint == null, we have to get the event fields from the event source</span></div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                eventFields = GetHistoricalEventFieldsFromDataSource(eventSource, context, details, nodeHandle);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">//HistoryReadEvent Step 5: Add the nodes to the result.</span></div>
<div class="line">            <span class="comment">//If there are more results that match start time, end time and the filters that NumValuesPerNode,</span></div>
<div class="line">            <span class="comment">//we have to use the continuationPoint</span></div>
<div class="line">            <span class="keywordtype">bool</span> useContinuationPoint;</div>
<div class="line">            HistoryEvent data = eventFields.NextEventFields(details.NumValuesPerNode, out useContinuationPoint);</div>
<div class="line">            result.HistoryData = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a1adf19f65f9aa28f3b51d77b73f6b688">ExtensionObject</a>(data);</div>
<div class="line">            <span class="comment">//Save the remaining results</span></div>
<div class="line">            <span class="keywordflow">if</span> (useContinuationPoint)</div>
<div class="line">            {</div>
<div class="line">                continuationPoint = CreateHistoryEventsContinuationPoint(eventFields);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> result;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">//Step 1</span></div>
<div class="line"><span class="comment"></span>        <span class="keyword">private</span> <span class="keywordtype">void</span> SetupEventHistory()</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">//Create a list of browse names. This list is used for setting up the filter for</span></div>
<div class="line">            <span class="comment">//the internal client and assigning the received event field values to the &quot;data base entries&quot;.</span></div>
<div class="line">            QualifiedNameCollection eventFieldNames = <span class="keyword">new</span> QualifiedNameCollection();</div>
<div class="line">            eventFieldNames.Add(BrowseNames.EventType);</div>
<div class="line">            eventFieldNames.Add(BrowseNames.Time);</div>
<div class="line">            eventFieldNames.Add(BrowseNames.ReceiveTime);</div>
<div class="line">            eventFieldNames.Add(BrowseNames.EventId);</div>
<div class="line">            eventFieldNames.Add(BrowseNames.SourceName);</div>
<div class="line">            eventFieldNames.Add(BrowseNames.SourceNode);</div>
<div class="line">            eventFieldNames.Add(BrowseNames.Severity);</div>
<div class="line">            eventFieldNames.Add(BrowseNames.Message);</div>
<div class="line">            eventFieldNames.Add(<span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328ab4a75c1b2cfd3cb752898835cad346b0">QualifiedName</a>(yourorganisation.BA.BrowseNames.State, TypeNamespaceIndex));</div>
<div class="line">            eventFieldNames.Add(<span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328ab4a75c1b2cfd3cb752898835cad346b0">QualifiedName</a>(yourorganisation.BA.BrowseNames.Temperature, TypeNamespaceIndex));</div>
<div class="line"></div>
<div class="line">            m_historyEventManager = <span class="keyword">new</span> HistoryEventManager(Server, eventFieldNames);</div>
<div class="line"></div>
<div class="line">            <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> controllersId = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>(<span class="stringliteral">&quot;Controllers&quot;</span>, InstanceNamespaceIndex);</div>
<div class="line">            ObjectNode controllersFolder = FindInMemoryNode(controllersId)</div>
<div class="line">                as ObjectNode;</div>
<div class="line">            if (controllersFolder != null)</div>
<div class="line">            {</div>
<div class="line">                lock (InMemoryNodeLock)</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">//It is necessary to set the HistoryRead in EventNotifier. If this bit is not set,</span></div>
<div class="line">                    <span class="comment">//HistroryReadEvent will not be called.</span></div>
<div class="line">                    <span class="comment">//SubscribeToEvents hat to be set because a subscription using the InternalClient is used</span></div>
<div class="line">                    <span class="comment">//to collect the event data.</span></div>
<div class="line">                    controllersFolder.EventNotifier = EventNotifiers.HistoryRead | EventNotifiers.SubscribeToEvents;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            HistoryEventSource eventSource = <span class="keyword">new</span> HistoryEventSource();</div>
<div class="line">            m_historyEventManager.AddEventSource(controllersId, eventSource, <span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">            <span class="comment">//Create the property that should be added to objects that provide an event history.</span></div>
<div class="line">            CreateVariableSettings HistoricalEventFilterSettings = <span class="keyword">new</span> CreateVariableSettings()</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a2d87c494cd1d1d040a4b83fc16615dc1a12e36cfaa1ac01c4d45312adf07d261c">AccessLevel</a> = AccessLevels.CurrentRead,</div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a9bafec980b0e46918f646fa8019b577ba50eebb9e969077ded08eed61ad9a5f0a">BrowseName</a> = BrowseNames.HistoricalEventFilter,</div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a2d87c494cd1d1d040a4b83fc16615dc1aaa2aaa59ac1a7c24e5e86c068bda3d20">DataType</a> = DataTypeIds.EventFilter,</div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a2d87c494cd1d1d040a4b83fc16615dc1a2248cb490d5c8c8f57a12b001a05efb5">Historizing</a> = <span class="keyword">false</span>,</div>
<div class="line">                RequestedNodeId = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>(BrowseNames.HistoricalEventFilter, InstanceNamespaceIndex),</div>
<div class="line">                TypeDefinitionId = VariableTypeIds.PropertyType,</div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a2d87c494cd1d1d040a4b83fc16615dc1a984b29a2ca83266dd2898a0a548b2c9f">ValueRank</a> = -1,</div>
<div class="line">                Value = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a1adf19f65f9aa28f3b51d77b73f6b688">ExtensionObject</a>(m_historyEventManager.EventFilter),</div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a9bafec980b0e46918f646fa8019b577ba738520b2dcbb7dbb2c8d33096387aef8">ReferenceTypeId</a> = ReferenceTypeIds.HasProperty,</div>
<div class="line">                ParentNodeId = controllersFolder.NodeId</div>
<div class="line">            };</div>
<div class="line">            m_historicalEventFilter = CreateVariable(<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a4ee1c62aa1346abfd54798f6d167a766a9aa1b03934893d7134a660af4204f2a9">Server</a>.DefaultRequestContext, HistoricalEventFilterSettings);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">foreach</span> (BlockConfiguration block <span class="keywordflow">in</span> m_system.GetBlocks())</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> controllerId = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>(block.Name, InstanceNamespaceIndex);</div>
<div class="line">                ObjectNode controllerObject = FindInMemoryNode(controllerId)</div>
<div class="line">                    as ObjectNode;</div>
<div class="line">                if (controllerObject != null)</div>
<div class="line">                {</div>
<div class="line">                    lock (InMemoryNodeLock)</div>
<div class="line">                    {</div>
<div class="line">                        <span class="comment">//Set the HistoryRead bit for the controllers</span></div>
<div class="line">                        controllerObject.EventNotifier = (byte)(controllerObject.EventNotifier|EventNotifiers.HistoryRead);</div>
<div class="line">                    }</div>
<div class="line">                    <span class="comment">//Add a reference to the property. Alternatively a new variable can be created.</span></div>
<div class="line">                    <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a093c3fce9a259f915927b8c00db77af1acf6007d2fd102b1a9110ad4f5e153ca9">AddReference</a>(<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a4ee1c62aa1346abfd54798f6d167a766a9aa1b03934893d7134a660af4204f2a9">Server</a>.DefaultRequestContext, controllerObject.NodeId, ReferenceTypeIds.HasProperty, <span class="keyword">false</span>, m_historicalEventFilter.NodeId, <span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">                    m_historyEventManager.AddEventSource(controllerId, eventSource, <span class="keyword">false</span>);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">//HistoryReadEvent Step 4: Get Historical Events</span></div>
<div class="line"><span class="comment"></span>        <span class="keyword">private</span> HistoricalEventFields GetHistoricalEventFieldsFromDataSource(</div>
<div class="line">            HistoryEventSource eventSource,</div>
<div class="line">            RequestContext context,</div>
<div class="line">            ReadEventDetails details,</div>
<div class="line">            HistoryEventHandle nodeHandle)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// evaluate the start and end time</span></div>
<div class="line">            <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a8cf10d2341ed01492506085688270c1e">DateTime</a> startTime;</div>
<div class="line">            <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a8cf10d2341ed01492506085688270c1e">DateTime</a> endTime;</div>
<div class="line">            <span class="keywordtype">bool</span> timeFlowsBackward;</div>
<div class="line">            <span class="keywordflow">if</span> (details.EndTime == <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a8cf10d2341ed01492506085688270c1e">DateTime</a>.MinValue</div>
<div class="line">                || (details.EndTime.CompareTo(details.StartTime) &gt;= 0)</div>
<div class="line">                    &amp;&amp; details.StartTime != <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a8cf10d2341ed01492506085688270c1e">DateTime</a>.MinValue)</div>
<div class="line">            {</div>
<div class="line">                startTime = details.StartTime;</div>
<div class="line">                endTime = details.EndTime;</div>
<div class="line">                timeFlowsBackward = <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                startTime = details.EndTime;</div>
<div class="line">                endTime = details.StartTime;</div>
<div class="line">                timeFlowsBackward = <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="comment">//Get all events within the specified time space of the specified node</span></div>
<div class="line">            <span class="comment">//On some systems there will be database queries to get this information</span></div>
<div class="line">            <a class="code" href="namespaceSystem.html">System</a>.Collections.Generic.IEnumerable&lt;<a class="code" href="namespaceSystem.html">System</a>.Collections.Generic.KeyValuePair&lt;<a class="code" href="namespaceSystem.html">System</a>.DateTime, HistoryEventData&gt;&gt; result</div>
<div class="line">                = eventSource.Events.Where(</div>
<div class="line">                        e =&gt; e.Key.CompareTo(startTime) &gt;= 0</div>
<div class="line">                        &amp;&amp; (endTime == <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a8cf10d2341ed01492506085688270c1e">DateTime</a>.MinValue || e.Key.CompareTo(endTime) &lt;= 0)</div>
<div class="line">                        &amp;&amp; (e.Value.SourceNode == nodeHandle.NodeId || nodeHandle.NodeId == <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>(<span class="stringliteral">&quot;Controllers&quot;</span>, InstanceNamespaceIndex)));</div>
<div class="line"></div>
<div class="line">            <span class="comment">//Returned events are sorted by Date.</span></div>
<div class="line">            <span class="comment">//If time flows backward the event fields have to be returned backward</span></div>
<div class="line">            <span class="keywordflow">if</span> (timeFlowsBackward)</div>
<div class="line">            {</div>
<div class="line">                result = result.Reverse();</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            HistoricalEventFields ret = <span class="keyword">new</span> HistoricalEventFields();</div>
<div class="line">            <span class="keywordflow">try</span></div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a4ee1c62aa1346abfd54798f6d167a766a9aa1b03934893d7134a660af4204f2a9">Server</a>.FilterManager.UpdateReferenceCount(details.Filter, <span class="keyword">true</span>);</div>
<div class="line">                <span class="keywordflow">foreach</span> (KeyValuePair&lt;DateTime, HistoryEventData&gt; element <span class="keywordflow">in</span> result)</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// Create a GenericEvent from the data that is saved in the event source.</span></div>
<div class="line">                    <span class="comment">// We can use filter functionality of SDK in this case.</span></div>
<div class="line">                    <span class="comment">// If the event history is saved in memory, the event source can save GenericEvents</span></div>
<div class="line">                    <span class="comment">// directly to get a better performance. But in most use cases, the historical event</span></div>
<div class="line">                    <span class="comment">// data is saved in a data base.</span></div>
<div class="line">                    GenericEvent genericEvent = element.Value.ToGenericEvent(<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a4ee1c62aa1346abfd54798f6d167a766a9aa1b03934893d7134a660af4204f2a9">Server</a>.FilterManager);</div>
<div class="line"></div>
<div class="line">                    <span class="comment">// apply the filter.</span></div>
<div class="line">                    <span class="keywordflow">if</span> (!FilterManager.Evaluate(context, details.Filter.WhereClause, genericEvent))</div>
<div class="line">                    {</div>
<div class="line">                        <span class="keywordflow">continue</span>;</div>
<div class="line">                    }</div>
<div class="line"></div>
<div class="line">                    <span class="comment">// fetch the event fields.</span></div>
<div class="line">                    HistoryEventFieldList fields = <span class="keyword">new</span> HistoryEventFieldList();</div>
<div class="line"></div>
<div class="line">                    <span class="keywordflow">foreach</span> (SimpleAttributeOperand clause <span class="keywordflow">in</span> details.Filter.SelectClauses)</div>
<div class="line">                    {</div>
<div class="line">                        <span class="comment">// get the value of the attribute (apply localization).</span></div>
<div class="line">                        <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a492f18b60811bf85ce118c0c6a1a5c4a">Variant</a> value = genericEvent.Get(clause);</div>
<div class="line"></div>
<div class="line">                        <span class="comment">// add value.</span></div>
<div class="line">                        fields.EventFields.Add(value);</div>
<div class="line">                    }</div>
<div class="line">                    ret.Data.Add(fields);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">finally</span></div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a4ee1c62aa1346abfd54798f6d167a766a9aa1b03934893d7134a660af4204f2a9">Server</a>.FilterManager.UpdateReferenceCount(details.Filter, <span class="keyword">false</span>);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> ret;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keyword">private</span> HistoricalEventFields GetHistoricalEventFieldsFromContinationPoint(HistoryContinuationPoint continuationPoint)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> continuationPoint as HistoricalEventFields;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keyword">private</span> HistoryContinuationPoint CreateHistoryEventsContinuationPoint(HistoricalEventFields events)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> events;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #region Private fields</span></div>
<div class="line">        <span class="keyword">private</span> VariableNode m_historicalEventFilter;</div>
<div class="line">        <span class="keyword">private</span> HistoryEventManager m_historyEventManager;</div>
<div class="line"><span class="preprocessor">        #endregion</span></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">//HistoryReadEvent Step 1: Specify nodes with Event history.</span></div>
<div class="line"><span class="preprocessor">    #region HistoryEventSource class</span></div>
<div class="line">    <span class="keyword">internal</span> <span class="keyword">class </span>HistoryEventSource</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">public</span> HistoryEventSource()</div>
<div class="line">        {</div>
<div class="line">            m_events = <span class="keyword">new</span> SortedList&lt;DateTime, HistoryEventData&gt;();</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #region public properties</span></div>
<div class="line">        <span class="keyword">public</span> SortedList&lt;DateTime, HistoryEventData &gt; Events</div>
<div class="line">        {</div>
<div class="line">            <span class="keyword">get</span></div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> m_events;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">        #endregion</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #region public interface</span></div>
<div class="line">        <span class="keyword">public</span> <span class="keywordtype">void</span> AddEvent(NodeId nodeId, HistoryEventData e)</div>
<div class="line">        {</div>
<div class="line">            m_events.Add(e.Time, e);</div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">        #endregion</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #region private fields</span></div>
<div class="line">        <span class="keyword">private</span> SortedList&lt;DateTime, HistoryEventData&gt; m_events;</div>
<div class="line"><span class="preprocessor">        #endregion</span></div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">    #endregion</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #region HistoryEventData</span></div>
<div class="line">    <span class="keyword">internal</span> <span class="keyword">class </span>HistoryEventData</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">public</span> HistoryEventData()</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// This class uses key value pairs to store the data.</span></div>
<div class="line">            <span class="comment">// Storing the data in lists would be more efficient.</span></div>
<div class="line">            <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a34eefcb7b99b74ce8c5010879c5fb7f4af6068daa29dbb05a7ead1e3b5a48bbee">Data</a> = <span class="keyword">new</span> Dictionary&lt;QualifiedName,Variant&gt;();</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #region Public Interface</span></div>
<div class="line">        <span class="keyword">public</span> <span class="keywordtype">void</span> AddEventField(QualifiedName browseName, Variant value)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (browseName == <span class="stringliteral">&quot;Time&quot;</span>)</div>
<div class="line">            {</div>
<div class="line">                Time = value.ToDateTime();</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (browseName == <span class="stringliteral">&quot;SourceNode&quot;</span>)</div>
<div class="line">            {</div>
<div class="line">                SourceNode = value.ToNodeId();</div>
<div class="line">            }</div>
<div class="line">            <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a34eefcb7b99b74ce8c5010879c5fb7f4af6068daa29dbb05a7ead1e3b5a48bbee">Data</a>.Add(browseName, value);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keyword">public</span> GenericEvent ToGenericEvent(FilterManager filterManager)</div>
<div class="line">        {</div>
<div class="line">            GenericEvent ret = <span class="keyword">new</span> GenericEvent(filterManager)</div>
<div class="line">            {</div>
<div class="line">                Time = Time,</div>
<div class="line">                SourceNode = SourceNode</div>
<div class="line">            };</div>
<div class="line">            <span class="comment">// If the data is stored in a list (i.e. if a more efficient implementation is used),</span></div>
<div class="line">            <span class="comment">// GenericEvent.Set(int handle, Variant value) has to be used. This method is more efficient.</span></div>
<div class="line">            <span class="keywordflow">foreach</span> (KeyValuePair&lt;QualifiedName,Variant&gt; pair <span class="keywordflow">in</span> Data)</div>
<div class="line">            {</div>
<div class="line">                ret.Set(AbsoluteName.ToString(pair.Key), pair.Value);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> ret;</div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">        #endregion</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #region Public Properties</span></div>
<div class="line">        <span class="keyword">public</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a8cf10d2341ed01492506085688270c1e">DateTime</a> Time { <span class="keyword">get</span>; <span class="keyword">internal</span> set;}</div>
<div class="line">        <span class="keyword">public</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> SourceNode { <span class="keyword">get</span>; <span class="keyword">internal</span> set;}</div>
<div class="line">        <span class="keyword">public</span> Dictionary&lt;QualifiedName, Variant&gt; Data { <span class="keyword">get</span>; <span class="keyword">internal</span> set;}</div>
<div class="line"><span class="preprocessor">        #endregion</span></div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">    #endregion</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">//HistoryReadEvent Step 4: Get Historical Events</span></div>
<div class="line">    <span class="comment">//Create a class that contains all data that is requested. The amount of data can be too big,</span></div>
<div class="line">    <span class="comment">//so this class can be used for the continuation point.</span></div>
<div class="line"><span class="preprocessor">    #region HistoricalEventFields class</span></div>
<div class="line">    <span class="keyword">internal</span> <span class="keyword">class </span>HistoricalEventFields : HistoryContinuationPoint</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">public</span> HistoricalEventFields()</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a34eefcb7b99b74ce8c5010879c5fb7f4af6068daa29dbb05a7ead1e3b5a48bbee">Data</a> = <span class="keyword">new</span> HistoryEventFieldListCollection();</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #region Public Properties</span></div>
<div class="line">        <span class="keyword">public</span> HistoryEventFieldListCollection <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a34eefcb7b99b74ce8c5010879c5fb7f4af6068daa29dbb05a7ead1e3b5a48bbee">Data</a> { <span class="keyword">get</span>; set; }</div>
<div class="line"><span class="preprocessor">        #endregion</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">//HistoryReadEvent Step 5: Add the nodes to the result.</span></div>
<div class="line"><span class="comment"></span>        <span class="keyword">public</span> HistoryEvent NextEventFields(uint NumValuesPerNode, out <span class="keywordtype">bool</span> EventsRemaining)</div>
<div class="line">        {</div>
<div class="line">            HistoryEvent ret = <span class="keyword">new</span> HistoryEvent();</div>
<div class="line">            EventsRemaining = <span class="keyword">false</span>;</div>
<div class="line">            <span class="keywordtype">int</span> iIndex = 0;</div>
<div class="line">            <span class="keywordflow">for</span> (; (iIndex &lt; NumValuesPerNode || NumValuesPerNode == 0) &amp;&amp; <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a34eefcb7b99b74ce8c5010879c5fb7f4af6068daa29dbb05a7ead1e3b5a48bbee">Data</a>.Count &gt; 0; iIndex++)</div>
<div class="line">            {</div>
<div class="line">                ret.Events.Add(<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a34eefcb7b99b74ce8c5010879c5fb7f4af6068daa29dbb05a7ead1e3b5a48bbee">Data</a>.First());</div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a34eefcb7b99b74ce8c5010879c5fb7f4af6068daa29dbb05a7ead1e3b5a48bbee">Data</a>.RemoveAt(0);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a34eefcb7b99b74ce8c5010879c5fb7f4af6068daa29dbb05a7ead1e3b5a48bbee">Data</a>.Count &gt; 0)</div>
<div class="line">            {</div>
<div class="line">                EventsRemaining = <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">return</span> ret;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">    #endregion</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #region HistoryEventManager</span></div>
<div class="line">    <span class="keyword">internal</span> <span class="keyword">class </span>HistoryEventManager</div>
<div class="line">    {</div>
<div class="line"><span class="preprocessor">        #region Constructor</span></div>
<div class="line">        <span class="keyword">public</span> HistoryEventManager(ServerManager server, QualifiedNameCollection browseNames)</div>
<div class="line">        {</div>
<div class="line">            m_filterManager = server.FilterManager;</div>
<div class="line">            RegisterEventFields(browseNames);</div>
<div class="line">            m_client = server.InternalClient;</div>
<div class="line">            m_requestContext = server.DefaultRequestContext;</div>
<div class="line">            m_sources = <span class="keyword">new</span> Dictionary&lt;NodeId, HistoryEventSource&gt;();</div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">        #endregion</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #region Public Properties</span></div>
<div class="line">        <span class="keyword">public</span> QualifiedNameCollection EventFieldBrowseNames</div>
<div class="line">        {</div>
<div class="line">            <span class="keyword">get</span></div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> m_eventFieldBrowseNames;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keyword">public</span> EventFilter EventFilter</div>
<div class="line">        {</div>
<div class="line">            <span class="keyword">get</span></div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> m_eventFilter;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">        #endregion</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #region Public Interface</span></div>
<div class="line">        <span class="keyword">public</span> <span class="keywordtype">void</span> AddEventSource(NodeId nodeId, HistoryEventSource eventSource, <span class="keywordtype">bool</span> createSubsricption)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (createSubsricption)</div>
<div class="line">            {</div>
<div class="line">                CreateEventSubscription(nodeId, eventSource, m_eventFilter);</div>
<div class="line">            }</div>
<div class="line">            m_sources.Add(nodeId, eventSource);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keyword">private</span> <span class="keywordtype">void</span> CreateEventSubscription(NodeId nodeId, HistoryEventSource eventSource, EventFilter eventFilter)</div>
<div class="line">        {</div>
<div class="line">            List&lt;InternalClientFullEventMonitoredItem&gt; montoredItmes</div>
<div class="line">                = <span class="keyword">new</span> List&lt;InternalClientFullEventMonitoredItem&gt;();</div>
<div class="line">            InternalClientFullEventMonitoredItem eventMonitoredItem = <span class="keyword">new</span> InternalClientFullEventMonitoredItem()</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> = nodeId,</div>
<div class="line">                Filter = eventFilter</div>
<div class="line">            };</div>
<div class="line"></div>
<div class="line">            eventMonitoredItem.Callback = OnInternalClientEventEvent;</div>
<div class="line">            eventMonitoredItem.CallbackData = eventSource;</div>
<div class="line"></div>
<div class="line">            montoredItmes.Add(eventMonitoredItem);</div>
<div class="line">            m_client.CreateEventMonitoredItems(</div>
<div class="line">                m_requestContext,</div>
<div class="line">                montoredItmes);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keyword">public</span> HistoryEventSource GetEventSource(NodeId nodeId)</div>
<div class="line">        {</div>
<div class="line">            HistoryEventSource ret;</div>
<div class="line">            <span class="keywordflow">if</span> (m_sources.TryGetValue(nodeId, out ret))</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> ret;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">return</span> null;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #endregion</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #region Helpers</span></div>
<div class="line">        <span class="keyword">private</span> <span class="keywordtype">void</span> RegisterEventFields(QualifiedNameCollection browseNames)</div>
<div class="line">        {</div>
<div class="line">            m_eventFieldBrowseNames = browseNames;</div>
<div class="line">            m_eventFilter = <span class="keyword">new</span> EventFilter();</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (m_eventFieldBrowseNames == null)</div>
<div class="line">            {</div>
<div class="line">                m_eventFieldBrowseNames = <span class="keyword">new</span> QualifiedNameCollection();</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">foreach</span> (QualifiedName browseName <span class="keywordflow">in</span> m_eventFieldBrowseNames)</div>
<div class="line">            {</div>
<div class="line">                m_filterManager.CreateFieldHandle(AbsoluteName.ToString(browseName));</div>
<div class="line">                SelectEventField(m_eventFilter, browseName);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keyword">private</span> <span class="keywordtype">void</span> SelectEventField(</div>
<div class="line">            EventFilter filter,</div>
<div class="line">            QualifiedName browseName)</div>
<div class="line">        {</div>
<div class="line">            SimpleAttributeOperand eventField = <span class="keyword">new</span> SimpleAttributeOperand()</div>
<div class="line">            {</div>
<div class="line">                TypeDefinitionId = ObjectTypeIds.BaseEventType,</div>
<div class="line">                AttributeId = Attributes.Value,</div>
<div class="line">                BrowsePath = <span class="keyword">new</span> QualifiedNameCollection(<span class="keyword">new</span> QualifiedName[] { browseName })</div>
<div class="line">            };</div>
<div class="line">            filter.SelectClauses.Add(eventField);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keyword">private</span> <span class="keywordtype">void</span> OnInternalClientEventEvent(</div>
<div class="line">            RequestContext context,</div>
<div class="line">            MonitoredItemHandle itemHandle,</div>
<div class="line">            EventFieldList eventFields,</div>
<div class="line">            <span class="keywordtype">object</span> callbackData)</div>
<div class="line">        {</div>
<div class="line">            HistoryEventSource eventSource = callbackData as HistoryEventSource;</div>
<div class="line">            AddEventFieldsToEventSource(eventSource, itemHandle.NodeId, eventFields);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keyword">private</span> <span class="keywordtype">void</span> AddEventFieldsToEventSource(HistoryEventSource eventSource, NodeId sourceNodeId, EventFieldList eventFields)</div>
<div class="line">        {</div>
<div class="line">            HistoryEventData data = <span class="keyword">new</span> HistoryEventData();</div>
<div class="line">            <span class="keywordflow">if</span> (eventFields.EventFields.Count == m_eventFieldBrowseNames.Count)</div>
<div class="line">            {</div>
<div class="line">                <span class="comment">//Collect the received event fields and add it to a data structure.</span></div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; m_eventFieldBrowseNames.Count; i++)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">try</span></div>
<div class="line">                    {</div>
<div class="line">                        data.AddEventField(m_eventFieldBrowseNames[i], eventFields.EventFields[i]);</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">catch</span> (Exception)</div>
<div class="line">                    {</div>
<div class="line">                        <span class="comment">// ToDo: Error handling</span></div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">                <span class="comment">//Add the event to the data base.</span></div>
<div class="line">                eventSource.AddEvent(sourceNodeId, data);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #endregion</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #region private fields</span></div>
<div class="line">        Dictionary&lt;NodeId, HistoryEventSource&gt; m_sources;</div>
<div class="line">        QualifiedNameCollection m_eventFieldBrowseNames;</div>
<div class="line">        EventFilter m_eventFilter;</div>
<div class="line">        FilterManager m_filterManager;</div>
<div class="line">        ServerInternalClient m_client;</div>
<div class="line">        RequestContext m_requestContext;</div>
<div class="line"><span class="preprocessor">        #endregion</span></div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">    #endregion</span></div>
<div class="line"><span class="preprocessor">}</span></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="L1ServerTutorials.html">Tutorials for Server development</a></li><li class="navelem"><a class="el" href="L2ServerTutGettingStarted.html">Getting Started</a></li>
    <li class="footer">&copy; Unified Automation GmbH - All rights reserved.</li>
  </ul>
</div>
</body>
</html>
