<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>.NET Based OPC UA Client/Server/PubSub SDK: History Read – History Read Events</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="header_inner_inner_bg2.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">.NET Based OPC UA Client/Server/PubSub SDK
   &#160;<span id="projectnumber">4.1.0.556</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('L3ClientTutExample25.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Events</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">History Read – History Read Events </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#L4ClientTutExample25Pre">Prerequisites</a></li>
<li class="level1"><a href="#L4ClientTutExample25Desc">Description</a></li>
<li class="level1"><a href="#L4ClientTutExample25Code">Sample Code</a><ul><li class="level2"><a href="#L3ClientTutExample25_st01">Step 1: Fill in the ReadEventDetails Structure.</a></li>
<li class="level2"><a href="#L3ClientTutExample25_st02">Step 2: Call the HistoryReadEvent Method.</a></li>
<li class="level2"><a href="#L3ClientTutExample25_st03">Step 3: Manage the ContinuationPoint</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="L4ClientTutExample25Pre"></a>
Prerequisites</h1>
<p>A session with the server must be established.</p>
<h1><a class="anchor" id="L4ClientTutExample25Desc"></a>
Description</h1>
<p>The following dialog shows an example implementation of the History Read service for reading historical events. Press the button “Show Code” to display the corresponding code, and the button “Help” to show this documentation page.</p>
<div class="image">
<img src="clienttutorials_history_read_events.png" alt="clienttutorials_history_read_events.png"/>
</div>
<p>All fields are already filled with reasonable values.</p>
<p>Press the button “...” right of the field “Notifier” to open a window to browse the address space and select a historizing notifier.</p>
<div class="image">
<img src="clienttutorials_history_read_events2.png" alt="clienttutorials_history_read_events2.png"/>
</div>
<p>After pressing the button “OK” the NodeId will be shown in the corresponding field.</p>
<div class="image">
<img src="clienttutorials_history_read_events3.png" alt="clienttutorials_history_read_events3.png"/>
</div>
<p>You can specify a time range by checking the boxes right of the input fields “Start Time” and “End Time” and entering the desired values. Clicking on the arrow in the input field opens a calendar for picking the date. The time can be entered directly.</p>
<p>In addtion you can specify the maximum number of values to be returned in the field “Num Values”.</p>
<p>When pressing the button “Event Filter...” a dialog window for adding/removing fields to return and to edit filter critera is opened. A description can be found at <a class="el" href="L3ClientTutExample22.html#EventFilter">Modify Event Monitored Items</a>.</p>
<p>On pressing the button “Read History” the response is listed at “History Read Response”. Check the box in front of “Use Asynchronous Pattern” to call “BeginHistoryRead” instead of “HistoryRead”.</p>
<div class="image">
<img src="clienttutorials_history_read_events4.png" alt="clienttutorials_history_read_events4.png"/>
</div>
<h1><a class="anchor" id="L4ClientTutExample25Code"></a>
Sample Code</h1>
<p>The implementation is very similar to reading historical data for a variable (see <a class="el" href="L3ClientTutExample14.html">History Read Raw</a>).</p>
<p>The following code reads historical events from the server. Differences to the History Read Raw Example are marked in comments.</p>
<ul>
<li><a class="el" href="classUnifiedAutomation_1_1UaClient_1_1Session.html">UaClient.Session</a></li>
<li><a class="el" href="classUnifiedAutomation_1_1UaBase_1_1ReadEventDetails.html">UaBase.ReadEventDetails</a></li>
<li><a class="el" href="classUnifiedAutomation_1_1UaClient_1_1Session.html#a083f01b606a27ed5118ef98644584384">UaClient.Session.HistoryReadEvent</a></li>
<li><a class="el" href="classUnifiedAutomation_1_1UaBase_1_1HistoryReadValueId.html">UaBase.HistoryReadValueId</a></li>
<li><a class="el" href="classUnifiedAutomation_1_1UaClient_1_1RequestSettings.html">UaClient.RequestSettings</a></li>
</ul>
<h2><a class="anchor" id="L3ClientTutExample25_st01"></a>
Step 1: Fill in the ReadEventDetails Structure.</h2>
<p>The StartTime and EndTime are always UTC if specified. If the NumValuesPerNode is 0, all events are returned. However, the Server may still return a continuation point. The EventFilter must, at a minimum, specify the fields that are returned for each event. An additional clause can filter events based on the values of the fields.</p>
<div class="fragment"><div class="line">                ReadEventDetails details = m_details as ReadEventDetails;</div>
<div class="line">                HistoryReadValueIdCollection nodesToRead = <span class="keyword">new</span> HistoryReadValueIdCollection();</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (m_nodeToContinue == null)</div>
<div class="line">                {</div>
<div class="line">                    m_dataset.Tables[0].Rows.Clear();</div>
<div class="line"></div>
<div class="line">                    details = <span class="keyword">new</span> ReadEventDetails();</div>
<div class="line">                    details.StartTime = (StartTimeCK.Checked) ? StartTimeDP.Value.ToUniversalTime() : <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a8cf10d2341ed01492506085688270c1e">DateTime</a>.MinValue;</div>
<div class="line">                    details.EndTime = (EndTimeCK.Checked) ? EndTimeDP.Value.ToUniversalTime() : <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a8cf10d2341ed01492506085688270c1e">DateTime</a>.MinValue;</div>
<div class="line">                    details.NumValuesPerNode = (MaxReturnValuesCK.Checked) ? (uint)MaxReturnValuesNP.Value : 0;</div>
<div class="line">                    details.Filter = m_currentFilter.ToEventFilter();</div>
<div class="line"></div>
<div class="line">                    nodesToRead.Add(<span class="keyword">new</span> HistoryReadValueId() { <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> = nodeId });</div>
<div class="line"></div>
<div class="line">                    m_details = details;</div>
<div class="line">                    m_nodeToContinue = nodesToRead[0];</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    nodesToRead.Add(m_nodeToContinue);</div>
<div class="line">                }</div>
</div><!-- fragment --><h2><a class="anchor" id="L3ClientTutExample25_st02"></a>
Step 2: Call the HistoryReadEvent Method.</h2>
<p>Synchronous and asynchronous versions of the function exist. The result provides the events for each Node passed in the request.</p>
<div class="fragment"><div class="line">                <span class="comment">// this is a blocking call so show the wait cursor.</span></div>
<div class="line">                Cursor = Cursors.WaitCursor;</div>
<div class="line"></div>
<div class="line">                <span class="comment">// fetch the history (with a 10s timeout).</span></div>
<div class="line">                List&lt;HistoryEventReadResult&gt; results = session.HistoryReadEvent(</div>
<div class="line">                    nodesToRead,</div>
<div class="line">                    details,</div>
<div class="line">                    <span class="keyword">new</span> RequestSettings() { OperationTimeout = 10000 });</div>
<div class="line"></div>
<div class="line">                <span class="comment">// check for operation error.</span></div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a72381d4605940627a6e846d5f3155c51">StatusCode</a>.IsBad(results[0].StatusCode))</div>
<div class="line">                {</div>
<div class="line">                    m_parent.ShowError(<span class="keyword">this</span>, <span class="stringliteral">&quot;Read history call failed: &quot;</span> + results[0].<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a72381d4605940627a6e846d5f3155c51">StatusCode</a>.ToString());</div>
<div class="line">                    m_details = null;</div>
<div class="line">                    m_nodeToContinue = null;</div>
<div class="line">                    <span class="keywordflow">return</span>;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="comment">// update controls.</span></div>
<div class="line">                <span class="keywordflow">if</span> (results[0].Events != null)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">foreach</span> (var value <span class="keywordflow">in</span> results[0].Events)</div>
<div class="line">                    {</div>
<div class="line">                        AddEvent(value);</div>
<div class="line">                    }</div>
<div class="line"></div>
<div class="line">                    m_dataset.AcceptChanges();</div>
<div class="line">                }</div>
</div><!-- fragment --><h2><a class="anchor" id="L3ClientTutExample25_st03"></a>
Step 3: Manage the ContinuationPoint</h2>
<p>Each result returned can have a ContinuationPoint. The HistoryReadEvent must be called again with the ContinuationPoint to fetch the additional result. If it is not called, the ContinuationPoints must be released with a call to ReleaseHistoryContinuationPoints. The ReadEventDetails passed to the original call to HistoryReadEvent must be passed to ReleaseHistoryContinuationPoints.</p>
<div class="fragment"><div class="line">                <span class="comment">// save continuation point.</span></div>
<div class="line">                <span class="keywordflow">if</span> (!<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a58efa9e8b8491c4a42cbf3bead1b06b6">ByteString</a>.IsNull(results[0].ContinuationPoint))</div>
<div class="line">                {</div>
<div class="line">                    m_nodeToContinue.ContinuationPoint = results[0].ContinuationPoint;</div>
<div class="line">                    ReleaseContinuationPointBTN.Visible = <span class="keyword">true</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    m_nodeToContinue = null;</div>
<div class="line">                    ReleaseContinuationPointBTN.Visible = <span class="keyword">false</span>;</div>
<div class="line">                }</div>
</div><!-- fragment --></div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="L1ClientTutorials.html">Tutorials for Client development</a></li><li class="navelem"><a class="el" href="L2ClientTutExamples.html">Getting Started</a></li>
    <li class="footer">&copy; Unified Automation GmbH - All rights reserved.</li>
  </ul>
</div>
</body>
</html>
