<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>.NET Based OPC UA Client/Server/PubSub SDK: Certificate Management – Trust Server Certificate</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="header_inner_inner_bg2.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">.NET Based OPC UA Client/Server/PubSub SDK
   &#160;<span id="projectnumber">4.1.0.556</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('L3ClientTutExample4.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Events</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Certificate Management – Trust Server Certificate </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#L4ClientTutExample4Desc">Description</a></li>
<li class="level1"><a href="#L4ClientTutExample4Code">Sample Code</a><ul><li class="level2"><a href="#L4ClientTutExample4Code_st01">Step 1: Provide a Handler for Untrusted Certificates</a></li>
<li class="level2"><a href="#L4ClientTutExample4Code_st02">Step 2: Prompt the User to Trust the Certificate</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="L4ClientTutExample4Desc"></a>
Description</h1>
<p>The dialog shown in the following screenshot is an example for displaying an untrusted server certificate. It can be accepted temporarily or permanently. Press the button “Show Code” to display the corresponding code, and the button “Help” to show this documentation page.</p>
<div class="image">
<img src="clienttutorials_trust_server_certificate.png" alt="clienttutorials_trust_server_certificate.png"/>
</div>
<p>This dialog is used in the .NET based OPC UA Demo Server included in the SDK. It shows up when connecting to the server on a secure endpoint with a client (e.g UaExpert) whose certificate is not on the server’s trust list.</p>
<div class="image">
<img src="clienttutorials_trust_server_certificate2.png" alt="clienttutorials_trust_server_certificate2.png"/>
</div>
<p>To trust the certificate only for the current session, click on the “Trust” button. To accept the certificate permanently, check the box next to “Save Certificate in TrustList”. When clicking the button “Reject”, the certificate is rejected and the client is not able to connect to the server. If the certificate is neither accepted nor trusted after a specified amount of time (indicated by a countdown next to the “Reject” button), it is rejected automatically.</p>
<h1><a class="anchor" id="L4ClientTutExample4Code"></a>
Sample Code</h1>
<h2><a class="anchor" id="L4ClientTutExample4Code_st01"></a>
Step 1: Provide a Handler for Untrusted Certificates</h2>
<p>When the SDK receives an untrusted certificate, it will raise an UntrustedCertificate event. Applications can handle this event and decide whether the SDK should trust the certificate. The application can use this event to implement specialized logic for determining trust.</p>
<p>The arguments passed to this event allow the implementer to specify whether to permanently save the certificate in the trust list. If the certificate is rejected, it will be written to the rejected certificates store and can be reassessed at a later date.</p>
<div class="fragment"><div class="line">        <span class="keyword">public</span> <span class="keywordtype">void</span> Application_UntrustedCertificate(<span class="keywordtype">object</span> sender, UntrustedCertificateEventArgs e)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (InvokeRequired)</div>
<div class="line">            {</div>
<div class="line">                Invoke(<span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#aa7e1c3f589ad954cd627ceedf429b772">UntrustedCertificateEventHandler</a>(Application_UntrustedCertificate), sender, e);</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">try</span></div>
<div class="line">            {</div>
<div class="line">                TrustCertificateDialogSettings settings = <span class="keyword">new</span> TrustCertificateDialogSettings()</div>
<div class="line">                {</div>
<div class="line">                    <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a96d16e9a0ffe0e31ca0315c51a54adcfae498749f3c42246d50b15c81c101d988">Application</a> = e.Application,</div>
<div class="line">                    UntrustedCertificate = e.Certificate,</div>
<div class="line">                    Issuers = e.Issuers,</div>
<div class="line">                    ValidationError = e.ValidationError,</div>
<div class="line">                    SaveToTrustList = <span class="keyword">false</span></div>
<div class="line">                };</div>
<div class="line"></div>
<div class="line">                TrustCertificateDialog dialog = <span class="keyword">new</span> TrustCertificateDialog();</div>
<div class="line">                dialog.StartPosition = FormStartPosition.CenterParent;</div>
<div class="line">                e.Accept = dialog.ShowDialog(<span class="keyword">this</span>, settings, 30000);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (settings.SaveToTrustList)</div>
<div class="line">                {</div>
<div class="line">                    e.Persist = <span class="keyword">true</span>;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">catch</span> (Exception exception)</div>
<div class="line">            {</div>
<div class="line">                ExceptionDlg.ShowInnerException(this.Text, exception);</div>
<div class="line">            }</div>
<div class="line">        }</div>
</div><!-- fragment --><h2><a class="anchor" id="L4ClientTutExample4Code_st02"></a>
Step 2: Prompt the User to Trust the Certificate</h2>
<p>Application developers need to be careful with this event, because the client will not receive a reply until it returns. This sample implementation provides a timeout mechanism that causes an automatic rejection.</p>
<p>This event can also be called from any thread, so developers need to watch out for deadlocks with the UI thread. For example, if the UI thread is blocked waiting for a response from the SDK, then this event cannot be processed.</p>
<div class="fragment"><div class="line">        <span class="keyword">public</span> <span class="keywordtype">bool</span> ShowDialog(MainForm owner, TrustCertificateDialogSettings settings, <span class="keywordtype">int</span> timeout)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (settings == null)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="stringliteral">&quot;settings&quot;</span>);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (owner.InvokeRequired)</div>
<div class="line">            {</div>
<div class="line">                ManualResetEvent e = <span class="keyword">new</span> ManualResetEvent(<span class="keyword">false</span>);</div>
<div class="line">                <span class="keywordtype">bool</span>? result = owner.Invoke(<span class="keyword">new</span> ShowDialogEventHandler(ShowDialog), owner, settings, e) as <span class="keywordtype">bool</span>?;</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (!e.WaitOne(timeout))</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">return</span> (result != null) ? result.Value : <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            m_settings = settings;</div>
<div class="line">            m_parent = owner as MainForm;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (timeout != 0)</div>
<div class="line">            {</div>
<div class="line">                m_counter = timeout / 1000 + 1;</div>
<div class="line">                TimeoutTimer.Enabled = <span class="keyword">true</span>;</div>
<div class="line">                CountdownLabel.Visible = <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            InstructionsGB.Visible = <span class="keyword">false</span>;</div>
<div class="line">            WarningLabel.Visible = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (m_parent != null)</div>
<div class="line">            {</div>
<div class="line">                InstructionsLB.Text = m_parent.GetInstructions(GetType());</div>
<div class="line">                InstructionsGB.Visible = <span class="keyword">true</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (settings.ValidationError.IsBad())</div>
<div class="line">            {</div>
<div class="line">                WarningLabel.Text = <span class="stringliteral">&quot;This certificate is not trusted ({0}).\r\nPlease review and decide if you would like to trust it.&quot;</span>;</div>
<div class="line">                WarningLabel.Text = <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a27118326006d3829667a400ad23d5d98">String</a>.Format(WarningLabel.Text, settings.ValidationError);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            WarningLabel.Visible = settings.ValidationError.IsBad();</div>
<div class="line"></div>
<div class="line">            ICertificate certificate = settings.UntrustedCertificate;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (certificate != null)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#aca568789e46861c1d8f609a23cad30cba06933067aafd48425d67bcb01bba5cb6">Update</a>(certificate);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (base.ShowDialog(owner) != DialogResult.OK)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">        }</div>
</div><!-- fragment --></div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="L1ClientTutorials.html">Tutorials for Client development</a></li><li class="navelem"><a class="el" href="L2ClientTutExamples.html">Getting Started</a></li>
    <li class="footer">&copy; Unified Automation GmbH - All rights reserved.</li>
  </ul>
</div>
</body>
</html>
