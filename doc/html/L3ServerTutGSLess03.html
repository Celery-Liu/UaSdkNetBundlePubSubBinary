<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>.NET Based OPC UA Client/Server/PubSub SDK: Lesson 3: Connecting the Nodes to Real Time Data</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="header_inner_inner_bg2.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">.NET Based OPC UA Client/Server/PubSub SDK
   &#160;<span id="projectnumber">4.1.0.556</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('L3ServerTutGSLess03.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Events</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Lesson 3: Connecting the Nodes to Real Time Data </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="L4ServerTutGSLess03Intro"></a>
Introduction</h1>
<p>In the previous <a class="el" href="L3ServerTutGSLess02.html">Lesson 2: Extending the Address Space with Real World Data</a> we created a nice object oriented address space, but the data provided by this address space are only initial values. There is no connection to real time data implemented yet.</p>
<p>If the source of the real time data delivers data changes through an event based mechanism, the connection to the data source is very simple. The only thing that needs to be implemented is updating the value of the Variable node when a data change arrives for that variable. All the read and data monitoring is already handled by the SDK.</p>
<p>If the source of the real time data requires data polling, this lesson explains the steps necessary to implement read, monitoring and write access to device data.</p>
<p>The following figure shows the example communication interface used for polling access to the simulated device data.</p>
<div class="image">
<img src="serverlesson03_comm_interface_for_devices.png" alt="serverlesson03_comm_interface_for_devices.png"/>
<div class="caption">
Figure 3.1: Communication Interface for Devices</div></div>
<p> Methods of the UnderlyingSystem </p><dl>
<dt>GetBlocks </dt>
<dd>Number of available controllers and their configuration through BlockConfiguration and BlockProperty classes </dd>
</dl>
<p>Runtime Data </p><dl>
<dt>Read</dt>
<dd>Read block property </dd>
<dt>Write</dt>
<dd>Write block property </dd>
<dt>Start</dt>
<dd>Start controller </dd>
<dt>Stop</dt>
<dd>Stop controller </dd>
</dl>
<h1><a class="anchor" id="L4ServerTutGSLess03Step01"></a>
Integration of the Device Interface</h1>
<p>In a first step the example device interface including the device simulation must be added to the project.</p>
<p>Add system as a member of the class.</p>
<div class="fragment"><div class="line"><span class="preprocessor">        #region Private Fields</span></div>
<div class="line">        <span class="keyword">private</span> UnderlyingSystem m_system;</div>
<div class="line"><span class="preprocessor">        #endregion</span></div>
</div><!-- fragment --><p> Create the system in the constructor of the NodeManager</p>
<div class="fragment"><div class="line">        <span class="keyword">public</span> Lesson03NodeManager(ServerManager server) : base(server)</div>
<div class="line">        {</div>
<div class="line">            m_system = <span class="keyword">new</span> UnderlyingSystem();</div>
<div class="line">        }</div>
</div><!-- fragment --> <p>Initialize the underlying system</p>
<p><div class="fragment"><div class="line">        <span class="keyword">public</span> <span class="keyword">override</span> <span class="keywordtype">void</span> Startup()</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">try</span></div>
<div class="line">            {</div>
</div><!-- fragment --> </p><div class="fragment"><div class="line">...</div>
</div><!-- fragment --><p> <div class="fragment"><div class="line">                <span class="comment">// load the model.</span></div>
<div class="line">                Console.WriteLine(<span class="stringliteral">&quot;Loading the Controller Model.&quot;</span>);</div>
<div class="line">                ImportUaNodeset(Assembly.GetEntryAssembly(), <span class="stringliteral">&quot;buildingautomation.xml&quot;</span>);</div>
<div class="line"></div>
<div class="line">                <span class="comment">// initialize the underlying system.</span></div>
<div class="line">                m_system.Initialize();</div>
</div><!-- fragment --></p>
<h1><a class="anchor" id="L4ServerTutGSLess03Step02"></a>
Creation of Controller Instances from Device Interface Information</h1>
<p>In <a class="el" href="L4ServerTutGSLess02Step07.html#code_HardcodedObjectGeneration">the previous lesson</a> a fixed set of controllers has been created. This hardcoded object generation will be replaced with information about available controllers provided by the device interface.</p>
<p><div class="fragment"><div class="line">                <span class="comment">// Create a Folder for Controllers</span></div>
</div><!-- fragment --> </p><div class="fragment"><div class="line">...</div>
</div><!-- fragment --><p> <div class="fragment"><div class="line">                <span class="comment">// Create controllers from configuration</span></div>
<div class="line">                <span class="keywordflow">foreach</span> (BlockConfiguration block <span class="keywordflow">in</span> m_system.GetBlocks())</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// set type definition NodeId</span></div>
<div class="line">                    <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a> typeDefinitionId = ObjectTypeIds.BaseObjectType;</div>
<div class="line">                    <span class="keywordflow">if</span> (block.Type == BlockType.AirConditioner)</div>
<div class="line">                    {</div>
<div class="line">                        typeDefinitionId = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>(yourorganisation.BA.ObjectTypes.AirConditionerControllerType, TypeNamespaceIndex);</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (block.Type == BlockType.Furnace)</div>
<div class="line">                    {</div>
<div class="line">                        typeDefinitionId = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>(yourorganisation.BA.ObjectTypes.FurnaceControllerType, TypeNamespaceIndex);</div>
<div class="line">                    }</div>
<div class="line"></div>
<div class="line">                    <span class="comment">// create object.</span></div>
<div class="line">                    settings = <span class="keyword">new</span> CreateObjectSettings()</div>
<div class="line">                    {</div>
<div class="line">                        ParentNodeId = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>(<span class="stringliteral">&quot;Controllers&quot;</span>, InstanceNamespaceIndex),</div>
<div class="line">                        <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a9bafec980b0e46918f646fa8019b577ba738520b2dcbb7dbb2c8d33096387aef8">ReferenceTypeId</a> = ReferenceTypeIds.Organizes,</div>
<div class="line">                        RequestedNodeId = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>(block.Name, InstanceNamespaceIndex),</div>
<div class="line">                        <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a9bafec980b0e46918f646fa8019b577ba50eebb9e969077ded08eed61ad9a5f0a">BrowseName</a> = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328ab4a75c1b2cfd3cb752898835cad346b0">QualifiedName</a>(block.Name, TypeNamespaceIndex),</div>
<div class="line">                        TypeDefinitionId = typeDefinitionId</div>
<div class="line">                    };</div>
<div class="line"></div>
<div class="line">                    CreateObject(<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a4ee1c62aa1346abfd54798f6d167a766a9aa1b03934893d7134a660af4204f2a9">Server</a>.DefaultRequestContext, settings);</div>
</div><!-- fragment --></p>
<div class="image">
<img src="serverlesson03_address_space.png" alt="serverlesson03_address_space.png"/>
<div class="caption">
Figure 3.2: Result in the server’s address space</div></div>
<h1><a class="anchor" id="L4ServerTutGSLess03Step03"></a>
Connect Variable Value Attribute to Real Time Data</h1>
<p>Our lesson specific NodeManager is derived from <a class="el" href="classUnifiedAutomation_1_1UaServer_1_1BaseNodeManager.html">BaseNodeManager</a> class. The project specific information integration is done by overwriting methods of the base class. Startup is overwritten to create the address space. For polling based data integration, we need to overwrite the methods Read and Write.</p>
<div class="image">
<img src="serverlesson03_iomanager.png" alt="serverlesson03_iomanager.png"/>
<div class="caption">
Figure 3.3</div></div>
<p> The value attribute of a variable node can be provided in different ways based on the source of the value. The source can be the in memory node like for server configuration data or it could be in an external device.</p>
<p>Depending on the type of source and communication, different modes can be configured for the variable. For Var1 the mode NodeHandleType.Internal would be used. For Var2 the mode NodeHandleType.ExternalPush would be used. Var3 matches our example and mode NodeHandleType.ExternalPolled is used. The different modes are described in the overview for <a class="el" href="L2ServerSdkServerManBaseNodeMan.html#L3ServerSdkServerManBaseNodeManDataAccessEtc">Data Access, Handle Types and the IIOManager</a>.</p>
<div class="image">
<img src="serverlesson03_var_value_handling.png" alt="serverlesson03_var_value_handling.png"/>
<div class="caption">
Figure 3.4</div></div>
<p> In the next steps we need to change variable value handling setting to NodeHandleType.ExternalPolled and we need to provide the address information in variable user data.</p>
<p>In addition, we need to implement Read and Write in the Lesson NodeManager. Read and Write are defined by BaseNodeManager and are overwritten in the Lesson NodeManager.</p>
<p>In a first step, we define the data class for variable user data in the Lesson NodeManager. The Address is used to address the controller. The Offset is used to address the variable inside the controller.</p>
<p><div class="fragment"><div class="line"><span class="preprocessor">        #region SystemAddress Class</span></div>
<div class="line">        <span class="keyword">private</span> <span class="keyword">class </span>SystemAddress</div>
<div class="line">        {</div>
<div class="line">            <span class="keyword">public</span> <span class="keywordtype">int</span> Address;</div>
<div class="line">            <span class="keyword">public</span> <span class="keywordtype">int</span> Offset;</div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">        #endregion</span></div>
</div><!-- fragment --></p>
<p>After the variables have been created (the children of the controllers are created together with the object), we need to set the NodeHandleType to ExternalPolled. The method <a class="el" href="classUnifiedAutomation_1_1UaServer_1_1BaseNodeManager.html#aa4823360c9834bbe65db31dd932b544b">SetVariableConfiguration</a> finds the variable node by using the NodeId of the controller and the BrowseName of the child, and sets the NodeHandleType and UserData (in this example system address in the UnderlyingSystem) that can be used for Read and Write.</p>
 <div class="fragment"><div class="line">                    <span class="comment">// create object.</span></div>
<div class="line">                    settings = <span class="keyword">new</span> CreateObjectSettings()</div>
<div class="line">                    {</div>
<div class="line">                        ParentNodeId = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>(<span class="stringliteral">&quot;Controllers&quot;</span>, InstanceNamespaceIndex),</div>
<div class="line">                        <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a9bafec980b0e46918f646fa8019b577ba738520b2dcbb7dbb2c8d33096387aef8">ReferenceTypeId</a> = ReferenceTypeIds.Organizes,</div>
<div class="line">                        RequestedNodeId = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>(block.Name, InstanceNamespaceIndex),</div>
<div class="line">                        <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a9bafec980b0e46918f646fa8019b577ba50eebb9e969077ded08eed61ad9a5f0a">BrowseName</a> = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328ab4a75c1b2cfd3cb752898835cad346b0">QualifiedName</a>(block.Name, TypeNamespaceIndex),</div>
<div class="line">                        TypeDefinitionId = typeDefinitionId</div>
<div class="line">                    };</div>
<div class="line"></div>
<div class="line">                    CreateObject(<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a4ee1c62aa1346abfd54798f6d167a766a9aa1b03934893d7134a660af4204f2a9">Server</a>.DefaultRequestContext, settings);</div>
<div class="line"></div>
<div class="line">                    <span class="comment">// Set NodeHandleType to ExternalPolled</span></div>
<div class="line">                    <span class="keywordflow">foreach</span> (BlockProperty property <span class="keywordflow">in</span> block.Properties)</div>
<div class="line">                    {</div>
<div class="line">                        <span class="comment">// the node was already created when the controller object was instantiated.</span></div>
<div class="line">                        <span class="comment">// this call links the node to the underlying system data.</span></div>
<div class="line">                        VariableNode variable = SetVariableConfiguration(</div>
<div class="line">                            <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>(block.Name, InstanceNamespaceIndex),</div>
<div class="line">                            <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328ab4a75c1b2cfd3cb752898835cad346b0">QualifiedName</a>(property.Name, TypeNamespaceIndex),</div>
<div class="line">                            NodeHandleType.ExternalPolled,</div>
<div class="line">                            <span class="keyword">new</span> SystemAddress() { Address = block.Address, Offset = <span class="keyword">property</span>.Offset });</div>
</div><!-- fragment --></p>
<p>For polling the variables of the UnderlyingSystem, we have to override the Read method in the NodeManager. The SystemAddress from the last step is added to the NodeHandle and can be used for reading the variables of the UnderlyingSystem. The values have to be added to DataValues and returned to the caller using the callback that is passed by the transaction.</p>
<div class="fragment"><div class="line">        <span class="keyword">protected</span> <span class="keyword">override</span> <span class="keywordtype">void</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a769000a8da22e528a1830197cf1bcd3ca7a1a5f3e79fdc91edf2f5ead9d66abb4">Read</a>(</div>
<div class="line">            RequestContext context,</div>
<div class="line">            TransactionHandle transaction,</div>
<div class="line">            IList&lt;NodeAttributeOperationHandle&gt; operationHandles,</div>
<div class="line">            IList&lt;ReadValueId&gt; settings)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii = 0; ii &lt; operationHandles.Count; ii++)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328ac7859cb58bee902dc86f1742665ff96f">DataValue</a> dv = null;</div>
<div class="line"></div>
<div class="line">                <span class="comment">// the data passed to CreateVariable is returned as the UserData in the handle.</span></div>
<div class="line">                SystemAddress address = operationHandles[ii].NodeHandle.UserData as SystemAddress;</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (address != null)</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// read the data from the underlying system.</span></div>
<div class="line">                    <span class="keywordtype">object</span> value = m_system.Read(address.Address, address.Offset);</div>
<div class="line"></div>
<div class="line">                    <span class="keywordflow">if</span> (value != null)</div>
<div class="line">                    {</div>
<div class="line">                        dv = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328ac7859cb58bee902dc86f1742665ff96f">DataValue</a>(<span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a492f18b60811bf85ce118c0c6a1a5c4a">Variant</a>(value, null), <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a8cf10d2341ed01492506085688270c1e">DateTime</a>.UtcNow);</div>
<div class="line"></div>
<div class="line">                        <span class="comment">// apply any index range or encoding.</span></div>
<div class="line">                        <span class="keywordflow">if</span> (!<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a27118326006d3829667a400ad23d5d98">String</a>.IsNullOrEmpty(settings[ii].IndexRange) || !<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328ab4a75c1b2cfd3cb752898835cad346b0">QualifiedName</a>.IsNull(settings[ii].DataEncoding))</div>
<div class="line">                        {</div>
<div class="line">                            dv = ApplyIndexRangeAndEncoding(</div>
<div class="line">                                operationHandles[ii].NodeHandle,</div>
<div class="line">                                dv,</div>
<div class="line">                                settings[ii].IndexRange,</div>
<div class="line">                                settings[ii].DataEncoding);</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="comment">// set an error if not found.</span></div>
<div class="line">                <span class="keywordflow">if</span> (dv == null)</div>
<div class="line">                {</div>
<div class="line">                    dv = <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328ac7859cb58bee902dc86f1742665ff96f">DataValue</a>(<span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a72381d4605940627a6e846d5f3155c51">StatusCode</a>(StatusCodes.BadNodeIdUnknown));</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="comment">// return the data to the caller.</span></div>
<div class="line">                ((<a class="code" href="namespaceUnifiedAutomation_1_1UaServer.html#add4c08a10b3e167349e94007924d24a0">ReadCompleteEventHandler</a>)transaction.Callback)(</div>
<div class="line">                    operationHandles[ii],</div>
<div class="line">                    transaction.CallbackData,</div>
<div class="line">                    dv,</div>
<div class="line">                    <span class="keyword">false</span>);</div>
<div class="line">            }</div>
<div class="line">        }</div>
</div><!-- fragment --><p> Writing a value to the UnderlyingSystem is very similar to reading values from the UnderlyingSystem.</p>
<div class="fragment"><div class="line">        <span class="keyword">protected</span> <span class="keyword">override</span> <span class="keywordtype">void</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a769000a8da22e528a1830197cf1bcd3ca1129c0e4d43f2d121652a7302712cff6">Write</a>(</div>
<div class="line">            RequestContext context,</div>
<div class="line">            TransactionHandle transaction,</div>
<div class="line">            IList&lt;NodeAttributeOperationHandle&gt; operationHandles,</div>
<div class="line">            IList&lt;WriteValue&gt; settings)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii = 0; ii &lt; operationHandles.Count; ii++)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a72381d4605940627a6e846d5f3155c51">StatusCode</a> error = StatusCodes.Good;</div>
<div class="line"></div>
<div class="line">                <span class="comment">// the data passed to CreateVariable is returned as the UserData in the handle.</span></div>
<div class="line">                SystemAddress address = operationHandles[ii].NodeHandle.UserData as SystemAddress;</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (address != null)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">if</span> (!<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a27118326006d3829667a400ad23d5d98">String</a>.IsNullOrEmpty(settings[ii].IndexRange))</div>
<div class="line">                    {</div>
<div class="line">                        error = StatusCodes.BadIndexRangeInvalid;</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!m_system.Write(address.Address, address.Offset, settings[ii].Value.Value))</div>
<div class="line">                    {</div>
<div class="line">                        error = StatusCodes.BadUserAccessDenied;</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    error = StatusCodes.BadNodeIdUnknown;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="comment">// return the data to the caller.</span></div>
<div class="line">                ((<a class="code" href="namespaceUnifiedAutomation_1_1UaServer.html#a1b6f1c5540fa5c153e20063cb7320dcf">WriteCompleteEventHandler</a>)transaction.Callback)(</div>
<div class="line">                    operationHandles[ii],</div>
<div class="line">                    transaction.CallbackData,</div>
<div class="line">                    error,</div>
<div class="line">                    <span class="keyword">false</span>);</div>
<div class="line">            }</div>
<div class="line">        }</div>
</div><!-- fragment --><p> Now, the variable Temperature gets its value from the device. We can test this in UaExpert: Drag &amp; drop the variables of a controller to the Data Access View. The Variable value provided by the Read method is shown in the <em>Value</em> column.</p>
<div class="image">
<img src="serverlesson03_expert.png" alt="serverlesson03_expert.png"/>
<div class="caption">
Figure 3.5: Testing implementation in UaExpert</div></div>
<p> In a last step, we add information about the expected range of values for each variable. The <a class="el" href="Doc_OpcUa_DataAccess_VariableTypes.html#Doc_OpcUa_AnalogItemType">OPC UA AnalogItemType</a> contains a property called <a class="el" href="Doc_OpcUa_DataAccess_VariableTypes.html#Doc_OpcUa_AnalogItemType_EURange">EURange</a> that provides this information to clients. This property will not change during runtime, so external polling of the range is not needed. We only need to update the value of the in-memory-node.</p>
<div class="fragment"><div class="line">                    <span class="comment">// Set NodeHandleType to ExternalPolled</span></div>
<div class="line">                    <span class="keywordflow">foreach</span> (BlockProperty property <span class="keywordflow">in</span> block.Properties)</div>
<div class="line">                    {</div>
<div class="line">                        <span class="comment">// the node was already created when the controller object was instantiated.</span></div>
<div class="line">                        <span class="comment">// this call links the node to the underlying system data.</span></div>
<div class="line">                        VariableNode variable = SetVariableConfiguration(</div>
<div class="line">                            <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a4b5bd8a54893c87287a22228b5ef2bc8">NodeId</a>(block.Name, InstanceNamespaceIndex),</div>
<div class="line">                            <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328ab4a75c1b2cfd3cb752898835cad346b0">QualifiedName</a>(property.Name, TypeNamespaceIndex),</div>
<div class="line">                            NodeHandleType.ExternalPolled,</div>
<div class="line">                            <span class="keyword">new</span> SystemAddress() { Address = block.Address, Offset = <span class="keyword">property</span>.Offset });</div>
<div class="line"></div>
<div class="line">                        <span class="comment">// Add information about expected range</span></div>
<div class="line">                        <span class="keywordflow">if</span> (variable != null)</div>
<div class="line">                        {</div>
<div class="line">                            <span class="comment">// in-memory nodes must be locked before updates.</span></div>
<div class="line">                            <span class="comment">// reads do not require locks for simple types and references.</span></div>
<div class="line">                            <span class="comment">// value reads require a lock.</span></div>
<div class="line">                            lock (InMemoryNodeLock)</div>
<div class="line">                            {</div>
<div class="line">                                variable.AccessLevel = (<span class="keyword">property</span>.Writeable) ? AccessLevels.CurrentReadOrWrite : AccessLevels.CurrentRead;</div>
<div class="line">                            }</div>
<div class="line"></div>
<div class="line">                            <span class="keywordflow">if</span> (property.Range != null)</div>
<div class="line">                            {</div>
<div class="line">                                SetVariableDefaultValue(</div>
<div class="line">                                    variable.NodeId,</div>
<div class="line">                                    <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328ab4a75c1b2cfd3cb752898835cad346b0">QualifiedName</a>(BrowseNames.EURange),</div>
<div class="line">                                    <span class="keyword">new</span> <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a5c65b5d5d05c3f82bdeef88928d74328a492f18b60811bf85ce118c0c6a1a5c4a">Variant</a>(property.Range));</div>
<div class="line">                            }</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
</div><!-- fragment --></div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="L1ServerTutorials.html">Tutorials for Server development</a></li><li class="navelem"><a class="el" href="L2ServerTutGettingStarted.html">Getting Started</a></li>
    <li class="footer">&copy; Unified Automation GmbH - All rights reserved.</li>
  </ul>
</div>
</body>
</html>
