<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>.NET Based OPC UA Client/Server/PubSub SDK: Collections and dynamic object creation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="header_inner_inner_bg2.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">.NET Based OPC UA Client/Server/PubSub SDK
   &#160;<span id="projectnumber">4.1.0.556</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('L3ServerTuMachineDemoServerCollections.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Events</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Collections and dynamic object creation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#L4ServerTuMachineDemoServerCollectionsAutoNodeVersion">Auto NodeVersion</a></li>
</ul>
</div>
<div class="textblock"><p>So far, all examples have dealt with static NodeSets that were previously created with UaModeler. But in some cases, objects or variables need to be created dynamically, in particular for collections. That can be order lists or like in this example the list of current jobs. In OPC UA, those lists may be of the type <em>OrderedListType</em>. The SDK does not provide a default implementation for the <em>OrderedListModel</em>. Fortunately, it is not difficult to write it by hand.</p>
<p>Those collection types must implement at least the <em>INotifyCollectionChanged</em> interface, but it is advisable to also implement the <em>IEnumerable</em> interface. Than a model can have a non-empty collection on model activation.</p>
<div class="fragment"><div class="line">    <span class="keyword">public</span> <span class="keyword">partial class </span>ProductionPlanModel : INotifyCollectionChanged, IEnumerable&lt;ProductionJobModel&gt;</div>
<div class="line">    {</div>
</div><!-- fragment --><div class="fragment"><div class="line">        <span class="keyword">public</span> <span class="keyword">event</span> NotifyCollectionChangedEventHandler CollectionChanged;</div>
</div><!-- fragment --><p> When now a new job is added to the production plan, it will be stored in the internal job list and a CollectionChanged event is raised. This event will be observed by the <em>BindModel</em> mechanism, the nodes for this object will be created and added to the parent node. Finally, an OPC UA <em>GeneralModelChangeEventType</em> event will be emitted to inform the clients that the model has changed.</p>
<div class="fragment"><div class="line">        <span class="keyword">public</span> <span class="keywordtype">void</span> Add(ProductionJobModel item)</div>
<div class="line">        {</div>
<div class="line">            m_jobs.Add(item);</div>
<div class="line">            Version++;</div>
<div class="line">            CollectionChanged?.Invoke(<span class="keyword">this</span>, <span class="keyword">new</span> NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Add, item));</div>
<div class="line"></div>
<div class="line">            item.NumberInList = ushort.MaxValue;</div>
<div class="line">            item.State.SwitchToState(ProductionStateMachineModel.State.Initializing);</div>
<div class="line">            ReorderList();</div>
<div class="line">        }</div>
</div><!-- fragment --><p> The precise settings for the creation are not coming from the model but from the delegate passed to <em>BindModel</em>. There, the reference type, the browse name and children settings can be defined. The node manager will set the proper <em>ParentNodeId</em> and <em>TypeDefinitionId</em>. The delegate has a return type of <a class="el" href="classUnifiedAutomation_1_1UaServer_1_1CreateInstanceSettings.html">CreateInstanceSettings</a>, however, only settings of the subtype <a class="el" href="classUnifiedAutomation_1_1UaServer_1_1CreateObjectSettings.html">CreateObjectSettings</a> or <a class="el" href="classUnifiedAutomation_1_1UaServer_1_1CreateVariableSettings.html">CreateVariableSettings</a> are support.</p>
<div class="fragment"><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> CreateInstanceSettings CreateInstanceSettingsFor(<span class="keywordtype">object</span> obj)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">switch</span> (obj)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">case</span> ProcessingJobModel job:</div>
<div class="line">                    <span class="keywordflow">return</span> <span class="keyword">new</span> CreateObjectSettings()</div>
<div class="line">                    {</div>
<div class="line">                        <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a9bafec980b0e46918f646fa8019b577ba738520b2dcbb7dbb2c8d33096387aef8">ReferenceTypeId</a> = UaBase.ReferenceTypeIds.HasOrderedComponent,</div>
<div class="line">                        <a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a9bafec980b0e46918f646fa8019b577ba50eebb9e969077ded08eed61ad9a5f0a">BrowseName</a> = (<span class="keyword">new</span> AbsoluteName(job.Identifier, Namespaces.MachineDemoServer)).ToQualifiedName(<a class="code" href="namespaceUnifiedAutomation_1_1UaBase.html#a4ee1c62aa1346abfd54798f6d167a766a9aa1b03934893d7134a660af4204f2a9">Server</a>.NamespaceUris),</div>
<div class="line">                        <span class="comment">// With the children settings, the type definition id and some</span></div>
<div class="line">                        <span class="comment">// attributes can be specified. If child settings exist for</span></div>
<div class="line">                        <span class="comment">// an optional child, the child will be instantiated.</span></div>
<div class="line">                        ChildrenSettings =</div>
<div class="line">                        {</div>
<div class="line">                            <span class="keyword">new</span> ChildInstanceSettings()</div>
<div class="line">                            {</div>
<div class="line">                                BrowsePath = { <a class="code" href="namespaceOpcUa.html">OpcUa</a>.Glass.AbsoluteNames.Name }</div>
<div class="line">                            },</div>
<div class="line">                            <span class="keyword">new</span> ChildInstanceSettings()</div>
<div class="line">                            {</div>
<div class="line">                                BrowsePath = { <a class="code" href="namespaceOpcUa.html">OpcUa</a>.Glass.AbsoluteNames.QueueJob }</div>
<div class="line">                            },</div>
<div class="line">                            <span class="keyword">new</span> ChildInstanceSettings()</div>
<div class="line">                            {</div>
<div class="line">                                BrowsePath = { <a class="code" href="namespaceOpcUa.html">OpcUa</a>.Glass.AbsoluteNames.ReleaseJob }</div>
<div class="line">                            },</div>
<div class="line">                        }</div>
<div class="line">                    };</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">default</span>:</div>
<div class="line">                    <span class="keywordflow">return</span> <span class="keywordflow">default</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
</div><!-- fragment --><p> In this example we do not specify <em>RequestedNodeId</em>, hence the default mechanism will be used, that is a <em>Guid</em>-based <em>NodeId</em> will be generated. If a specific <em>NodeId</em> is desired, the <em>RequestedNodeId</em> can be set or the method <a class="el" href="classUnifiedAutomation_1_1UaServer_1_1BaseNodeManager.html#abf3f2c6b58e79017ae81bf1edd90f40c">CreateNodeId</a> of the <em>BaseNodeManager</em> can be overloaded.</p>
<p>There is a second way to inform the client about model changes and a server must mandatorily support both variants or none. The server needs to maintain a <a class="el" href="classUnifiedAutomation_1_1UaServer_1_1OrderedListModel.html#aa5f2a86e5d61e8968b2dacf357f9cd23">NodeVersion</a> property that changes, whenever an object was added or removed. In fact, the SDK will not raise a GeneralModelChangeEvent when the collection object does not posses a <em>NodeVersion</em> property. Here the internal Version <em>property</em> is copied onto the <em>NodeVersion</em> property, whenever the <em>Version</em> changes.</p>
<div class="fragment"><div class="line">        <span class="keyword">public</span> ProductionPlanModel(ProductionPlanModel <span class="keyword">template</span>) : this(template, default(DummyArgument))</div>
<div class="line">        {</div>
<div class="line">            PropertyChanged += (o, e) =&gt;</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">switch</span> (e.PropertyName)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">case</span> nameof(Version):</div>
<div class="line">                        NodeVersion = Version.ToString();</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">            };</div>
<div class="line"></div>
<div class="line">            Version++;</div>
<div class="line">        }</div>
</div><!-- fragment --><p> Per default, the default values stored in NodeSet are used as the start values of the model. So it is necessary to prevent <em>BindModel</em> to override the <em>NodeVersion</em> property on model activation. This can be achieved with a static <em>ModelAnnotator</em>. When the model gets bind to the nodeset, the node manager will first look for a static property named <em>ModelAnnotator</em> of the type <a class="el" href="classUnifiedAutomation_1_1UaServer_1_1ModelAnnotator.html">ModelAnnotator</a>. If it finds one, it will respect the override settings there.</p>
<div class="fragment"><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> ModelAnnotator ModelAnnotator</div>
<div class="line">        {</div>
<div class="line">            <span class="keyword">get</span></div>
<div class="line">            {</div>
<div class="line">                var annotator = <span class="keyword">new</span> ModelAnnotator();</div>
<div class="line">                annotator.Instance(nameof(NodeVersion))</div>
<div class="line">                    .HasInitMode(<a class="code" href="namespaceUnifiedAutomation_1_1UaServer.html#aa12b3474e00849d352db1626c73547e8">InitMode</a>.FromModelToNode);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">return</span> annotator;</div>
<div class="line">            }</div>
<div class="line">        }</div>
</div><!-- fragment --> <h1><a class="anchor" id="L4ServerTuMachineDemoServerCollectionsAutoNodeVersion"></a>
Auto NodeVersion</h1>
<p>The <em>BindModel</em> mechanism does intentionally not manage the <em>NodeVersion</em> property by default, because there are cases, for example when adding references, where the <em>NodeVersion</em> needs to signal a change. Mostly, the addition of a child object is the only change that will happen to an object. The SDK offers the <a class="el" href="classUnifiedAutomation_1_1UaBase_1_1UaAutoNodeVersionAttribute.html">UaAutoNodeVersion attribute</a> for this. The <em>BindModel</em> mechanism will maintain the <em>NodeVersion</em> property value for a model class decorated with this attribute. If the property does not already exists a new node will be created. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="L1ServerTutorials.html">Tutorials for Server development</a></li><li class="navelem"><a class="el" href="L2ServerTutMachineDemoServer.html">Machine Demo Server</a></li>
    <li class="footer">&copy; Unified Automation GmbH - All rights reserved.</li>
  </ul>
</div>
</body>
</html>
