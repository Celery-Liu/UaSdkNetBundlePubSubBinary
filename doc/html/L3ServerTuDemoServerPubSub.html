<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>.NET Based OPC UA Client/Server/PubSub SDK: PubSub support</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="header_inner_inner_bg2.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">.NET Based OPC UA Client/Server/PubSub SDK
   &#160;<span id="projectnumber">4.1.0.556</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('L3ServerTuDemoServerPubSub.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Events</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">PubSub support </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#DemoServerPubSubCode">Code additions</a></li>
<li class="level1"><a href="#DemoServerPubSubConfiguration">Configuration file additions</a></li>
<li class="level1"><a href="#DemoServerPubSubExplore">Testing with the UA Expert</a></li>
</ul>
</div>
<div class="textblock"><p>The OPC UA specification for PubSub defines not only how messages are encoded and transported to the subscriber, but also how to represent the pub-sub setup and its diagnostic values in the address space. There is a common configuration interface to configure the pub-sub settings. That allows a generic client to configure the pub-sub-abilities of any server that supports this configuration interface. So does the .NET Server SDK.</p>
<p>In the following, we will take a walk through to additions that needs to be done to the source code and to the configuration file, to enable pub-sub for .NET servers. To support the broker access with UserName/Password, it is also advisable to activate KeyCredential support in the server. For this, please see the next section <a class="el" href="L3ServerTuDemoServerKeyCredentials.html">KeyCredential support</a>.</p>
<h1><a class="anchor" id="DemoServerPubSubCode"></a>
Code additions</h1>
<p>Between the creation of the <code>ApplicationInstanceBase</code> and the <code>Start()</code> of it, the <a class="el" href="classUnifiedAutomation_1_1UaBase_1_1ApplicationInstanceBase.html#a070c843f0880b01062dc652dbbdd5bc0">PubSubConnectionProvider</a> property needs to be assigned, as shown in the following:</p>
<div class="fragment"><div class="line">                application.PubSubConnectionProvider = <span class="keyword">new</span> PubSubConnectionProvider()</div>
<div class="line">                    .AddMqttJsonProfile()</div>
<div class="line">                    .AddMqttUadpProfile();</div>
<div class="line"></div>
</div><!-- fragment --><p> Once the <code>PubSubConnectionProvider</code> is set and the license is applicable for PubSub the <em>PublishSubscribe</em> object will appear in the <em>Server</em> object hierarchy.</p>
<dl class="section note"><dt>Note</dt><dd>The license must be explicitly contain the UA PubSub SDK. If you do not have a valid license but want to test the PubSub functionality, you can either use the trial license from the EVAL package or temporarily remove your existing license from your project.</dd></dl>
<div class="image">
<img src="demoserver_pubsub_publishsubscribe.png" alt="demoserver_pubsub_publishsubscribe.png"/>
<div class="caption">
Browse PublishSubscribe</div></div>
<p> For UADP encoded message end-to-end encryption is supported. There are several ways to receive the security keys needed for the symmetric encryption. One of them is that the PubSub application pulls the keys from a central SecurityKeyServices server. A client connection to the server is established for this purpose, hence the implementation is located in the UaClient library.</p>
<div class="fragment"><div class="line">                application.SecurityGroupProviderService = <span class="keyword">new</span> UaClient.RemoteSecurityGroupProviderService();</div>
</div><!-- fragment --><p> Obviously, the application therefore not only requires a PackageReference to the UaServer but also to the UaClient nuget package.</p>
<h1><a class="anchor" id="DemoServerPubSubConfiguration"></a>
Configuration file additions</h1>
<p>The PubSub configuration can be changed at runtime by using the common configuration interface. The SDK will persist any successful change to the configuration on disk, so it can be restored after a restart of the server application. The file path needs to be set in in the applications Server configuration.</p>
<p>The configuration file will be set in the ServerSettings like this:</p>
<div class="fragment"><div class="line">&lt;Extension&gt;</div>
<div class="line">  &lt;ServerSettings&gt;</div>
<div class="line">    &lt;!--</div>
<div class="line">        ...</div>
<div class="line">    --&gt;</div>
<div class="line">    &lt;PublishSubscribe&gt;</div>
<div class="line">      &lt;ConfigurationFile&gt;%CommonApplicationData%\unifiedautomation\UaSdkNet\Configuration\pubsub.uabinary&lt;/ConfigurationFile&gt;</div>
<div class="line">    &lt;/PublishSubscribe&gt;</div>
<div class="line">  &lt;/ServerSettings&gt;</div>
<div class="line">&lt;/Extension&gt;</div>
</div><!-- fragment --><h1><a class="anchor" id="DemoServerPubSubExplore"></a>
Testing with the UA Expert</h1>
<p>In the following we will configure a MQTT-JSON PubSub connection with the UA Expert. The connection will have one writer<sup><a class="el" href="L3ServerTuDemoServerPubSub.html#writer_is_not_writergroup">1</a></sup> publishing to a MQTT broker and one reader that subscribes to the DataSetMessages published by the writer. A running broker (for example <a href="https://mosquitto.org/download/">mosquitto</a>) is need. The UA Expert needs to be connected to the Demo Server with an user identity that has the role <em>ConfigureAdmin</em>. In the UaDemoServer this is the user <em>john</em> with password <em>master</em>. The UA Expert needs to be in version 1.7.1 or later.</p>
<p>Next, open the PubSub Config View. With this view one can configure several applications with different transport and messaging protocols.</p>
<div class="image">
<img src="demoserver_pubsub_pubsubconfigurationview.png" alt="demoserver_pubsub_pubsubconfigurationview.png"/>
<div class="caption">
Open PubSub Config View</div></div>
<p> After adding a new broker, we first have to set the URI of the broker. In this example it is <code>mqtt://localhost:1883</code>, because the mosquitto is running on the same machine on the MQTT standard port. Than the Demo Server is added to the broker. <em>Before</em> any element like writer or reader is added to the connection, the transport facet has to be changed to "MQTT / JSON" in the connection settings. For JSON encoding, the publisher ID is usually a string, here "UaServerNet". But an integer would also be okay.</p>
<div class="image">
<img src="demoserver_pubsub_connection.png" alt="demoserver_pubsub_connection.png"/>
<div class="caption">
Add connection</div></div>
<p> Next, we add a DataSetWriter with the name "Writer_1" and change its configuration, so that the <em>MessageType</em> and the <em>ReversibleFieldEncoding</em> flags are set on the DataSetMessageContentMask. In particular the latter is important, since it is not supported to decode non-reversible encoded DataSetMessages. Furthermore, <em>Temperature</em> variable of the temperature sensor in the boiler demo, is added.</p>
<div class="image">
<img src="demoserver_pubsub_writer.png" alt="demoserver_pubsub_writer.png"/>
<div class="caption">
Add Writer</div></div>
<p> When adding a reader, the expert will take most of the configuration from the selected writer. In this example there is only the "Writer_1" in the list to choose from. We use the DataSet Mirror mode. The server will create reader-local variables that store the last received values. So it is not need to create variables in advance.</p>
<div class="image">
<img src="demoserver_pubsub_reader.png" alt="demoserver_pubsub_reader.png"/>
<div class="caption">
Add Reader</div></div>
<p> Now, that the configuration is prepared it needs to be downloaded to the demo server. Go to the configuration folder and click the download button. Since all pub-sub elements are set to be active by default, the publisher will immediately start to send messages to the broker and the reader is receiving them again from the broker.</p>
<div class="image">
<img src="demoserver_pubsub_download.png" alt="demoserver_pubsub_download.png"/>
<div class="caption">
Download configuration</div></div>
<p> To see and confirm that the publishing and subscribing really works, add the setpoint of the boiler, the published, actual <em>Temperature</em> of the boiler and the mirror variable to the data access view. Changing the setpoint to let's say 150, will cause the boiler's temperature and the mirror temperature to increase. Passing the temperature value from the temperature variable to the broker via the mirror variable indirection will of course add some latency as can be seen in the small time delay, between those two variables.</p>
<div class="image">
<img src="demoserver_pubsub_dataaccessview.png" alt="demoserver_pubsub_dataaccessview.png"/>
<div class="caption">
Data Access View</div></div>
<hr/>
<p> <small> <a class="anchor" id="writer_is_not_writergroup"></a> <sup><a class="el" href="L3ServerTuDemoServerPubSub.html#writer_is_not_writergroup">1</a></sup> Actually, it is the writer group containing the writer, that publishes the network messages on the broker. </small> </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="L1ServerTutorials.html">Tutorials for Server development</a></li><li class="navelem"><a class="el" href="L2ServerTutDemoServer.html">.NET SDK Demo Server</a></li>
    <li class="footer">&copy; Unified Automation GmbH - All rights reserved.</li>
  </ul>
</div>
</body>
</html>
